---
# 文章标题
title: "CI/CD with Drone Kubernetes and Gogs"
# 文章副标题
subtitle: "CI/CD with Drone Kubernetes and Gogs"
# 文章创建的日期时间
date: 2020-07-29
# 文章最后修改的日期时间
lastmod: 2020-07-29
# 文章作者
author: "小炒肉"
# 文章所属的类别
categories:
    - kubernetes
    - docker
    - devops
# 文章内容的描述
description: "CI/CD with Drone Kubernetes and Gogs"
# 是否设置为草稿, 如果为 true 则不会被 hugo 渲染成 HTML
draft: false
# 文章是否不显示在主页上
# hiddenFromHomePage: true
# 是否使用 twemoji 
twemoji: false
# 文章的标签
tags:
    - kubernetes
    - docker
    - devops
# 主页预览的文章特色图片.
featuredImagePreview: "/img/posts/drone/drone-k8s.png"

# 文章中的图片是否按照画廊形式呈现
lightgallery: false
---


# Drone

* Drone is a Container-Native, Continuous Delivery Platform。 我们可以理解为 Drone 是基于 容器原生的一个 持续集成、持续交付的平台。 

* 官方网站是 `https://drone.io/`

* Drone 支持的Git仓库有

  1. `GitHub`
  2. `GitLab`
  3. `Gogs`
  4. `Gitea`
  5. `Bitbucket Cloud`
  6. `Bitbucket Server`


## Mysql

* 对于 Drone 与 Gogs 都会使用到 Mysql

* 注: 无论如何并不建议在 容器化环境下 部署 数据层


---

* 部署 Mysql 的 Yaml 文件


* `Secret` 使用 `base64` 加密 (# echo -n "mysql"| base64 ) 


```shell
# mysql-namespaces.yaml

apiVersion: v1
kind: Namespace
metadata:
  name: database
```

---

```shell
# mysql-secret.yaml

apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
  namespace: database
data:
  root_pass: cmxkYkAxMjM=
```

---


```shell
# mysql-statefulset.yaml

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
  namespace: database
  labels:
    app: mysql
    service: database
spec:
  serviceName: mysql
  replicas: 1
  selector:
    matchLabels:
      app: mysql
      service: database
  template:
    metadata:
      labels:
        app: mysql
        service: database
    spec:
      terminationGracePeriodSeconds: 10
      containers:
      - name: mysql
        image: mysql:8
        args:
        - --character-set-server=utf8mb4
        - --collation-server=utf8mb4_unicode_ci
        ports:
        - name: http
          containerPort: 3306
        env:
         - name: MYSQL_ROOT_PASSWORD
           valueFrom:
             secretKeyRef:
               name: mysql-secret
               key: root_pass
        resources:
          requests:
            cpu: "0.01"
        volumeMounts:
        - name: mysql-data-storage
          mountPath: /var/lib/mysql
        - name: tz-config
          mountPath: /etc/localtime
          readOnly: true
      restartPolicy: Always
      volumes:
      - name: mysql-data-storage
        hostPath:
          path: /opt/mysql/data
          type: Directory
      - name: tz-config
        hostPath:
          path: /etc/localtime

---
apiVersion: v1
kind: Service
metadata:
  name: mysql
  namespace: database
  labels:
    app: mysql
    service: database
spec:
  ports:
  - name: http
    protocol: TCP
    port: 3306
    targetPort: 3306
  selector:
    app: mysql
    service: database
  type: ClusterIP
```


---

```shell
# 查看验证服务

[root@jicki mysql]# kubectl get pods,statefulset,svc -n database
NAME          READY   STATUS    RESTARTS   AGE
pod/mysql-0   1/1     Running   0          6m1s

NAME                     READY   AGE
statefulset.apps/mysql   1/1     6m1s

NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/mysql   ClusterIP   10.104.238.35   <none>        3306/TCP   6m1s

```



## Gogs

* Gogs 是一款 Go 语言开发轻量级的 Git 仓库, 是全完开源的。


### 部署 Gogs

* Gogs with Mysql to Kubernetes Deployment


* 在 WebUI 下初始化配置, 可能会遇到 `Error 1049: Unknown database 'gogs'` 需要在数据库先创建 用户 以及 数据库


* 相关 yaml 文件

```shell
# gogs-namespace.yaml

apiVersion: v1
kind: Namespace
metadata:
  name: git

```

---

```shell

# gogs-deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: gogs
  namespace: git
  labels:
    app: gogs
spec:
  selector:
    matchLabels:
      app: gogs
  template:
    metadata:
      labels:
        app: gogs
    spec:
      containers:
      - name: gogs
        image: gogs/gogs
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 3000
          name: gogs
        - containerPort: 22
          name: ssh
        resources:
          requests:
            cpu: "0.01"
        volumeMounts:
        - name: gogs-data-storage
          mountPath: /data
        - name: tz-config
          mountPath: /etc/localtime
          readOnly: true
      restartPolicy: Always
      volumes:
      - name: gogs-data-storage
        hostPath:
          path: /opt/gogs/data
          type: Directory
      - name: tz-config
        hostPath:
          path: /etc/localtime

---
apiVersion: v1
kind: Service
metadata:
  name: gogs
  namespace: git
spec:
  ports:
  - name: gogs
    protocol: TCP
    port: 3000
    targetPort: 3000
  selector:
    app: gogs

---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: gogs-ingress
  namespace: git
spec:
  rules:
  - host: gogs.jicki.cn
    http:
      paths:
      - backend:
          serviceName: gogs
          servicePort: 3000
```  



---


```shell
# 创建服务

[root@jicki gogs]# kubectl apply -f gogs-deployment.yaml
namespace/git created
deployment.apps/gogs created
service/gogs created
ingress.extensions/gogs-ingress created

```


---


* 初始化 gogs


{{< figure src="/img/posts/drone/drone-gogs.png" >}}


{{< figure src="/img/posts/drone/drone-gogs-1.png" >}}





## Drone-Server



```shell
# drone-namespace.yaml 

apiVersion: v1
kind: Namespace
metadata:
  name: drone
```


---

* 这里配置 `gogs_git_user` 需要单独在 gogs 里创建一个有所有组织权限的账户, 或者是管理员。


* `drone_agent_secret` 是用于 drone-agent 与 drone-server 进行通讯的 秘钥。

  * 使用 `openssl rand -hex 16` 进行生成。


```shell
# drone-configmap.yaml

apiVersion: v1
kind: ConfigMap
metadata:
  name: drone
  namespace: drone
data:
  docker_api_version: '1.40'
  gogs: 'true'
  gogs_private_mode: 'true'
  gogs_url: http://gogs.git.svc.cluster.local:3000
  drone_open: 'true'
  drone_db_driver: mysql
  drone_db_datasource: root:dronepass@tcp(mysql.database.svc.cluster.local:3306)/drone?parseTime=true
  gin_mode: release
  drone_server: ws://drone-server.drone.svc.cluster.local:8000/ws/broker
  remote_driver: gogs

```


---


```shell
# drone-server-statefulset.yaml

apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: drone-server
  namespace: drone
  labels:
    app: drone-server
    service: cicd
spec:
  serviceName: drone-server
  replicas: 1
  template:
    metadata:
      labels:
        app: drone-server
        service: cicd
    spec:
      terminationGracePeriodSeconds: 10
      containers:
      - name: drone-server
        image: drone/drone
        ports:
        - name: http
          containerPort: 8000
        #securityContext:
        #  capabilities: {}
        #  privileged: true
        env:
        # Drone-ConfigMap
        - name: DOCKER_API_VERSION
          valueFrom:
            configMapKeyRef:
              name: drone
              key: docker_api_version
        - name: DRONE_GOGS
          valueFrom:
            configMapKeyRef:
              name: drone
              key: gogs
        - name: DRONE_GOGS_PRIVATE_MODE
          valueFrom:
            configMapKeyRef:
              name: drone
              key: gogs_private_mode
        - name: DRONE_GOGS_URL
          valueFrom:
            configMapKeyRef:
              name: drone
              key: gogs_url
        - name: DRONE_OPEN
          valueFrom:
            configMapKeyRef:
              name: drone
              key: drone_open
        - name: DRONE_DATABASE_DRIVER
          valueFrom:
            configMapKeyRef:
              name: drone
              key: drone_db_driver
        - name: DRONE_DATABASE_DATASOURCE
          valueFrom:
            configMapKeyRef:
              name: drone
              key: drone_db_datasource
        - name: GIN_MODE
          valueFrom:
            configMapKeyRef:
              name: drone
              key: gin_mode
        volumeMounts:
        - name: drone-data-storage
          mountPath: /var/lib/drone
        - name: tz-config
          mountPath: /etc/localtime
          readOnly: true
      restartPolicy: Always
      volumes:
      - name: drone-data-storage
        hostPath:
          path: /opt/drone/data
          type: Directory
      - name: tz-config
        hostPath:
          path: /etc/localtime

---
apiVersion: v1
kind: Service
metadata:
  name: drone-server
  namespace: drone
  labels:
    app: drone-server
    service: cicd
spec:
  ports:
  - name: http
    protocol: TCP
    port: 8000
    targetPort: 8000
  selector:
    app: drone-server
    service: cicd

```
