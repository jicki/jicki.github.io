<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>prometheus monitoring - 小炒肉</title><meta name=Description content="prometheus monitoring"><meta property="og:title" content="prometheus monitoring"><meta property="og:description" content="prometheus monitoring"><meta property="og:type" content="article"><meta property="og:url" content="https://jicki.cn/prometheus-monitoring/"><meta property="og:image" content="https://jicki.cn/logo.png"><meta property="article:published_time" content="2018-02-01T00:00:00+00:00"><meta property="article:modified_time" content="2018-02-01T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jicki.cn/logo.png"><meta name=twitter:title content="prometheus monitoring"><meta name=twitter:description content="prometheus monitoring"><meta name=application-name content="小炒肉"><meta name=apple-mobile-web-app-title content="小炒肉"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/images/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://jicki.cn/prometheus-monitoring/><link rel=prev href=https://jicki.cn/kubernetes-1.9.1/><link rel=next href=https://jicki.cn/kubernetes-jenkins/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"prometheus monitoring","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/jicki.cn\/prometheus-monitoring\/"},"genre":"posts","wordcount":5397,"url":"https:\/\/jicki.cn\/prometheus-monitoring\/","datePublished":"2018-02-01T00:00:00+00:00","dateModified":"2018-02-01T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"小炒肉"},"description":"prometheus monitoring"}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=小炒肉>小炒肉</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=小炒肉>小炒肉</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/>文章</a><a class=menu-item href=/tags/>标签</a><a class=menu-item href=/categories/>分类</a><a class=menu-item href=/about/>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">prometheus monitoring</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://jicki.cn title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>小炒肉</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/kubernetes/><i class="far fa-folder fa-fw"></i>kubernetes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2018-02-01>2018-02-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 5397 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 11 分钟&nbsp;<span id=/prometheus-monitoring/ class=leancloud_visitors data-flag-title="prometheus monitoring">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#部署-prometheus>部署 Prometheus</a><ul><li><a href=#镜像下载>镜像下载</a></li><li><a href=#创建-namespaces>创建 namespaces</a></li><li><a href=#prometheus-operator>prometheus-operator</a></li><li><a href=#node-exporter>node-exporter</a></li><li><a href=#kube-state-metrics>kube-state-metrics</a></li><li><a href=#prometheus>prometheus</a></li><li><a href=#alertmanager>alertmanager</a></li><li><a href=#grafana>grafana</a></li></ul></li><li><a href=#页面展示>页面展示</a></li></ul></nav></div></div><div class=content id=content><p>{% raw %}</p><h1 id=prometheus-monitoring>Prometheus Monitoring</h1><h2 id=部署-prometheus>部署 Prometheus</h2><h3 id=镜像下载>镜像下载</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>jicki/prometheus-operator:v0.16.1
jicki/configmap-reload:v0.0.1
jicki/kube-rbac-proxy:v0.2.0
jicki/node-exporter:v0.15.2
jicki/kube-state-metrics:v1.2.0
jicki/addon-resizer:1.0
jicki/monitoring-grafana:4.6.3
jicki/grafana-watcher:v0.0.8
quay.io/prometheus/prometheus:v2.1.0
quay.io/coreos/prometheus-config-reloader:v0.0.2
</code></pre></td></tr></table></div></div><h3 id=创建-namespaces>创建 namespaces</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># vi namespace.yaml

apiVersion: v1
kind: Namespace
metadata:
  name: monitoring

</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 导入 yaml

[root@kubernetes-64 monitoring]# kubectl apply -f namespace.yaml
namespace &#34;monitoring&#34; created

</code></pre></td></tr></table></div></div><h3 id=prometheus-operator>prometheus-operator</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># vi prometheus-operator.yaml


---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: prometheus-operator
  namespace: monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus-operator
subjects:
- kind: ServiceAccount
  name: prometheus-operator
  namespace: monitoring
  
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: prometheus-operator
  namespace: monitoring
rules:
- apiGroups:
  - extensions
  resources:
  - thirdpartyresources
  verbs:
  - &#34;*&#34;
- apiGroups:
  - apiextensions.k8s.io
  resources:
  - customresourcedefinitions
  verbs:
  - &#34;*&#34;
- apiGroups:
  - monitoring.coreos.com
  resources:
  - alertmanagers
  - prometheuses
  - servicemonitors
  verbs:
  - &#34;*&#34;
- apiGroups:
  - apps
  resources:
  - statefulsets
  verbs: [&#34;*&#34;]
- apiGroups: [&#34;&#34;]
  resources:
  - configmaps
  - secrets
  verbs: [&#34;*&#34;]
- apiGroups: [&#34;&#34;]
  resources:
  - pods
  verbs: [&#34;list&#34;, &#34;delete&#34;]
- apiGroups: [&#34;&#34;]
  resources:
  - services
  - endpoints
  verbs: [&#34;get&#34;, &#34;create&#34;, &#34;update&#34;]
- apiGroups: [&#34;&#34;]
  resources:
  - nodes
  verbs: [&#34;list&#34;, &#34;watch&#34;]
- apiGroups: [&#34;&#34;]
  resources:
  - namespaces
  verbs: [&#34;list&#34;]
  
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus-operator
  namespace: monitoring
  
---

apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    k8s-app: prometheus-operator
  name: prometheus-operator
  namespace: monitoring
spec:
  replicas: 1
  template:
    metadata:
      labels:
        k8s-app: prometheus-operator
    spec:
      containers:
      - args:
        - --kubelet-service=kube-system/kubelet
        - --config-reloader-image=jicki/configmap-reload:v0.0.1
        image: jicki/prometheus-operator:v0.16.1
        name: prometheus-operator
        ports:
        - containerPort: 8080
          name: http
        resources:
          limits:
            cpu: 200m
            memory: 100Mi
          requests:
            cpu: 100m
            memory: 50Mi
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
      serviceAccountName: prometheus-operator
    
---
apiVersion: v1
kind: Service
metadata:
  name: prometheus-operator
  namespace: monitoring
  labels:
    k8s-app: prometheus-operator
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 8080
    targetPort: http
    protocol: TCP
  selector:
    k8s-app: prometheus-operator


</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 导入 yaml 文件

[root@kubernetes-64 monitoring]# kubectl apply -f prometheus-operator.yaml 
clusterrolebinding &#34;prometheus-operator&#34; created
clusterrole &#34;prometheus-operator&#34; created
serviceaccount &#34;prometheus-operator&#34; created
deployment &#34;prometheus-operator&#34; created
service &#34;prometheus-operator&#34; created


[root@kubernetes-64 monitoring]# kubectl get pod -n monitoring
NAME                                READY     STATUS    RESTARTS   AGE
prometheus-operator-c544bf4-v6z5z   1/1       Running   0          11s

</code></pre></td></tr></table></div></div><h3 id=node-exporter>node-exporter</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>vi node-exporter.yaml


---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: node-exporter
  namespace: monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: node-exporter
subjects:
- kind: ServiceAccount
  name: node-exporter
  namespace: monitoring
  
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: node-exporter
  namespace: monitoring
rules:
- apiGroups: [&#34;authentication.k8s.io&#34;]
  resources:
  - tokenreviews
  verbs: [&#34;create&#34;]
- apiGroups: [&#34;authorization.k8s.io&#34;]
  resources:
  - subjectaccessreviews
  verbs: [&#34;create&#34;]
  
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: node-exporter
  namespace: monitoring
  
---
apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: node-exporter
  namespace: monitoring
spec:
  updateStrategy:
    rollingUpdate:
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: node-exporter
      name: node-exporter
    spec:
      serviceAccountName: node-exporter
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
      hostNetwork: true
      hostPID: true
      containers:
      - image: jicki/node-exporter:v0.15.2
        args:
        - &#34;--web.listen-address=127.0.0.1:9101&#34;
        - &#34;--path.procfs=/host/proc&#34;
        - &#34;--path.sysfs=/host/sys&#34;
        name: node-exporter
        resources:
          requests:
            memory: 30Mi
            cpu: 100m
          limits:
            memory: 50Mi
            cpu: 200m
        volumeMounts:
        - name: proc
          readOnly:  true
          mountPath: /host/proc
        - name: sys
          readOnly: true
          mountPath: /host/sys
      - name: kube-rbac-proxy
        image: jicki/kube-rbac-proxy:v0.2.0
        args:
        - &#34;--secure-listen-address=:9100&#34;
        - &#34;--upstream=http://127.0.0.1:9101/&#34;
        ports:
        - containerPort: 9100
          hostPort: 9100
          name: https
        resources:
          requests:
            memory: 20Mi
            cpu: 10m
          limits:
            memory: 40Mi
            cpu: 20m
      tolerations:
        - effect: NoSchedule
          operator: Exists
      volumes:
      - name: proc
        hostPath:
          path: /proc
      - name: sys
        hostPath:
          path: /sys
          
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: node-exporter
    k8s-app: node-exporter
  name: node-exporter
  namespace: monitoring
spec:
  type: ClusterIP
  clusterIP: None
  ports:
  - name: https
    port: 9100
    protocol: TCP
  selector:
    app: node-exporter


</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 导入 yaml 文件

[root@kubernetes-64 monitoring]# kubectl apply -f node-exporter.yaml 
clusterrolebinding &#34;node-exporter&#34; created
clusterrole &#34;node-exporter&#34; created
serviceaccount &#34;node-exporter&#34; created
daemonset &#34;node-exporter&#34; created
service &#34;node-exporter&#34; created


[root@kubernetes-64 monitoring]# kubectl get pods -n monitoring -o wide
NAME                  READY     STATUS    RESTARTS   AGE       IP            NODE
node-exporter-2299v   2/2       Running   0          2m        172.16.1.66   kubernetes-66
node-exporter-2lsfc   2/2       Running   0          2m        172.16.1.64   kubernetes-64
node-exporter-mstjl   2/2       Running   0          2m        172.16.1.65   kubernetes-65


</code></pre></td></tr></table></div></div><h3 id=kube-state-metrics>kube-state-metrics</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>vi kube-state-metrics.yaml


---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: kube-state-metrics
  namespace: monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kube-state-metrics
subjects:
- kind: ServiceAccount
  name: kube-state-metrics
  namespace: monitoring
  
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: kube-state-metrics
  namespace: monitoring
rules:
- apiGroups: [&#34;&#34;]
  resources:
  - nodes
  - pods
  - services
  - resourcequotas
  - replicationcontrollers
  - limitranges
  - persistentvolumeclaims
  - persistentvolumes
  - namespaces
  - endpoints
  verbs: [&#34;list&#34;, &#34;watch&#34;]
- apiGroups: [&#34;extensions&#34;]
  resources:
  - daemonsets
  - deployments
  - replicasets
  verbs: [&#34;list&#34;, &#34;watch&#34;]
- apiGroups: [&#34;apps&#34;]
  resources:
  - statefulsets
  verbs: [&#34;list&#34;, &#34;watch&#34;]
- apiGroups: [&#34;batch&#34;]
  resources:
  - cronjobs
  - jobs
  verbs: [&#34;list&#34;, &#34;watch&#34;]
- apiGroups: [&#34;autoscaling&#34;]
  resources:
  - horizontalpodautoscalers
  verbs: [&#34;list&#34;, &#34;watch&#34;]
- apiGroups: [&#34;authentication.k8s.io&#34;]
  resources:
  - tokenreviews
  verbs: [&#34;create&#34;]
- apiGroups: [&#34;authorization.k8s.io&#34;]
  resources:
  - subjectaccessreviews
  verbs: [&#34;create&#34;]
  
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  name: kube-state-metrics
  namespace: monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: kube-state-metrics-resizer
subjects:
- kind: ServiceAccount
  name: kube-state-metrics
  
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
  name: kube-state-metrics-resizer
  namespace: monitoring
rules:
- apiGroups: [&#34;&#34;]
  resources:
  - pods
  verbs: [&#34;get&#34;]
- apiGroups: [&#34;extensions&#34;]
  resources:
  - deployments
  resourceNames: [&#34;kube-state-metrics&#34;]
  verbs: [&#34;get&#34;, &#34;update&#34;]
  
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kube-state-metrics
  namespace: monitoring
  
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: kube-state-metrics
  namespace: monitoring
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: kube-state-metrics
    spec:
      serviceAccountName: kube-state-metrics
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
      containers:
      - name: kube-rbac-proxy-main
        image: jicki/kube-rbac-proxy:v0.2.0
        args:
        - &#34;--secure-listen-address=:8443&#34;
        - &#34;--upstream=http://127.0.0.1:8081/&#34;
        ports:
        - name: https-main
          containerPort: 8443
        resources:
          requests:
            memory: 20Mi
            cpu: 10m
          limits:
            memory: 40Mi
            cpu: 20m
      - name: kube-rbac-proxy-self
        image: jicki/kube-rbac-proxy:v0.2.0
        args:
        - &#34;--secure-listen-address=:9443&#34;
        - &#34;--upstream=http://127.0.0.1:8082/&#34;
        ports:
        - name: https-self
          containerPort: 9443
        resources:
          requests:
            memory: 20Mi
            cpu: 10m
          limits:
            memory: 40Mi
            cpu: 20m
      - name: kube-state-metrics
        image: jicki/kube-state-metrics:v1.2.0
        args:
        - &#34;--host=127.0.0.1&#34;
        - &#34;--port=8081&#34;
        - &#34;--telemetry-host=127.0.0.1&#34;
        - &#34;--telemetry-port=8082&#34;
      - name: addon-resizer
        image: jicki/addon-resizer:1.0
        resources:
          limits:
            cpu: 100m
            memory: 30Mi
          requests:
            cpu: 100m
            memory: 30Mi
        env:
          - name: MY_POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: MY_POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
        command:
          - /pod_nanny
          - --container=kube-state-metrics
          - --cpu=100m
          - --extra-cpu=2m
          - --memory=150Mi
          - --extra-memory=30Mi
          - --threshold=5
          - --deployment=kube-state-metrics
          
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: kube-state-metrics
    k8s-app: kube-state-metrics
  name: kube-state-metrics
  namespace: monitoring
spec:
  clusterIP: None
  ports:
  - name: https-main
    port: 8443
    targetPort: https-main
    protocol: TCP
  - name: https-self
    port: 9443
    targetPort: https-self
    protocol: TCP
  selector:
    app: kube-state-metrics
    

</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 导入 yaml 文件

[root@kubernetes-64 monitoring]# kubectl apply -f kube-state-metrics.yaml 
clusterrolebinding &#34;kube-state-metrics&#34; created
clusterrole &#34;kube-state-metrics&#34; created
rolebinding &#34;kube-state-metrics&#34; created
role &#34;kube-state-metrics-resizer&#34; created
serviceaccount &#34;kube-state-metrics&#34; created
deployment &#34;kube-state-metrics&#34; created
service &#34;kube-state-metrics&#34; created


[root@kubernetes-64 monitoring]# kubectl get pods -n monitoring
NAME                                  READY     STATUS    RESTARTS   AGE
kube-state-metrics-578778548f-8gf8d   4/4       Running   0          1m
node-exporter-9pgx5                   2/2       Running   0          2m
node-exporter-dz9kp                   2/2       Running   0          2m
node-exporter-mcd9m                   2/2       Running   0          2m
prometheus-operator-9bf5574-s7k76     1/1       Running   0          2m


</code></pre></td></tr></table></div></div><h3 id=prometheus>prometheus</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span><span class=lnt>357
</span><span class=lnt>358
</span><span class=lnt>359
</span><span class=lnt>360
</span><span class=lnt>361
</span><span class=lnt>362
</span><span class=lnt>363
</span><span class=lnt>364
</span><span class=lnt>365
</span><span class=lnt>366
</span><span class=lnt>367
</span><span class=lnt>368
</span><span class=lnt>369
</span><span class=lnt>370
</span><span class=lnt>371
</span><span class=lnt>372
</span><span class=lnt>373
</span><span class=lnt>374
</span><span class=lnt>375
</span><span class=lnt>376
</span><span class=lnt>377
</span><span class=lnt>378
</span><span class=lnt>379
</span><span class=lnt>380
</span><span class=lnt>381
</span><span class=lnt>382
</span><span class=lnt>383
</span><span class=lnt>384
</span><span class=lnt>385
</span><span class=lnt>386
</span><span class=lnt>387
</span><span class=lnt>388
</span><span class=lnt>389
</span><span class=lnt>390
</span><span class=lnt>391
</span><span class=lnt>392
</span><span class=lnt>393
</span><span class=lnt>394
</span><span class=lnt>395
</span><span class=lnt>396
</span><span class=lnt>397
</span><span class=lnt>398
</span><span class=lnt>399
</span><span class=lnt>400
</span><span class=lnt>401
</span><span class=lnt>402
</span><span class=lnt>403
</span><span class=lnt>404
</span><span class=lnt>405
</span><span class=lnt>406
</span><span class=lnt>407
</span><span class=lnt>408
</span><span class=lnt>409
</span><span class=lnt>410
</span><span class=lnt>411
</span><span class=lnt>412
</span><span class=lnt>413
</span><span class=lnt>414
</span><span class=lnt>415
</span><span class=lnt>416
</span><span class=lnt>417
</span><span class=lnt>418
</span><span class=lnt>419
</span><span class=lnt>420
</span><span class=lnt>421
</span><span class=lnt>422
</span><span class=lnt>423
</span><span class=lnt>424
</span><span class=lnt>425
</span><span class=lnt>426
</span><span class=lnt>427
</span><span class=lnt>428
</span><span class=lnt>429
</span><span class=lnt>430
</span><span class=lnt>431
</span><span class=lnt>432
</span><span class=lnt>433
</span><span class=lnt>434
</span><span class=lnt>435
</span><span class=lnt>436
</span><span class=lnt>437
</span><span class=lnt>438
</span><span class=lnt>439
</span><span class=lnt>440
</span><span class=lnt>441
</span><span class=lnt>442
</span><span class=lnt>443
</span><span class=lnt>444
</span><span class=lnt>445
</span><span class=lnt>446
</span><span class=lnt>447
</span><span class=lnt>448
</span><span class=lnt>449
</span><span class=lnt>450
</span><span class=lnt>451
</span><span class=lnt>452
</span><span class=lnt>453
</span><span class=lnt>454
</span><span class=lnt>455
</span><span class=lnt>456
</span><span class=lnt>457
</span><span class=lnt>458
</span><span class=lnt>459
</span><span class=lnt>460
</span><span class=lnt>461
</span><span class=lnt>462
</span><span class=lnt>463
</span><span class=lnt>464
</span><span class=lnt>465
</span><span class=lnt>466
</span><span class=lnt>467
</span><span class=lnt>468
</span><span class=lnt>469
</span><span class=lnt>470
</span><span class=lnt>471
</span><span class=lnt>472
</span><span class=lnt>473
</span><span class=lnt>474
</span><span class=lnt>475
</span><span class=lnt>476
</span><span class=lnt>477
</span><span class=lnt>478
</span><span class=lnt>479
</span><span class=lnt>480
</span><span class=lnt>481
</span><span class=lnt>482
</span><span class=lnt>483
</span><span class=lnt>484
</span><span class=lnt>485
</span><span class=lnt>486
</span><span class=lnt>487
</span><span class=lnt>488
</span><span class=lnt>489
</span><span class=lnt>490
</span><span class=lnt>491
</span><span class=lnt>492
</span><span class=lnt>493
</span><span class=lnt>494
</span><span class=lnt>495
</span><span class=lnt>496
</span><span class=lnt>497
</span><span class=lnt>498
</span><span class=lnt>499
</span><span class=lnt>500
</span><span class=lnt>501
</span><span class=lnt>502
</span><span class=lnt>503
</span><span class=lnt>504
</span><span class=lnt>505
</span><span class=lnt>506
</span><span class=lnt>507
</span><span class=lnt>508
</span><span class=lnt>509
</span><span class=lnt>510
</span><span class=lnt>511
</span><span class=lnt>512
</span><span class=lnt>513
</span><span class=lnt>514
</span><span class=lnt>515
</span><span class=lnt>516
</span><span class=lnt>517
</span><span class=lnt>518
</span><span class=lnt>519
</span><span class=lnt>520
</span><span class=lnt>521
</span><span class=lnt>522
</span><span class=lnt>523
</span><span class=lnt>524
</span><span class=lnt>525
</span><span class=lnt>526
</span><span class=lnt>527
</span><span class=lnt>528
</span><span class=lnt>529
</span><span class=lnt>530
</span><span class=lnt>531
</span><span class=lnt>532
</span><span class=lnt>533
</span><span class=lnt>534
</span><span class=lnt>535
</span><span class=lnt>536
</span><span class=lnt>537
</span><span class=lnt>538
</span><span class=lnt>539
</span><span class=lnt>540
</span><span class=lnt>541
</span><span class=lnt>542
</span><span class=lnt>543
</span><span class=lnt>544
</span><span class=lnt>545
</span><span class=lnt>546
</span><span class=lnt>547
</span><span class=lnt>548
</span><span class=lnt>549
</span><span class=lnt>550
</span><span class=lnt>551
</span><span class=lnt>552
</span><span class=lnt>553
</span><span class=lnt>554
</span><span class=lnt>555
</span><span class=lnt>556
</span><span class=lnt>557
</span><span class=lnt>558
</span><span class=lnt>559
</span><span class=lnt>560
</span><span class=lnt>561
</span><span class=lnt>562
</span><span class=lnt>563
</span><span class=lnt>564
</span><span class=lnt>565
</span><span class=lnt>566
</span><span class=lnt>567
</span><span class=lnt>568
</span><span class=lnt>569
</span><span class=lnt>570
</span><span class=lnt>571
</span><span class=lnt>572
</span><span class=lnt>573
</span><span class=lnt>574
</span><span class=lnt>575
</span><span class=lnt>576
</span><span class=lnt>577
</span><span class=lnt>578
</span><span class=lnt>579
</span><span class=lnt>580
</span><span class=lnt>581
</span><span class=lnt>582
</span><span class=lnt>583
</span><span class=lnt>584
</span><span class=lnt>585
</span><span class=lnt>586
</span><span class=lnt>587
</span><span class=lnt>588
</span><span class=lnt>589
</span><span class=lnt>590
</span><span class=lnt>591
</span><span class=lnt>592
</span><span class=lnt>593
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>vi prometheus-k8s.yaml

---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  name: prometheus-k8s
  namespace: monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: prometheus-k8s
subjects:
- kind: ServiceAccount
  name: prometheus-k8s
  namespace: monitoring
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  name: prometheus-k8s
  namespace: kube-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: prometheus-k8s
subjects:
- kind: ServiceAccount
  name: prometheus-k8s
  namespace: monitoring
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  name: prometheus-k8s
  namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: prometheus-k8s
subjects:
- kind: ServiceAccount
  name: prometheus-k8s
  namespace: monitoring
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: prometheus-k8s
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus-k8s
subjects:
- kind: ServiceAccount
  name: prometheus-k8s
  namespace: monitoring

---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
  name: prometheus-k8s
  namespace: monitoring
rules:
- apiGroups: <span class=o>[</span><span class=s2>&#34;&#34;</span><span class=o>]</span>
  resources:
  - nodes
  - services
  - endpoints
  - pods
  verbs: <span class=o>[</span><span class=s2>&#34;get&#34;</span>, <span class=s2>&#34;list&#34;</span>, <span class=s2>&#34;watch&#34;</span><span class=o>]</span>
- apiGroups: <span class=o>[</span><span class=s2>&#34;&#34;</span><span class=o>]</span>
  resources:
  - configmaps
  verbs: <span class=o>[</span><span class=s2>&#34;get&#34;</span><span class=o>]</span>
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
  name: prometheus-k8s
  namespace: kube-system
rules:
- apiGroups: <span class=o>[</span><span class=s2>&#34;&#34;</span><span class=o>]</span>
  resources:
  - services
  - endpoints
  - pods
  verbs: <span class=o>[</span><span class=s2>&#34;get&#34;</span>, <span class=s2>&#34;list&#34;</span>, <span class=s2>&#34;watch&#34;</span><span class=o>]</span>
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
  name: prometheus-k8s
  namespace: default
rules:
- apiGroups: <span class=o>[</span><span class=s2>&#34;&#34;</span><span class=o>]</span>
  resources:
  - services
  - endpoints
  - pods
  verbs: <span class=o>[</span><span class=s2>&#34;get&#34;</span>, <span class=s2>&#34;list&#34;</span>, <span class=s2>&#34;watch&#34;</span><span class=o>]</span>
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: prometheus-k8s
rules:
- apiGroups: <span class=o>[</span><span class=s2>&#34;&#34;</span><span class=o>]</span>
  resources:
  - nodes/metrics
  verbs: <span class=o>[</span><span class=s2>&#34;get&#34;</span><span class=o>]</span>
- nonResourceURLs: <span class=o>[</span><span class=s2>&#34;/metrics&#34;</span><span class=o>]</span>
  verbs: <span class=o>[</span><span class=s2>&#34;get&#34;</span><span class=o>]</span>
  
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-k8s-rules
  namespace: monitoring
  labels:
    role: prometheus-rulefiles
    prometheus: k8s
data:
  alertmanager.rules.yaml: <span class=p>|</span>+
    groups:
    - name: alertmanager.rules
      rules:
      - alert: AlertmanagerConfigInconsistent
        expr: count_values<span class=o>(</span><span class=s2>&#34;config_hash&#34;</span>, alertmanager_config_hash<span class=o>)</span> BY <span class=o>(</span>service<span class=o>)</span> / ON<span class=o>(</span>service<span class=o>)</span>
          GROUP_LEFT<span class=o>()</span> label_replace<span class=o>(</span>prometheus_operator_alertmanager_spec_replicas, <span class=s2>&#34;service&#34;</span>,
          <span class=s2>&#34;alertmanager-</span><span class=nv>$1</span><span class=s2>&#34;</span>, <span class=s2>&#34;alertmanager&#34;</span>, <span class=s2>&#34;(.*)&#34;</span><span class=o>)</span> !<span class=o>=</span> <span class=m>1</span>
        <span class=k>for</span>: 5m
        labels:
          severity: critical
        annotations:
          description: The configuration of the instances of the Alertmanager cluster
            <span class=sb>`</span><span class=o>{{</span><span class=nv>$labels</span>.service<span class=o>}}</span><span class=sb>`</span> are out of sync.
      - alert: AlertmanagerDownOrMissing
        expr: label_replace<span class=o>(</span>prometheus_operator_alertmanager_spec_replicas, <span class=s2>&#34;job&#34;</span>, <span class=s2>&#34;alertmanager-</span><span class=nv>$1</span><span class=s2>&#34;</span>,
          <span class=s2>&#34;alertmanager&#34;</span>, <span class=s2>&#34;(.*)&#34;</span><span class=o>)</span> / ON<span class=o>(</span>job<span class=o>)</span> GROUP_RIGHT<span class=o>()</span> sum<span class=o>(</span>up<span class=o>)</span> BY <span class=o>(</span>job<span class=o>)</span> !<span class=o>=</span> <span class=m>1</span>
        <span class=k>for</span>: 5m
        labels:
          severity: warning
        annotations:
          description: An unexpected number of Alertmanagers are scraped or Alertmanagers
            disappeared from discovery.
      - alert: AlertmanagerFailedReload
        expr: <span class=nv>alertmanager_config_last_reload_successful</span> <span class=o>==</span> <span class=m>0</span>
        <span class=k>for</span>: 10m
        labels:
          severity: warning
        annotations:
          description: Reloading Alertmanager<span class=s1>&#39;s configuration has failed for {{ $labels.namespace
</span><span class=s1>            }}/{{ $labels.pod}}.
</span><span class=s1>  general.rules.yaml: |+
</span><span class=s1>    groups:
</span><span class=s1>    - name: general.rules
</span><span class=s1>      rules:
</span><span class=s1>      - alert: TargetDown
</span><span class=s1>        expr: 100 * (count(up == 0) BY (job) / count(up) BY (job)) &gt; 10
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: &#39;</span><span class=o>{{</span> <span class=nv>$value</span> <span class=o>}}</span>% of <span class=o>{{</span> <span class=nv>$labels</span>.job <span class=o>}}</span> targets are down.<span class=s1>&#39;
</span><span class=s1>          summary: Targets are down
</span><span class=s1>      - alert: DeadMansSwitch
</span><span class=s1>        expr: vector(1)
</span><span class=s1>        labels:
</span><span class=s1>          severity: none
</span><span class=s1>        annotations:
</span><span class=s1>          description: This is a DeadMansSwitch meant to ensure that the entire Alerting
</span><span class=s1>            pipeline is functional.
</span><span class=s1>          summary: Alerting DeadMansSwitch
</span><span class=s1>      - record: fd_utilization
</span><span class=s1>        expr: process_open_fds / process_max_fds
</span><span class=s1>      - alert: FdExhaustionClose
</span><span class=s1>        expr: predict_linear(fd_utilization[1h], 3600 * 4) &gt; 1
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: &#39;</span><span class=o>{{</span> <span class=nv>$labels</span>.job <span class=o>}}</span>: <span class=o>{{</span> <span class=nv>$labels</span>.namespace <span class=o>}}</span>/<span class=o>{{</span> <span class=nv>$labels</span>.pod <span class=o>}}</span> instance
            will exhaust in file/socket descriptors within the next <span class=m>4</span> hours<span class=s1>&#39;
</span><span class=s1>          summary: file descriptors soon exhausted
</span><span class=s1>      - alert: FdExhaustionClose
</span><span class=s1>        expr: predict_linear(fd_utilization[10m], 3600) &gt; 1
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: critical
</span><span class=s1>        annotations:
</span><span class=s1>          description: &#39;</span><span class=o>{{</span> <span class=nv>$labels</span>.job <span class=o>}}</span>: <span class=o>{{</span> <span class=nv>$labels</span>.namespace <span class=o>}}</span>/<span class=o>{{</span> <span class=nv>$labels</span>.pod <span class=o>}}</span> instance
            will exhaust in file/socket descriptors within the next hour<span class=s1>&#39;
</span><span class=s1>          summary: file descriptors soon exhausted
</span><span class=s1>  kube-state-metrics.rules.yaml: |+
</span><span class=s1>    groups:
</span><span class=s1>    - name: kube-state-metrics.rules
</span><span class=s1>      rules:
</span><span class=s1>      - alert: DeploymentGenerationMismatch
</span><span class=s1>        expr: kube_deployment_status_observed_generation != kube_deployment_metadata_generation
</span><span class=s1>        for: 15m
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: Observed deployment generation does not match expected one for
</span><span class=s1>            deployment {{$labels.namespaces}}/{{$labels.deployment}}
</span><span class=s1>          summary: Deployment is outdated
</span><span class=s1>      - alert: DeploymentReplicasNotUpdated
</span><span class=s1>        expr: ((kube_deployment_status_replicas_updated != kube_deployment_spec_replicas)
</span><span class=s1>          or (kube_deployment_status_replicas_available != kube_deployment_spec_replicas))
</span><span class=s1>          unless (kube_deployment_spec_paused == 1)
</span><span class=s1>        for: 15m
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: Replicas are not updated and available for deployment {{$labels.namespaces}}/{{$labels.deployment}}
</span><span class=s1>          summary: Deployment replicas are outdated
</span><span class=s1>      - alert: DaemonSetRolloutStuck
</span><span class=s1>        expr: kube_daemonset_status_number_ready / kube_daemonset_status_desired_number_scheduled
</span><span class=s1>          * 100 &lt; 100
</span><span class=s1>        for: 15m
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: Only {{$value}}% of desired pods scheduled and ready for daemon
</span><span class=s1>            set {{$labels.namespaces}}/{{$labels.daemonset}}
</span><span class=s1>          summary: DaemonSet is missing pods
</span><span class=s1>      - alert: K8SDaemonSetsNotScheduled
</span><span class=s1>        expr: kube_daemonset_status_desired_number_scheduled - kube_daemonset_status_current_number_scheduled
</span><span class=s1>          &gt; 0
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: A number of daemonsets are not scheduled.
</span><span class=s1>          summary: Daemonsets are not scheduled correctly
</span><span class=s1>      - alert: DaemonSetsMissScheduled
</span><span class=s1>        expr: kube_daemonset_status_number_misscheduled &gt; 0
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: A number of daemonsets are running where they are not supposed
</span><span class=s1>            to run.
</span><span class=s1>          summary: Daemonsets are not scheduled correctly
</span><span class=s1>      - alert: PodFrequentlyRestarting
</span><span class=s1>        expr: increase(kube_pod_container_status_restarts_total[1h]) &gt; 5
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: Pod {{$labels.namespaces}}/{{$labels.pod}} is was restarted {{$value}}
</span><span class=s1>            times within the last hour
</span><span class=s1>          summary: Pod is restarting frequently
</span><span class=s1>  kubelet.rules.yaml: |+
</span><span class=s1>    groups:
</span><span class=s1>    - name: kubelet.rules
</span><span class=s1>      rules:
</span><span class=s1>      - alert: K8SNodeNotReady
</span><span class=s1>        expr: kube_node_status_condition{condition=&#34;Ready&#34;,status=&#34;true&#34;} == 0
</span><span class=s1>        for: 1h
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: The Kubelet on {{ $labels.node }} has not checked in with the API,
</span><span class=s1>            or has set itself to NotReady, for more than an hour
</span><span class=s1>          summary: Node status is NotReady
</span><span class=s1>      - alert: K8SManyNodesNotReady
</span><span class=s1>        expr: count(kube_node_status_condition{condition=&#34;Ready&#34;,status=&#34;true&#34;} == 0)
</span><span class=s1>          &gt; 1 and (count(kube_node_status_condition{condition=&#34;Ready&#34;,status=&#34;true&#34;} ==
</span><span class=s1>          0) / count(kube_node_status_condition{condition=&#34;Ready&#34;,status=&#34;true&#34;})) &gt; 0.2
</span><span class=s1>        for: 1m
</span><span class=s1>        labels:
</span><span class=s1>          severity: critical
</span><span class=s1>        annotations:
</span><span class=s1>          description: &#39;</span><span class=o>{{</span> <span class=nv>$value</span> <span class=o>}}</span>% of Kubernetes nodes are not ready<span class=s1>&#39;
</span><span class=s1>      - alert: K8SKubeletDown
</span><span class=s1>        expr: count(up{job=&#34;kubelet&#34;} == 0) / count(up{job=&#34;kubelet&#34;}) * 100 &gt; 3
</span><span class=s1>        for: 1h
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: Prometheus failed to scrape {{ $value }}% of kubelets.
</span><span class=s1>      - alert: K8SKubeletDown
</span><span class=s1>        expr: (absent(up{job=&#34;kubelet&#34;} == 1) or count(up{job=&#34;kubelet&#34;} == 0) / count(up{job=&#34;kubelet&#34;}))
</span><span class=s1>          * 100 &gt; 1
</span><span class=s1>        for: 1h
</span><span class=s1>        labels:
</span><span class=s1>          severity: critical
</span><span class=s1>        annotations:
</span><span class=s1>          description: Prometheus failed to scrape {{ $value }}% of kubelets, or all Kubelets
</span><span class=s1>            have disappeared from service discovery.
</span><span class=s1>          summary: Many Kubelets cannot be scraped
</span><span class=s1>      - alert: K8SKubeletTooManyPods
</span><span class=s1>        expr: kubelet_running_pod_count &gt; 100
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: Kubelet {{$labels.instance}} is running {{$value}} pods, close
</span><span class=s1>            to the limit of 110
</span><span class=s1>          summary: Kubelet is close to pod limit
</span><span class=s1>  kubernetes.rules.yaml: |+
</span><span class=s1>    groups:
</span><span class=s1>    - name: kubernetes.rules
</span><span class=s1>      rules:
</span><span class=s1>      - record: pod_name:container_memory_usage_bytes:sum
</span><span class=s1>        expr: sum(container_memory_usage_bytes{container_name!=&#34;POD&#34;,pod_name!=&#34;&#34;}) BY
</span><span class=s1>          (pod_name)
</span><span class=s1>      - record: pod_name:container_spec_cpu_shares:sum
</span><span class=s1>        expr: sum(container_spec_cpu_shares{container_name!=&#34;POD&#34;,pod_name!=&#34;&#34;}) BY (pod_name)
</span><span class=s1>      - record: pod_name:container_cpu_usage:sum
</span><span class=s1>        expr: sum(rate(container_cpu_usage_seconds_total{container_name!=&#34;POD&#34;,pod_name!=&#34;&#34;}[5m]))
</span><span class=s1>          BY (pod_name)
</span><span class=s1>      - record: pod_name:container_fs_usage_bytes:sum
</span><span class=s1>        expr: sum(container_fs_usage_bytes{container_name!=&#34;POD&#34;,pod_name!=&#34;&#34;}) BY (pod_name)
</span><span class=s1>      - record: namespace:container_memory_usage_bytes:sum
</span><span class=s1>        expr: sum(container_memory_usage_bytes{container_name!=&#34;&#34;}) BY (namespace)
</span><span class=s1>      - record: namespace:container_spec_cpu_shares:sum
</span><span class=s1>        expr: sum(container_spec_cpu_shares{container_name!=&#34;&#34;}) BY (namespace)
</span><span class=s1>      - record: namespace:container_cpu_usage:sum
</span><span class=s1>        expr: sum(rate(container_cpu_usage_seconds_total{container_name!=&#34;POD&#34;}[5m]))
</span><span class=s1>          BY (namespace)
</span><span class=s1>      - record: cluster:memory_usage:ratio
</span><span class=s1>        expr: sum(container_memory_usage_bytes{container_name!=&#34;POD&#34;,pod_name!=&#34;&#34;}) BY
</span><span class=s1>          (cluster) / sum(machine_memory_bytes) BY (cluster)
</span><span class=s1>      - record: cluster:container_spec_cpu_shares:ratio
</span><span class=s1>        expr: sum(container_spec_cpu_shares{container_name!=&#34;POD&#34;,pod_name!=&#34;&#34;}) / 1000
</span><span class=s1>          / sum(machine_cpu_cores)
</span><span class=s1>      - record: cluster:container_cpu_usage:ratio
</span><span class=s1>        expr: sum(rate(container_cpu_usage_seconds_total{container_name!=&#34;POD&#34;,pod_name!=&#34;&#34;}[5m]))
</span><span class=s1>          / sum(machine_cpu_cores)
</span><span class=s1>      - record: apiserver_latency_seconds:quantile
</span><span class=s1>        expr: histogram_quantile(0.99, rate(apiserver_request_latencies_bucket[5m])) /
</span><span class=s1>          1e+06
</span><span class=s1>        labels:
</span><span class=s1>          quantile: &#34;0.99&#34;
</span><span class=s1>      - record: apiserver_latency:quantile_seconds
</span><span class=s1>        expr: histogram_quantile(0.9, rate(apiserver_request_latencies_bucket[5m])) /
</span><span class=s1>          1e+06
</span><span class=s1>        labels:
</span><span class=s1>          quantile: &#34;0.9&#34;
</span><span class=s1>      - record: apiserver_latency_seconds:quantile
</span><span class=s1>        expr: histogram_quantile(0.5, rate(apiserver_request_latencies_bucket[5m])) /
</span><span class=s1>          1e+06
</span><span class=s1>        labels:
</span><span class=s1>          quantile: &#34;0.5&#34;
</span><span class=s1>      - alert: APIServerLatencyHigh
</span><span class=s1>        expr: apiserver_latency_seconds:quantile{quantile=&#34;0.99&#34;,subresource!=&#34;log&#34;,verb!~&#34;^(?:WATCH|WATCHLIST|PROXY|CONNECT)$&#34;}
</span><span class=s1>          &gt; 1
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: the API server has a 99th percentile latency of {{ $value }} seconds
</span><span class=s1>            for {{$labels.verb}} {{$labels.resource}}
</span><span class=s1>      - alert: APIServerLatencyHigh
</span><span class=s1>        expr: apiserver_latency_seconds:quantile{quantile=&#34;0.99&#34;,subresource!=&#34;log&#34;,verb!~&#34;^(?:WATCH|WATCHLIST|PROXY|CONNECT)$&#34;}
</span><span class=s1>          &gt; 4
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: critical
</span><span class=s1>        annotations:
</span><span class=s1>          description: the API server has a 99th percentile latency of {{ $value }} seconds
</span><span class=s1>            for {{$labels.verb}} {{$labels.resource}}
</span><span class=s1>      - alert: APIServerErrorsHigh
</span><span class=s1>        expr: rate(apiserver_request_count{code=~&#34;^(?:5..)$&#34;}[5m]) / rate(apiserver_request_count[5m])
</span><span class=s1>          * 100 &gt; 2
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: API server returns errors for {{ $value }}% of requests
</span><span class=s1>      - alert: APIServerErrorsHigh
</span><span class=s1>        expr: rate(apiserver_request_count{code=~&#34;^(?:5..)$&#34;}[5m]) / rate(apiserver_request_count[5m])
</span><span class=s1>          * 100 &gt; 5
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: critical
</span><span class=s1>        annotations:
</span><span class=s1>          description: API server returns errors for {{ $value }}% of requests
</span><span class=s1>      - alert: K8SApiserverDown
</span><span class=s1>        expr: absent(up{job=&#34;apiserver&#34;} == 1)
</span><span class=s1>        for: 20m
</span><span class=s1>        labels:
</span><span class=s1>          severity: critical
</span><span class=s1>        annotations:
</span><span class=s1>          description: No API servers are reachable or all have disappeared from service
</span><span class=s1>            discovery
</span><span class=s1>    
</span><span class=s1>      - alert: K8sCertificateExpirationNotice
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: Kubernetes API Certificate is expiring soon (less than 7 days)
</span><span class=s1>        expr: sum(apiserver_client_certificate_expiration_seconds_bucket{le=&#34;604800&#34;}) &gt; 0
</span><span class=s1>    
</span><span class=s1>      - alert: K8sCertificateExpirationNotice
</span><span class=s1>        labels:
</span><span class=s1>          severity: critical
</span><span class=s1>        annotations:
</span><span class=s1>          description: Kubernetes API Certificate is expiring in less than 1 day
</span><span class=s1>        expr: sum(apiserver_client_certificate_expiration_seconds_bucket{le=&#34;86400&#34;}) &gt; 0
</span><span class=s1>  node.rules.yaml: |+
</span><span class=s1>    groups:
</span><span class=s1>    - name: node.rules
</span><span class=s1>      rules:
</span><span class=s1>      - record: instance:node_cpu:rate:sum
</span><span class=s1>        expr: sum(rate(node_cpu{mode!=&#34;idle&#34;,mode!=&#34;iowait&#34;,mode!~&#34;^(?:guest.*)$&#34;}[3m]))
</span><span class=s1>          BY (instance)
</span><span class=s1>      - record: instance:node_filesystem_usage:sum
</span><span class=s1>        expr: sum((node_filesystem_size{mountpoint=&#34;/&#34;} - node_filesystem_free{mountpoint=&#34;/&#34;}))
</span><span class=s1>          BY (instance)
</span><span class=s1>      - record: instance:node_network_receive_bytes:rate:sum
</span><span class=s1>        expr: sum(rate(node_network_receive_bytes[3m])) BY (instance)
</span><span class=s1>      - record: instance:node_network_transmit_bytes:rate:sum
</span><span class=s1>        expr: sum(rate(node_network_transmit_bytes[3m])) BY (instance)
</span><span class=s1>      - record: instance:node_cpu:ratio
</span><span class=s1>        expr: sum(rate(node_cpu{mode!=&#34;idle&#34;}[5m])) WITHOUT (cpu, mode) / ON(instance)
</span><span class=s1>          GROUP_LEFT() count(sum(node_cpu) BY (instance, cpu)) BY (instance)
</span><span class=s1>      - record: cluster:node_cpu:sum_rate5m
</span><span class=s1>        expr: sum(rate(node_cpu{mode!=&#34;idle&#34;}[5m]))
</span><span class=s1>      - record: cluster:node_cpu:ratio
</span><span class=s1>        expr: cluster:node_cpu:rate5m / count(sum(node_cpu) BY (instance, cpu))
</span><span class=s1>      - alert: NodeExporterDown
</span><span class=s1>        expr: absent(up{job=&#34;node-exporter&#34;} == 1)
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: Prometheus could not scrape a node-exporter for more than 10m,
</span><span class=s1>            or node-exporters have disappeared from discovery
</span><span class=s1>      - alert: NodeDiskRunningFull
</span><span class=s1>        expr: predict_linear(node_filesystem_free[6h], 3600 * 24) &lt; 0
</span><span class=s1>        for: 30m
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: device {{$labels.device}} on node {{$labels.instance}} is running
</span><span class=s1>            full within the next 24 hours (mounted at {{$labels.mountpoint}})
</span><span class=s1>      - alert: NodeDiskRunningFull
</span><span class=s1>        expr: predict_linear(node_filesystem_free[30m], 3600 * 2) &lt; 0
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: critical
</span><span class=s1>        annotations:
</span><span class=s1>          description: device {{$labels.device}} on node {{$labels.instance}} is running
</span><span class=s1>            full within the next 2 hours (mounted at {{$labels.mountpoint}})
</span><span class=s1>  prometheus.rules.yaml: |+
</span><span class=s1>    groups:
</span><span class=s1>    - name: prometheus.rules
</span><span class=s1>      rules:
</span><span class=s1>      - alert: PrometheusConfigReloadFailed
</span><span class=s1>        expr: prometheus_config_last_reload_successful == 0
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: Reloading Prometheus&#39;</span> configuration has failed <span class=k>for</span> <span class=o>{{</span><span class=nv>$labels</span>.namespace<span class=o>}}</span>/<span class=o>{{</span><span class=nv>$labels</span>.pod<span class=o>}}</span>
      - alert: PrometheusNotificationQueueRunningFull
        expr: predict_linear<span class=o>(</span>prometheus_notifications_queue_length<span class=o>[</span>5m<span class=o>]</span>, <span class=m>60</span> * 30<span class=o>)</span> &gt; prometheus_notifications_queue_capacity
        <span class=k>for</span>: 10m
        labels:
          severity: warning
        annotations:
          description: Prometheus<span class=s1>&#39; alert notification queue is running full for {{$labels.namespace}}/{{
</span><span class=s1>            $labels.pod}}
</span><span class=s1>      - alert: PrometheusErrorSendingAlerts
</span><span class=s1>        expr: rate(prometheus_notifications_errors_total[5m]) / rate(prometheus_notifications_sent_total[5m])
</span><span class=s1>          &gt; 0.01
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: Errors while sending alerts from Prometheus {{$labels.namespace}}/{{
</span><span class=s1>            $labels.pod}} to Alertmanager {{$labels.Alertmanager}}
</span><span class=s1>      - alert: PrometheusErrorSendingAlerts
</span><span class=s1>        expr: rate(prometheus_notifications_errors_total[5m]) / rate(prometheus_notifications_sent_total[5m])
</span><span class=s1>          &gt; 0.03
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: critical
</span><span class=s1>        annotations:
</span><span class=s1>          description: Errors while sending alerts from Prometheus {{$labels.namespace}}/{{
</span><span class=s1>            $labels.pod}} to Alertmanager {{$labels.Alertmanager}}
</span><span class=s1>      - alert: PrometheusNotConnectedToAlertmanagers
</span><span class=s1>        expr: prometheus_notifications_alertmanagers_discovered &lt; 1
</span><span class=s1>        for: 10m
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: Prometheus {{ $labels.namespace }}/{{ $labels.pod}} is not connected
</span><span class=s1>            to any Alertmanagers
</span><span class=s1>      - alert: PrometheusTSDBReloadsFailing
</span><span class=s1>        expr: increase(prometheus_tsdb_reloads_failures_total[2h]) &gt; 0
</span><span class=s1>        for: 12h
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: &#39;</span><span class=o>{{</span><span class=nv>$labels</span>.job<span class=o>}}</span> at <span class=o>{{</span><span class=nv>$labels</span>.instance<span class=o>}}</span> had <span class=o>{{</span><span class=nv>$value</span> <span class=p>|</span> humanize<span class=o>}}</span>
            reload failures over the last four hours.<span class=s1>&#39;
</span><span class=s1>          summary: Prometheus has issues reloading data blocks from disk
</span><span class=s1>      - alert: PrometheusTSDBCompactionsFailing
</span><span class=s1>        expr: increase(prometheus_tsdb_compactions_failed_total[2h]) &gt; 0
</span><span class=s1>        for: 12h
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: &#39;</span><span class=o>{{</span><span class=nv>$labels</span>.job<span class=o>}}</span> at <span class=o>{{</span><span class=nv>$labels</span>.instance<span class=o>}}</span> had <span class=o>{{</span><span class=nv>$value</span> <span class=p>|</span> humanize<span class=o>}}</span>
            compaction failures over the last four hours.<span class=s1>&#39;
</span><span class=s1>          summary: Prometheus has issues compacting sample blocks
</span><span class=s1>      - alert: PrometheusTSDBWALCorruptions
</span><span class=s1>        expr: tsdb_wal_corruptions_total &gt; 0
</span><span class=s1>        for: 4h
</span><span class=s1>        labels:
</span><span class=s1>          severity: warning
</span><span class=s1>        annotations:
</span><span class=s1>          description: &#39;</span><span class=o>{{</span><span class=nv>$labels</span>.job<span class=o>}}</span> at <span class=o>{{</span><span class=nv>$labels</span>.instance<span class=o>}}</span> has a corrupted write-ahead
            log <span class=o>(</span>WAL<span class=o>)</span>.<span class=err>&#39;</span>
          summary: Prometheus write-ahead log is corrupted


---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus-k8s
  namespace: monitoring
  
---
apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: k8s
  namespace: monitoring
  labels:
    prometheus: k8s
spec:
  replicas: <span class=m>2</span>
  version: v2.1.0
  serviceAccountName: prometheus-k8s
  serviceMonitorSelector:
    matchExpressions:
    - <span class=o>{</span>key: k8s-app, operator: Exists<span class=o>}</span>
  ruleSelector:
    matchLabels:
      role: prometheus-rulefiles
      prometheus: k8s
  resources:
    requests:
      memory: 1024Mi
  alerting:
    alertmanagers:
    - namespace: monitoring
      name: alertmanager-main
      port: web
      
---
apiVersion: v1
kind: Service
metadata:
  labels:
    prometheus: k8s
  name: prometheus-k8s
  namespace: monitoring
spec:
  ports:
  - name: web
    port: <span class=m>9090</span>
    protocol: TCP
    targetPort: web
  selector:
    prometheus: k8s
  
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: prometheus-ingress
  namespace: monitoring
spec:
  rules:
  - host: prometheus.jicki.cn
    http:
      paths:
      - backend:
          serviceName: prometheus-k8s
          servicePort: <span class=m>9090</span>



</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 导入 yaml 文件

[root@kubernetes-64 monitoring]# kubectl apply -f prometheus-k8s.yaml 
rolebinding &#34;prometheus-k8s&#34; created
rolebinding &#34;prometheus-k8s&#34; created
rolebinding &#34;prometheus-k8s&#34; created
clusterrolebinding &#34;prometheus-k8s&#34; created
role &#34;prometheus-k8s&#34; created
role &#34;prometheus-k8s&#34; created
role &#34;prometheus-k8s&#34; created
clusterrole &#34;prometheus-k8s&#34; created
configmap &#34;prometheus-k8s-rules&#34; created
serviceaccount &#34;prometheus-k8s&#34; created
prometheus &#34;k8s&#34; created
service &#34;prometheus-k8s&#34; created
ingress &#34;prometheus-ingress&#34; created


</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 查看服务

[root@kubernetes-64 monitoring]# kubectl get pods -n monitoring
NAME                                  READY     STATUS    RESTARTS   AGE
grafana-f8db675bc-5qg9j               2/2       Running   0          2h
kube-state-metrics-578778548f-8gf8d   4/4       Running   0          3h
node-exporter-9pgx5                   2/2       Running   0          3h
node-exporter-dz9kp                   2/2       Running   0          3h
node-exporter-mcd9m                   2/2       Running   0          3h
prometheus-k8s-0                      2/2       Running   0          9m
prometheus-k8s-1                      2/2       Running   0          9m
prometheus-operator-9bf5574-s7k76     1/1       Running   0          3h


</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 添加 监控 设置

vi  prometheus-k8s-service-monitor.yaml

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: kube-state-metrics
  namespace: monitoring
  labels:
    k8s-app: kube-state-metrics
spec:
  jobLabel: k8s-app
  selector:
    matchLabels:
      k8s-app: kube-state-metrics
  namespaceSelector:
    matchNames:
    - monitoring
  endpoints:
  - port: https-main
    scheme: https
    interval: 30s
    honorLabels: true
    bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    tlsConfig:
      insecureSkipVerify: true
  - port: https-self
    scheme: https
    interval: 30s
    bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    tlsConfig:
      insecureSkipVerify: true

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: node-exporter
  namespace: monitoring
  labels:
    k8s-app: node-exporter
spec:
  jobLabel: k8s-app
  selector:
    matchLabels:
      k8s-app: node-exporter
  namespaceSelector:
    matchNames:
    - monitoring
  endpoints:
  - port: https
    scheme: https
    interval: 30s
    bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    tlsConfig:
      insecureSkipVerify: true
      
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: prometheus-operator
  namespace: monitoring
  labels:
    k8s-app: prometheus-operator
spec:
  endpoints:
  - port: http
  selector:
    matchLabels:
      k8s-app: prometheus-operator
      
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: prometheus
  namespace: monitoring
  labels:
    k8s-app: prometheus
spec:
  selector:
    matchLabels:
      prometheus: k8s
  namespaceSelector:
    matchNames:
    - monitoring
  endpoints:
  - port: web
    interval: 30s
    
    
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: alertmanager
  namespace: monitoring
  labels:
    k8s-app: alertmanager
spec:
  selector:
    matchLabels:
      alertmanager: main
  namespaceSelector:
    matchNames:
    - monitoring
  endpoints:
  - port: web
    interval: 30s

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: kube-apiserver
  namespace: monitoring
  labels:
    k8s-app: apiserver
spec:
  jobLabel: component
  selector:
    matchLabels:
      component: apiserver
      provider: kubernetes
  namespaceSelector:
    matchNames:
    - default
  endpoints:
  - port: https
    interval: 30s
    scheme: https
    tlsConfig:
      caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      serverName: kubernetes
    bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: kubelet
  namespace: monitoring
  labels:
    k8s-app: kubelet
spec:
  jobLabel: k8s-app
  endpoints:
  - port: https-metrics
    scheme: https
    interval: 30s
    tlsConfig:
      insecureSkipVerify: true
    bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
  - port: https-metrics
    scheme: https
    path: /metrics/cadvisor
    interval: 30s
    honorLabels: true
    tlsConfig:
      insecureSkipVerify: true
    bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
  selector:
    matchLabels:
      k8s-app: kubelet
  namespaceSelector:
    matchNames:
    - kube-system
    

</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 导入 yaml 文件

[root@kubernetes-64 monitoring]# kubectl apply -f prometheus-k8s-service-monitor.yaml 
servicemonitor &#34;kube-state-metrics&#34; created
servicemonitor &#34;node-exporter&#34; created
servicemonitor &#34;prometheus-operator&#34; created
servicemonitor &#34;prometheus&#34; created
servicemonitor &#34;alertmanager&#34; created
servicemonitor &#34;kube-apiserver&#34; created
servicemonitor &#34;kubelet&#34; created



# 查看服务

[root@kubernetes-64 monitoring]# kubectl get servicemonitor -n monitoring
NAME                      AGE
alertmanager              23s
kube-apiserver            23s
kube-controller-manager   23s
kubelet                   23s
node-exporter             23s
prometheus                23s
prometheus-operator       23s

</code></pre></td></tr></table></div></div><h3 id=alertmanager>alertmanager</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 配置认证

vi alertmanager-secret.yaml


apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-main
  namespace: monitoring
data:
  alertmanager.yaml: Z2xvYmFsOgogIHJlc29sdmVfdGltZW91dDogNW0Kcm91dGU6CiAgZ3JvdXBfYnk6IFsnam9iJ10KICBncm91cF93YWl0OiAzMHMKICBncm91cF9pbnRlcnZhbDogNW0KICByZXBlYXRfaW50ZXJ2YWw6IDEyaAogIHJlY2VpdmVyOiAnbnVsbCcKICByb3V0ZXM6CiAgLSBtYXRjaDoKICAgICAgYWxlcnRuYW1lOiBEZWFkTWFuc1N3aXRjaAogICAgcmVjZWl2ZXI6ICdudWxsJwpyZWNlaXZlcnM6Ci0gbmFtZTogJ251bGwnCg==

</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 导入 yaml 文件

[root@kubernetes-64 monitoring]# kubectl apply -f alertmanager-secret.yaml 
secret &#34;alertmanager-main&#34; created


# 查看

[root@kubernetes-64 monitoring]# kubectl get secret -n monitoring
NAME                              TYPE                                  DATA      AGE
alertmanager-main                 Opaque                                1         28s
default-token-t6cdn               kubernetes.io/service-account-token   3         4h
grafana-credentials               Opaque                                2         3h
kube-state-metrics-token-ctnl6    kubernetes.io/service-account-token   3         3h
node-exporter-token-nflwn         kubernetes.io/service-account-token   3         3h
prometheus-k8s                    Opaque                                2         21m
prometheus-k8s-token-2dt66        kubernetes.io/service-account-token   3         21m
prometheus-operator-token-k5m47   kubernetes.io/service-account-token   3         3h

</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>vi alertmanager.yaml


---
apiVersion: monitoring.coreos.com/v1
kind: Alertmanager
metadata:
  name: main
  namespace: monitoring
  labels:
    alertmanager: main
spec:
  replicas: 3
  version: v0.13.0
  
---
apiVersion: v1
kind: Service
metadata:
  labels:
    alertmanager: main
  name: alertmanager-main
  namespace: monitoring
spec:
  ports:
  - name: web
    port: 9093
    protocol: TCP
    targetPort: web
  selector:
    alertmanager: main

---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: alertmanager-ingress
  namespace: monitoring
spec:
  rules:
  - host: alertmanager.jicki.cn
    http:
      paths:
      - backend:
          serviceName: alertmanager-main
          servicePort: 9093


</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 导入 yaml 文件

[root@kubernetes-64 monitoring]# kubectl apply -f alertmanager.yaml 
alertmanager &#34;main&#34; created
service &#34;alertmanager-main&#34; created
ingress &#34;alertmanager-ingress&#34; created



# 查看服务

[root@kubernetes-64 monitoring]# kubectl get pods -n monitoring
NAME                                  READY     STATUS    RESTARTS   AGE
alertmanager-main-0                   2/2       Running   0          2m
alertmanager-main-1                   2/2       Running   0          1m
alertmanager-main-2                   2/2       Running   0          11s
grafana-f8db675bc-5qg9j               2/2       Running   0          3h
kube-state-metrics-578778548f-8gf8d   4/4       Running   0          3h
node-exporter-9pgx5                   2/2       Running   0          3h
node-exporter-dz9kp                   2/2       Running   0          3h
node-exporter-mcd9m                   2/2       Running   0          3h
prometheus-k8s-0                      2/2       Running   0          27m
prometheus-k8s-1                      2/2       Running   0          27m
prometheus-operator-9bf5574-s7k76     1/1       Running   0          3h


</code></pre></td></tr></table></div></div><h3 id=grafana>grafana</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 创建 认证 (加密方式为 base, YWRtaW4= 等于 admin)

vi grafana-credentials.yaml

apiVersion: v1
kind: Secret
metadata:
  name: grafana-credentials
  namespace: monitoring
data:
  user: YWRtaW4=
  password: YWRtaW4=

</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 导入 yaml 文件

[root@kubernetes-64 monitoring]# kubectl apply -f grafana-credentials.yaml 
secret &#34;grafana-credentials&#34; created

</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 下载 dashboard yaml 文件

wget https://raw.githubusercontent.com/jicki/kuberneres/master/grafana-dashboards.yaml



# 导入 yaml 文件

[root@kubernetes-64 monitoring]# kubectl apply -f grafana-dashboards.yaml 
configmap &#34;grafana-dashboards-0&#34; created


</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># vi grafana.yaml

---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: grafana
  namespace: monitoring
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: grafana
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
      containers:
      - name: grafana
        image: jicki/monitoring-grafana:4.6.3-non-root
        env:
        - name: GF_AUTH_BASIC_ENABLED
          value: &#34;true&#34;
        - name: GF_AUTH_ANONYMOUS_ENABLED
          value: &#34;true&#34;
        - name: GF_SECURITY_ADMIN_USER
          valueFrom:
            secretKeyRef:
              name: grafana-credentials
              key: user
        - name: GF_SECURITY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: grafana-credentials
              key: password
        volumeMounts:
        - name: grafana-storage
          mountPath: /data
        ports:
        - name: web
          containerPort: 3000
        resources:
          requests:
            memory: 100Mi
            cpu: 100m
          limits:
            memory: 200Mi
            cpu: 200m
      - name: grafana-watcher
        image: jicki/grafana-watcher:v0.0.8
        args:
          - &#39;--watch-dir=/var/grafana-dashboards-0&#39;
          - &#39;--grafana-url=http://localhost:3000&#39;
        env:
        - name: GRAFANA_USER
          valueFrom:
            secretKeyRef:
              name: grafana-credentials
              key: user
        - name: GRAFANA_PASSWORD
          valueFrom:
            secretKeyRef:
              name: grafana-credentials
              key: password
        resources:
          requests:
            memory: &#34;16Mi&#34;
            cpu: &#34;50m&#34;
          limits:
            memory: &#34;32Mi&#34;
            cpu: &#34;100m&#34;
        volumeMounts:
        - name: grafana-dashboards-0
          mountPath: /var/grafana-dashboards-0
      volumes:
      - name: grafana-storage
        emptyDir: {}
      - name: grafana-dashboards-0
        configMap:
          name: grafana-dashboards-0
          
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app: grafana
spec:
  ports:
  - port: 3000
    protocol: TCP
    targetPort: web
  selector:
    app: grafana
    
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: grafana-ingress
  namespace: monitoring
spec:
  rules:
  - host: grafana.jicki.cn
    http:
      paths:
      - backend:
          serviceName: grafana
          servicePort: 3000



</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 导入 yaml 文件

[root@kubernetes-64 monitoring]# kubectl apply -f grafana.yaml 
deployment &#34;grafana&#34; created
service &#34;grafana&#34; created
ingress &#34;grafana-ingress&#34; created






# 查看

[root@kubernetes-64 monitoring]# kubectl get pods -n monitoring
NAME                                  READY     STATUS    RESTARTS   AGE
grafana-f8db675bc-5qg9j               2/2       Running   0          2h
kube-state-metrics-578778548f-8gf8d   4/4       Running   0          2h
node-exporter-9pgx5                   2/2       Running   0          2h
node-exporter-dz9kp                   2/2       Running   0          2h
node-exporter-mcd9m                   2/2       Running   0          2h
prometheus-operator-9bf5574-s7k76     1/1       Running   0          2h


</code></pre></td></tr></table></div></div><h2 id=页面展示>页面展示</h2><p><img class=lazyload src=/svg/loading.min.svg data-src=https://jicki.cn/img/posts/grafana/grafana1.png data-srcset="https://jicki.cn/img/posts/grafana/grafana1.png, https://jicki.cn/img/posts/grafana/grafana1.png 1.5x, https://jicki.cn/img/posts/grafana/grafana1.png 2x" data-sizes=auto alt=https://jicki.cn/img/posts/grafana/grafana1.png title=1>
<img class=lazyload src=/svg/loading.min.svg data-src=https://jicki.cn/img/posts/grafana/grafana2.png data-srcset="https://jicki.cn/img/posts/grafana/grafana2.png, https://jicki.cn/img/posts/grafana/grafana2.png 1.5x, https://jicki.cn/img/posts/grafana/grafana2.png 2x" data-sizes=auto alt=https://jicki.cn/img/posts/grafana/grafana2.png title=2>
<img class=lazyload src=/svg/loading.min.svg data-src=https://jicki.cn/img/posts/grafana/grafana3.png data-srcset="https://jicki.cn/img/posts/grafana/grafana3.png, https://jicki.cn/img/posts/grafana/grafana3.png 1.5x, https://jicki.cn/img/posts/grafana/grafana3.png 2x" data-sizes=auto alt=https://jicki.cn/img/posts/grafana/grafana3.png title=3>
<img class=lazyload src=/svg/loading.min.svg data-src=https://jicki.cn/img/posts/grafana/grafana4.png data-srcset="https://jicki.cn/img/posts/grafana/grafana4.png, https://jicki.cn/img/posts/grafana/grafana4.png 1.5x, https://jicki.cn/img/posts/grafana/grafana4.png 2x" data-sizes=auto alt=https://jicki.cn/img/posts/grafana/grafana4.png title=4>
<img class=lazyload src=/svg/loading.min.svg data-src=https://jicki.cn/img/posts/grafana/grafana5.png data-srcset="https://jicki.cn/img/posts/grafana/grafana5.png, https://jicki.cn/img/posts/grafana/grafana5.png 1.5x, https://jicki.cn/img/posts/grafana/grafana5.png 2x" data-sizes=auto alt=https://jicki.cn/img/posts/grafana/grafana5.png title=5>
{% endraw %}</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2018-02-01</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/prometheus-monitoring/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://jicki.cn/prometheus-monitoring/ data-title="prometheus monitoring" data-via=jicki234><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://jicki.cn/prometheus-monitoring/><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://jicki.cn/prometheus-monitoring/ data-title="prometheus monitoring" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://jicki.cn/prometheus-monitoring/ data-title="prometheus monitoring"><i data-svg-src=/lib/simple-icons/icons/line.min.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://jicki.cn/prometheus-monitoring/ data-title="prometheus monitoring"><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=https://jicki.cn/prometheus-monitoring/ data-title="prometheus monitoring" data-description="prometheus monitoring"><i data-svg-src=/lib/simple-icons/icons/myspace.min.svg></i></a><a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://jicki.cn/prometheus-monitoring/ data-title="prometheus monitoring" data-description="prometheus monitoring"><i class="fab fa-blogger fa-fw"></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://jicki.cn/prometheus-monitoring/ data-title="prometheus monitoring"><i class="fab fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/kubernetes-1.9.1/ class=prev rel=prev title="kubernetes 1.9.1"><i class="fas fa-angle-left fa-fw"></i>kubernetes 1.9.1</a>
<a href=/kubernetes-jenkins/ class=next rel=next title="kubernetes jenkins">kubernetes jenkins<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.73.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://jicki.cn target=_blank>小炒肉</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a href=http://beian.miit.gov.cn target=_blank>粤ICP备20055633号</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":200},"comment":{"valine":{"appId":"1LTTCvDe4Nt8XSdFzejtUsVF-gzGzoHsz","appKey":"cvpPM7sbgOw0pTXbh6YVKrjc","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"zh-cn","pageSize":10,"placeholder":"你的评论 ...","recordIP":true,"visitor":true}},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>