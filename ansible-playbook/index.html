<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Ansible 从入门到放弃 - 小炒肉</title><meta name=Description content="Ansible 从入门到放弃"><meta property="og:title" content="Ansible 从入门到放弃"><meta property="og:description" content="Ansible 从入门到放弃"><meta property="og:type" content="article"><meta property="og:url" content="https://jicki.cn/ansible-playbook/"><meta property="og:image" content="https://jicki.cn/logo.png"><meta property="article:published_time" content="2020-08-10T00:00:00+00:00"><meta property="article:modified_time" content="2020-08-10T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jicki.cn/logo.png"><meta name=twitter:title content="Ansible 从入门到放弃"><meta name=twitter:description content="Ansible 从入门到放弃"><meta name=application-name content="小炒肉"><meta name=apple-mobile-web-app-title content="小炒肉"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/images/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://jicki.cn/ansible-playbook/><link rel=prev href=https://jicki.cn/gitops-kubernetes/><link rel=next href=https://jicki.cn/helm-v2/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Ansible 从入门到放弃","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/jicki.cn\/ansible-playbook\/"},"genre":"posts","keywords":"linux, ansible","wordcount":9627,"url":"https:\/\/jicki.cn\/ansible-playbook\/","datePublished":"2020-08-10T00:00:00+00:00","dateModified":"2020-08-10T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"小炒肉"},"description":"Ansible 从入门到放弃"}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=小炒肉>小炒肉</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=小炒肉>小炒肉</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/>文章</a><a class=menu-item href=/tags/>标签</a><a class=menu-item href=/categories/>分类</a><a class=menu-item href=/about/>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Ansible 从入门到放弃</h1><h2 class=single-subtitle>Ansible 从入门到放弃</h2><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://jicki.cn title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>小炒肉</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/linux/><i class="far fa-folder fa-fw"></i>linux</a>&nbsp;<a href=/categories/ansible/><i class="far fa-folder fa-fw"></i>ansible</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-08-10>2020-08-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 9627 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 20 分钟&nbsp;<span id=/ansible-playbook/ class=leancloud_visitors data-flag-title="Ansible 从入门到放弃">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#ansible-简介>ansible 简介</a></li><li><a href=#ansible-架构>ansible 架构</a></li><li><a href=#ansible-安装>ansible 安装</a></li><li><a href=#etcansiblehosts>/etc/ansible/hosts</a></li><li><a href=#etcansibleansiblecfg>/etc/ansible/ansible.cfg</a></li><li><a href=#ansible-相关操作>ansible 相关操作</a><ul><li><a href=#ansible-执行过程>ansible 执行过程</a></li><li><a href=#ansible-doc>ansible-doc</a></li><li><a href=#ansible-1>ansible</a></li><li><a href=#ansible-常用模块>ansible 常用模块</a><ul><li><a href=#command-模块>Command 模块</a></li><li><a href=#shell-模块>shell 模块</a></li><li><a href=#script-模块>Script 模块</a></li><li><a href=#copy-模块>Copy 模块</a></li><li><a href=#fetch-模块>Fetch 模块</a></li><li><a href=#file-模块>File 模块</a></li><li><a href=#cron-模块>Cron 模块</a></li><li><a href=#yum-模块>Yum 模块</a></li><li><a href=#service-模块>Service 模块</a></li><li><a href=#user-模块>User 模块</a></li><li><a href=#group-模块>Group 模块</a></li></ul></li><li><a href=#ansible-galaxy>ansible-galaxy</a></li><li><a href=#ansible-playbook>ansible playbook</a><ul><li><a href=#playbook-与-yaml-描述>playbook 与 YAML 描述</a></li><li><a href=#playbook-核心元素>playbook 核心元素</a></li><li><a href=#ansible-playbook-命令>ansible-playbook 命令</a></li><li><a href=#ansible-playbook-变量>ansible-playbook 变量</a></li><li><a href=#ansible-playbook-template>ansible-playbook template</a></li><li><a href=#example---tasks>Example - tasks</a></li><li><a href=#example---handles>Example - handles</a></li><li><a href=#example---tags>Example - tags</a></li></ul></li><li><a href=#ansible-vault>ansible-vault</a></li><li><a href=#ansible-console>ansible-console</a></li><li><a href=#ansible-roles>ansible Roles</a><ul><li><a href=#example---roles>Example - roles</a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><figure><img src=/img/posts/ansible/ansible.png></figure><h1 id=前言>前言</h1><p><strong>运维自动化的发展历程以及技术应用</strong></p><ol><li>本地部署 <code>On-Premises</code> 如下都需要自己 <code>部署/配置</code> 以及维护。</li></ol><ul><li><code>Application</code></li><li><code>Data</code></li><li><code>Runtime</code></li><li><code>Middleware</code></li><li><code>OS</code></li><li><code>Virtualization</code></li><li><code>Servers</code></li><li><code>Storage</code></li><li><code>NetWorking</code></li></ul><ol start=2><li>基础设施既服务 ( 如 阿里云 ) <code>IaaS</code> - <code>Infrastructure as a Service</code> 如下需要自己 <code>部署/配置</code> 以及维护。</li></ol><ul><li><code>Application</code></li><li><code>Data</code></li><li><code>Runtime</code></li><li><code>Middleware</code></li><li><code>OS</code></li></ul><ol start=3><li>平台既服务 ( 如 阿里云- ACK 容器服务 ) <code>PaaS</code> - <code>Platform as a Service</code> 如下需要自己 <code>部署/配置</code> 以及维护。</li></ol><ul><li><code>Application</code></li><li><code>Data</code></li></ul><ol start=4><li>软件既服务 ( 如 各类软件 微信、钉钉、邮箱 ) <code>SaaS</code> - <code>Software as a Service</code> 所有的服务软件都不需要自己维护, 直接使用既可。</li></ol><h1 id=ansible>ansible</h1><h2 id=ansible-简介>ansible 简介</h2><blockquote><p>ansible 是基于 <code>python2-paramiko</code> 模块开发的自动化运维工具。 实现了批量系统配置, 批量程序部署, 批量运行命令等功能。<code>ansible</code> 是基于模块工作的, 本身没有批量部署的能力。真正具有批量部署的是 <code>ansible</code> 所运行的模块, <code>ansible</code> 只是提供了一种框架。</p></blockquote><p><strong>ansible 集合了众多运维工具（ pupet、cfengine、chef、func、fabric、saltstack ）的优点</strong></p><ul><li><p>ansible 发展史</p><ul><li><p>ansible 作者是 <code>Michael DeHaan</code> 同时他也是 <code>Cobbler 与 Func</code> 作者。</p></li><li><p>2012-03-09 发布 0.0.1 版本。</p></li><li><p>2015-10-17 被 <code>Red Hat</code> 收购。</p></li></ul></li><li><p>ansible 特性</p><ul><li><p>基于 Python 开发</p></li><li><p>模块化: 调用特定的模块(如: Paramiko、PyYAML、jinja2 等), 完成特定的任务。</p></li><li><p>支持自定义模块</p></li><li><p>部署简单, 基于<code>Linux</code>内置的 <code>Python</code> 、<code>Open-SSH</code> 和另一个 <code>agentless</code> 组件.</p></li><li><p>支持 <code>PlayBook</code> 编排任务</p></li><li><p>幂等性: 任务重复执行等于只执行一次, 不会重复执行多次相同命令。</p></li><li><p>无需代理不依赖PKI.</p></li><li><p>支持多语言模块编写.</p></li><li><p><code>YAML</code>格式编排任务,支持丰富的数据结构.</p></li></ul></li></ul><h2 id=ansible-架构>ansible 架构</h2><figure><img src=/img/posts/ansible/ansible-jg.png></figure><figure><img src=/img/posts/ansible/ansible-yl.png></figure><ul><li><p><code>ansible</code> 主要组成部分:</p><ul><li><p><code>ansible playbooks</code>: 任务剧本(任务集), 通过编排定义<code>ansible</code>任务集合的配置文件, 由<code>ansible</code> 顺序依次执行, 文件通常是 <code>JSON</code>格式的<code>YML</code>文件。</p></li><li><p><code>Roles</code>: 角色, 多个 <code>ansilbe playbooks</code> 的集合.</p></li><li><p><code>Inventory</code>: <code>ansible</code> 管理主机的清单 默认为 <code>/etc/ansible/hosts</code> 文件。</p></li><li><p><code>Modules</code>: <code>ansible</code> 执行命令的功能模块, 一般为<code>ansible</code>内置核心模块, 也可以自定义第三方模块.</p></li><li><p><code>plugins</code>: <code>ansible</code> 功能插件, 是功能模块的补充. 如: 连接类型插件、循环插件、变量插件、过滤插件等等.</p></li><li><p><code>Api</code>: 提供第三方程序调用的开放接口.</p></li><li><p><code>ansible</code>: <code>ansible</code> 的客户端命令工具. 执行 <code>ansible</code> 命令的主要程序.</p><ul><li><p><code>Ad-Hoc</code> 用户执行单条或多条的 <code>ansible</code> 命令.</p></li><li><p><code>ansible playbook</code> 通过编写编排文件 <code>ansible</code> 执行命令集合.</p><ul><li><code>ansible playbook</code> 执行过程 -> 将编排好的任务写入 <code>ansible-playbook</code> 编排文件中 -> 通过 <code>ansible-playbook</code> 命令拆分任务集合, 然后按照预定的顺序逐条执行<code>ansible</code> 命令.</li></ul></li></ul></li></ul></li></ul><h2 id=ansible-安装>ansible 安装</h2><ul><li><p><code>ansible</code> 安装很简单, 也有很多种方式.</p><ul><li><p>安装 <code>epel</code> 源以后 执行 <code>yum -y install ansible</code></p></li><li><p>使用 源码包 进行 安装</p></li><li><p>通过 <code>git clone https://github.com/ansible/ansible</code> 以后进行安装</p></li><li><p>使用 pip 命令安装</p></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>
<span class=o>[</span>root@jicki ~<span class=o>]</span><span class=c1># ansible --version</span>
ansible 2.9.10
  config <span class=nv>file</span> <span class=o>=</span> /etc/ansible/ansible.cfg
  configured module search <span class=nv>path</span> <span class=o>=</span> <span class=o>[</span>u<span class=s1>&#39;/root/.ansible/plugins/modules&#39;</span>, u<span class=s1>&#39;/usr/share/ansible/plugins/modules&#39;</span><span class=o>]</span>
  ansible python module <span class=nv>location</span> <span class=o>=</span> /usr/lib/python2.7/site-packages/ansible
  executable <span class=nv>location</span> <span class=o>=</span> /usr/bin/ansible
  python <span class=nv>version</span> <span class=o>=</span> 2.7.5 <span class=o>(</span>default, Apr  <span class=m>2</span> 2020, 13:16:51<span class=o>)</span> <span class=o>[</span>GCC 4.8.5 <span class=m>20150623</span> <span class=o>(</span>Red Hat 4.8.5-39<span class=o>)]</span>

</code></pre></td></tr></table></div></div><ul><li><p><code>ansible</code> 相关说明</p><ul><li><p><code>/etc/ansible/ansible.cfg</code> 主配置文件, 配置<code>ansible</code>的工作特性.</p></li><li><p><code>/etc/ansible/hosts</code> 主机清单.</p></li><li><p><code>/etc/ansible/roles/</code> 存放(roles)角色的目录.</p></li><li><p><code>/usr/bin/ansible</code> 二进制执行文件, <code>ansible</code> 主程序.</p></li><li><p><code>/usr/bin/ansilbe-doc</code> 配置文档, 模块功能查看工具.</p></li><li><p><code>/usr/bin/ansible-galaxy</code> 用于上传/下载 <code>roles</code> 模块到官方平台的工具.</p></li><li><p><code>/usr/bin/ansible-playbook</code> 自动化任务、编排剧本工具<code>/usr/bin/ansible-pull</code> 远程执行命令的工具.</p></li><li><p><code>/usr/bin/ansible-vault</code> 文件(如: playbook 文件) 加密工具.</p></li><li><p><code>/usr/bin/ansible-console</code> 基于 界面的用户交互执行工具.</p></li></ul></li></ul><h2 id=etcansiblehosts>/etc/ansible/hosts</h2><blockquote><p>创建秘钥 <code>ssh-keygen -t rsa -f ~/.ssh/id_rsa -C "jicki"</code></p><p>拷贝秘钥到其他被控端 <code>ssh-copy-id ip</code></p></blockquote><p><strong>主机清单文件</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=c1># #号为注释</span>

<span class=c1># 单主机 直接写入 ip 或 nameserver</span>
192.168.168.10

<span class=c1># 非标准22端口可直接用 : 填入</span>
192.168.168.10:999
db1.example.com:999


<span class=c1># []包含的为主机组 如下</span> 
<span class=o>[</span>webservers<span class=o>]</span>
192.168.168.10
192.168.168.11
192.168.168.12
192.168.168.13


<span class=c1># 主机也支持 nameserver 如下</span>
<span class=o>[</span>dbservers<span class=o>]</span>
db1.example.com
db2.example.com
db3.example.com
db4.example.com

<span class=c1># 主机支持 [1:10] 类型的多主机 如下</span> 
<span class=o>[</span>docker<span class=o>]</span>
<span class=c1># 等同于 192.168.168.10 ~ 192.168.168.120</span>
192.168.168.1<span class=o>[</span>0:20<span class=o>]</span>


<span class=c1># 主机也支持 [a:z] 类型的 nameserver 如下</span>
<span class=o>[</span>kubernetes<span class=o>]</span>
<span class=c1># 等同于 master-a ~ master-c</span>
master-<span class=o>[</span>a:c<span class=o>]</span>
<span class=c1># 等同于 node-c ~ node-g</span>
node-<span class=o>[</span>c:g<span class=o>]</span>

</code></pre></td></tr></table></div></div><ul><li><p>操作主机</p><ul><li><p><code>-m</code> 为指定模块 <code>ping</code> 为 模块名称</p></li><li><p><code>-k</code> 为密码方式, 默认为 ssh-key 免密码方式登录</p></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=c1># ansible 通过 单主机进行操作 ( -k 为用户密码方式, 默认为 ssh-key )</span>
ansible 192.168.168.10 -m ping -k


<span class=c1># ansible 通过 &#39;:&#39; 组合进行操作</span>
ansible <span class=s2>&#34;192.168.168.10:192.168.168.20&#34;</span> -m ping -k


<span class=c1># ansible 通过 通配符加主机 进行操作</span>
ansible 192.168.168.* -m ping -k


<span class=c1># ansible 通过 hosts 组名称 进行操作</span>
ansible webservers -m ping -k


<span class=c1># ansible 通过 &#39;:&#39; 组合组进行操作</span>
ansible <span class=s1>&#39;webservers:dbservers&#39;</span> -m ping -k


<span class=c1># ansible 通过 通配符 进行操作</span>
ansible <span class=s1>&#39;*servers&#39;</span> -m ping -k


<span class=c1># ansible 通过 &#39;:&amp;&#39; 逻辑与 (两个组中都包含的主机)</span>
ansible <span class=s1>&#39;webservers:&amp;dbservers&#39;</span> -m ping -k


<span class=c1># ansible 通过 &#39;:!&#39; 逻辑非 (在webservers 但不在 dbservers的主机)</span>
ansible <span class=s1>&#39;webservers:!dbservers&#39;</span> -m ping -k


<span class=c1># ansible 也支持多逻辑的组合</span>
ansible <span class=s1>&#39;webservers:dbserver:&amp;appserver:!ftpservers&#39;</span> -m ping -k


<span class=c1># ansible 也支持正则表达式</span>
ansible <span class=s1>&#39;~(web|db)serever&#39;</span> -m ping -k


<span class=c1># ansible 通过 all 对 hosts 清单下所有主机进行操作</span>
ansible all -m ping -k


<span class=c1># ansible 通过 通配符 对 hosts 清单下所有主机进行操作</span>
ansible <span class=s1>&#39;*&#39;</span> -m ping -k

</code></pre></td></tr></table></div></div><ul><li>输出结果</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@jicki opt<span class=o>]</span><span class=c1># ansible all -m ping</span>
10.0.3.13 <span class=p>|</span> <span class=nv>SUCCESS</span> <span class=o>=</span>&gt; <span class=o>{</span>
    <span class=s2>&#34;ansible_facts&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;discovered_interpreter_python&#34;</span>: <span class=s2>&#34;/usr/bin/python&#34;</span>
    <span class=o>}</span>,
    <span class=s2>&#34;changed&#34;</span>: false,
    <span class=s2>&#34;ping&#34;</span>: <span class=s2>&#34;pong&#34;</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><h2 id=etcansibleansiblecfg>/etc/ansible/ansible.cfg</h2><p><strong>ansible 主配置文件</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=c1># defaults 为默认配置</span>
<span class=o>[</span>defaults<span class=o>]</span>

<span class=c1># 主机清单的路径, 默认为如下</span>
<span class=c1>#inventory      = /etc/ansible/hosts</span>

<span class=c1># 模块存放的路径</span> 
<span class=c1>#library        = /usr/share/my_modules/</span>

<span class=c1># utils 模块存放路径</span>
<span class=c1>#module_utils   = /usr/share/my_module_utils/</span>

<span class=c1># 远程主机脚本临时存放目录</span>
<span class=c1>#remote_tmp     = ~/.ansible/tmp</span>

<span class=c1># 管理节点脚本临时存放目录</span> 
<span class=c1>#local_tmp      = ~/.ansible/tmp</span>

<span class=c1># 插件的配置文件路径</span>
<span class=c1>#plugin_filters_cfg = /etc/ansible/plugin_filters.yml</span>

<span class=c1># 执行并发数</span>
<span class=c1>#forks          = 5</span>

<span class=c1># 异步任务查询间隔 单位秒</span>
<span class=c1>#poll_interval  = 15</span>

<span class=c1># sudo 指定用户</span>
<span class=c1>#sudo_user      = root</span>

<span class=c1># 运行 ansible 是否提示输入sudo密码</span>
<span class=c1>#ask_sudo_pass = True</span>

<span class=c1># 运行 ansible 是否提示输入密码 同 -k</span>
<span class=c1>#ask_pass      = True</span>

<span class=c1># 远程传输模式</span>
<span class=c1>#transport      = smart</span>

<span class=c1># SSH 默认端口</span>
<span class=c1>#remote_port    = 22</span>

<span class=c1># 模块运行默认语言环境</span>
<span class=c1>#module_lang    = C</span>


<span class=c1># roles 存放路径</span>
<span class=c1>#roles_path    = /etc/ansible/roles</span>

<span class=c1># 不检查 /root/.ssh/known_hosts 文件 建议取消</span>
<span class=c1>#host_key_checking = False</span>


<span class=c1># ansible 操作日志路径 建议打开</span>
<span class=c1>#log_path = /var/log/ansible.log</span>


</code></pre></td></tr></table></div></div><h2 id=ansible-相关操作>ansible 相关操作</h2><h3 id=ansible-执行过程>ansible 执行过程</h3><ol><li><p>加载配置文件 <code>/etc/ansible/ansible.cfg</code>.</p></li><li><p>加载对应的模块文件.</p></li><li><p>通过 ansible 将模块或命令生成对应的临时 <code>py</code> 文件, 并将该临时文件 传输至远程服务器的对应 执行用户 临时目录下 <code>$HOME/.ansible/tmp/ansible-tmp-2123/xxx.py</code> >文件.</p></li><li><p>对临时 <code>py</code> 文件授权 ( chmod u+x xx.py ).</p></li><li><p>执行 <code>py</code> 文件,并返回执行结果.</p></li><li><p>删除临时的 <code>py</code> 文件, sleep 0 退出.</p></li></ol><hr><ul><li><p>执行状态</p><ul><li><p>绿色: 执行操作成功并且不需要做更改的操作.</p></li><li><p>黄色: 执行操作成功, 并且对目标主机进行了变更操作. 如 更改文件内容, 重启服务, 删除文件等.</p></li><li><p>红色: 执行操作失败.</p></li></ul></li></ul><hr><h3 id=ansible-doc>ansible-doc</h3><ul><li><p>显示模块帮助</p><ul><li><p><code>-l, --list</code> 列出可用模块</p></li><li><p><code>-s, --snippet</code> 显示指定模块的 <code>playbook</code> 片段</p></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=c1># 例子</span>

ansible-doc -l

ansible-doc ping

ansible-doc -s ping

</code></pre></td></tr></table></div></div><hr><h3 id=ansible-1>ansible</h3><ul><li><p><code>ansible &lt;host-pattern> [-m module_name] [-a args]</code></p><ul><li><p><code>host-pattern</code>: 主机ip、主机名、主机组。</p></li><li><p><code>module_name</code>: 模块的名称。如果不写 默认为 <code>-m command</code> 。</p></li><li><p><code>args</code>: 模块的参数, 需要加上 <code>-a</code> 进行指定模块的参数。如: `ansible all -a &lsquo;hostname&rsquo;</p></li><li><p><code>-v、-vv、-vvv</code>: 显示详细的命令输出日志, v 越多越详细。如: <code>ansible all -m ping -vvv</code></p></li><li><p><code>--list</code>: 显示主机的列表。 如: <code>ansible all --list</code></p></li><li><p><code>-k / --ask-pass</code>: 提示输入ssh连接密码, 默认为 ssh-key 认证。如: <code>ansible all -m ping -k</code></p></li><li><p><code>-K / --ask-become-pass</code>: 提示输入 sudo 的密码。</p></li><li><p><code>-C / --check</code>: 检查命令操作, 并不会执行。如: <code>ansible all -m ping -C</code></p></li><li><p><code>-T / --timeout</code>: 执行命令的超时时间, 默认为 10s。如: <code>ansible all -m ping -T=2</code></p></li><li><p><code>-u / --user</code>: 执行远程操作的用户. 如: <code>ansible all -m ping -u=root</code></p></li><li><p><code>-b / --become</code>: 代替旧版的 <code>sudo</code> 切换。</p></li></ul></li></ul><h3 id=ansible-常用模块>ansible 常用模块</h3><blockquote><p>截止 2020-08-10 ansible 模块为 3387 个.</p></blockquote><hr><h4 id=command-模块>Command 模块</h4><ul><li><p><code>command</code> 模块: 在远程主机上执行命令, 支持条件判断. ansible 默认模块, 可忽略 <code>-m</code> 参数直接操作. 注: <code>command</code> 模块 不支持 <code>$VARNAME</code> <code>&lt;</code> <code>></code> <code>|</code> <code>;</code> <code>&</code> 等符号.</p><ul><li><p>`ansible all -m command -a &lsquo;systemctl stop docker&rsquo;</p></li><li><p>`ansible all -a &lsquo;docker ps -a&rsquo;</p></li><li><p><code>ansible all -a 'removes=/opt/ansible df -h'</code></p><ul><li>如果 /opt/ansible 不存在 就不执行 <code>df -h</code> 操作, 如果 /opt/ansible 存在, 就执行 <code>df -h</code> 操作.</li></ul></li><li><p><code>ansible all -a 'creates=/opt/ansible df -h'</code></p><ul><li>如果 /opt/ansible 不存在 就执行 <code>df -h</code> 操作, 如果存在 /opt/ansible 就不执行 <code>df -h</code> 操作.</li></ul></li><li><p><code>ansible all -a 'chdir=/opt ls -lt'</code></p><ul><li>切换目录, 等于 <code>cd /opt && ls -lt</code> 操作</li></ul></li></ul></li></ul><hr><h4 id=shell-模块>shell 模块</h4><ul><li><p><code>shell</code> 模块: shell 模块支持 command 所有的操作, 而且支持 <code>$VARNAME</code> <code>&lt;</code> <code>></code> <code>|</code> <code>;</code> <code>&</code> 等符号操作.</p><ul><li><code>ansible all -m shell -a 'ps -ef|grep docker'</code></li></ul></li></ul><hr><h4 id=script-模块>Script 模块</h4><ul><li><p><code>script</code> 模块: 执行脚本的命令. 只需要调用 ansible 本机上的脚本就可以在所有的选择主机上面执行脚本中的内容.</p><ul><li><p><code>ansible all -m script -a '/root/1.sh'</code></p><ul><li><code>/root/1.sh</code> 脚本只需要在 ansible 管理主机上既可.</li></ul></li></ul></li></ul><hr><h4 id=copy-模块>Copy 模块</h4><ul><li><p><code>copy</code> 模块: 拷贝文件到远程主机.</p><ul><li><p>`ansible all -m copy -a &lsquo;src=/root/xxx.txt dest=/root/1.txt backup=yes&rsquo;</p><ul><li><p><code>src</code>: 原文件路径</p></li><li><p><code>dest</code>: 目标主机路径</p></li><li><p><code>backup</code>: 如果目标主机文件存在, 会先进行备份, 再进行覆盖.</p></li></ul></li><li><p><code>ansible all -m copy -a 'src=/root/1.txt dest=/root/2.txt mode=0644 owner=jicki group=jicki'</code></p><ul><li><p><code>mode</code>: 修改权限</p></li><li><p><code>owner</code>: 修改用户</p></li><li><p><code>group</code>: 修改用户组</p></li></ul></li><li><p><code>ansible all -m copy -a 'content="hello\nworld\n" dest=/root/2.txt'</code></p><ul><li><code>content</code>: 将内容写入到目标文件中.</li></ul></li></ul></li></ul><hr><h4 id=fetch-模块>Fetch 模块</h4><ul><li><p><code>fetch</code> 模块: 将远程主机的文件, 下载到本机中, 下载成功会存放在以 主机 IP/名称 的文件夹中, 会包含原文件的整体路径. (只能下载单个文件, 不支持目录, 可先打包成压缩包, 再进行下载)</p><ul><li><p><code>ansible all -m fetch -a 'src=/var/log/messages dest=/root/'</code></p><ul><li><p><code>src</code>: 远程主机的文件路径</p></li><li><p><code>dest</code>: 本机的文件夹路径</p></li></ul></li></ul></li></ul><hr><h4 id=file-模块>File 模块</h4><ul><li><p><code>file</code> 模块: 操作远程主机的文件. 如: 创建文件 <code>touch</code>、 删除文件 <code>absent</code> 等</p><ul><li><p><code>ansible all -m file -a 'name=/root/1.txt owner=jicki group=jicki mode=0755 recurse=yes'</code></p><ul><li><p><code>mode</code>: 修改权限</p></li><li><p><code>owner</code>: 修改用户</p></li><li><p><code>group</code>: 修改用户组</p></li><li><p><code>recurse=yes</code>: 递归, 指对目录递归授权.</p></li></ul></li><li><p><code>ansible all -m file -a 'name=/root/1.txt state=touch'</code></p><ul><li><p><code>dest</code>、<code>name</code>、<code>path</code>: 指定远程主机的文件路径.</p></li><li><p><code>state</code>: 文件操作类型. ( 默认为 <code>absent</code> )</p><ul><li><code>touch</code>: 创建空文件.</li><li><code>directory</code>: 创建文件夹.</li><li><code>absent</code>: 递归删除文件夹/文件.</li><li><code>link</code>: 创建软连接.</li></ul></li></ul></li><li><p><code>ansible all -m file -a 'src=/root/1.txt dest=/root/1.link state=link'</code></p><ul><li><code>src</code>: 源文件, 这里用于指定 软连接的源文件.</li></ul></li></ul></li></ul><hr><h4 id=cron-模块>Cron 模块</h4><ul><li><p><code>cron</code> 模块: 为远程主机添加定时任务.</p><ul><li><p><code>ansible all -m cron -a 'weekday=1-5 job="echo </code>date<code> >> /root/1.txt" name=echocron'</code></p><ul><li><p><code>day</code>: 表示 天. 支持 ( 1-31, *, */2 ) 写法</p></li><li><p><code>hour</code>: 表示 小时. 支持 ( 0-23, *, */2 ) 写法</p></li><li><p><code>minute</code>: 表示 分钟. 支持 ( 0-59, *, */2 ) 写法</p></li><li><p><code>month</code>: 表示 月. 支持 ( 1-12, *, */2 ) 写法</p></li><li><p><code>weekday</code>: 表示 星期. 支持 ( 0-6, Sunday-Saturday, * )写法</p></li><li><p><code>job</code>: 表示 计划任务的内容.</p></li><li><p><code>name</code>: 表示 计划任务名称. 相同的计划任务名称会覆盖.</p></li></ul></li><li><p><code>ansible all -m cron -a 'disabled=true job="echo </code>date<code> >> /root/1.txt" name=echocron'</code></p><ul><li><p><code>disabled</code>: 只是注释掉计划任务 并非删除.</p><ul><li><code>true</code>、<code>yes</code> : 关闭计划任务. 关闭计划任务 必须指定 <code>job</code> 和 <code>name</code>.</li><li><code>false</code>、<code>no</code>: 重新打开计划任务. 必须指定 <code>job</code> 和 <code>name</code>.</li></ul></li></ul></li><li><p><code>ansible all -m cron -a 'name=echocron state=absent'</code></p><ul><li><code>state</code><ul><li><code>absent</code> 删除计划任务. 删除计划任务 只需要指定 <code>name</code> 既可.</li></ul></li></ul></li></ul></li></ul><hr><h4 id=yum-模块>Yum 模块</h4><ul><li><p><code>yum</code> 模块: 利用 yum 操作软件包, 如 安装、查询、卸载等.</p><ul><li><p><code>ansible all -m yum -a 'name=sysstat state=present'</code></p></li><li><p><code>ansible all -m yum -a 'name=/tmp/sysstat-12.3.3-1.2.x86_64.rpm'</code></p></li><li><p><code>ansible all -m yum -a 'name=sysstat update_cache=yes disable_gpg_check=yes'</code></p><ul><li><p><code>name</code>: 软件包的名称, 或者rpm包, 远程服务器必须存在 rpm 包. 安装多个软件使用 <code>,</code> 号隔开. 如 <code>name=sysstat,mysql,redis</code></p></li><li><p><code>state</code></p><ul><li><code>present</code>、<code>installed</code>: 安装软件. 默认为 <code>present</code>, 可不填 <code>state=present</code> .</li><li><code>absent</code>、<code>removed</code>: 卸载/删除软件.</li></ul></li><li><p><code>update_cache=yes</code>: 更新 yum 缓存后 在安装软件.</p></li><li><p><code>disable_gpg_check=yes</code>: 禁用 gpg 检查.</p></li></ul></li><li><p><code>ansible all -m yum -a 'list=installed'</code></p><ul><li><p><code>list</code>: 列出安装包.</p><ul><li><code>installed</code>: 已安装的软件</li><li><code>updates</code>: 可以升级的软件</li><li><code>available</code>: 可以安装的软件</li><li><code>repos</code>: yum 源</li></ul></li></ul></li></ul></li></ul><hr><h4 id=service-模块>Service 模块</h4><ul><li><p><code>service</code>: 软件服务管理模块. 启动、关闭、重启 等操作.</p><ul><li><p><code>ansible all -m service -a 'name=vsftpd state=started enabled=yes'</code></p><ul><li><p><code>name</code>: 服务名称.</p></li><li><p><code>state</code></p><ul><li><code>started</code>: 启动服务.</li><li><code>stopped</code>: 停止服务.</li><li><code>restarted</code>: 重启服务.</li><li><code>reloaded</code>: 重新加载配置.</li></ul></li><li><p><code>enabled</code>: 设置是否开机启动.</p><ul><li><code>yes、true</code></li><li><code>no、false</code></li></ul></li></ul></li></ul></li></ul><hr><h4 id=user-模块>User 模块</h4><ul><li><p><code>user</code>: 管理系统用户的模块</p><ul><li><p><code>ansible all -m user -a 'name=nginx shell=/sbin/nologin system=yes home=/var/nginx groups=root uid=80 comment="nginx service user"'</code></p><ul><li><p><code>name</code>: 用户名</p></li><li><p><code>shell</code>: 指定用户的 <code>shell</code> 类型</p></li><li><p><code>system</code>: 指定是否为 系统用户</p></li><li><p><code>home</code>: 指定用户额外的home目录,默认为 /home/用户名 .</p></li><li><p><code>groups</code>: 用户额外的 <code>groups</code> 组.</p></li><li><p><code>uid</code>: 指定用户的 uid 号.</p></li><li><p><code>comment</code>: 用户额外说明.</p></li></ul></li><li><p><code>ansible all -m user -a 'name=nginx state=absent remove=yes'</code></p><ul><li><p><code>state</code></p><ul><li><code>present</code>: 创建用户 (默认为present)</li><li><code>absent</code>: 删除用户</li></ul></li><li><p><code>remove</code>: 是否删除 用户 home 目录.</p></li></ul></li></ul></li></ul><hr><h4 id=group-模块>Group 模块</h4><ul><li><p><code>group</code>: 管理系统用户组的模块</p><ul><li><p><code>ansible all -m group -a 'name=nginx system=yes gid=80'</code></p><ul><li><p><code>name</code>: 用户组名</p></li><li><p><code>system</code>: 是否为系统用户组</p></li><li><p><code>gid</code>: 指定 gid 号</p></li><li><p><code>state</code></p><ul><li><code>present</code>: 创建用户组 (默认为present)</li><li><code>absent</code>: 删除用户组</li></ul></li></ul></li><li><p><code>ansible all -m group -a 'name=nginx state=absent'</code></p></li></ul></li></ul><hr><h3 id=ansible-galaxy>ansible-galaxy</h3><blockquote><p>通过 <a href=https://galaxy.ansible.com/>https://galaxy.ansible.com/</a> 页面下载</p></blockquote><p><strong>ansible-galaxy 工具用于下载对应的<code>roles</code></strong></p><ul><li><p><code>ansible-galaxy list geerlingguy.nginx</code></p><ul><li><code>list</code>: 查看本地的 roles 角色.</li></ul></li><li><p><code>ansible-galaxy install geerlingguy.nginx</code></p><ul><li><code>install</code>: 下载 <code>roles</code> 角色. 会下载到 <code>$HOME/.ansible/roles/</code> 目录下</li></ul></li><li><p><code>ansible-galaxy remove geerlingguy.nginx</code></p><ul><li><code>remove</code>: 删除已下载的 <code>roles</code> 角色. 在目录中删除也可以.</li></ul></li></ul><hr><h3 id=ansible-playbook>ansible playbook</h3><blockquote><p>playbook 流程图</p></blockquote><figure><img src=/img/posts/ansible/playbooks.jpg></figure><hr><h4 id=playbook-与-yaml-描述>playbook 与 YAML 描述</h4><ul><li><p><code>playbook</code> 由一个或多个 <code>play</code> 组成.</p></li><li><p><code>playbook</code> 中 每个<code>play</code> 必须包含 <code>hosts</code> 和 <code>tasks</code>.</p></li><li><p><code>playbook</code> 以 <code>YAML</code> 语法编写.</p><ul><li><p><code>YAML</code> 约定以 <code>---</code> 开头 和 开始不同的 <code>play</code> .</p></li><li><p><code>YAML</code> 以 <code>#</code> 作为注释.</p></li><li><p><code>YAML</code> 必须统一缩进, 空格 与 <code>tab</code> 不能混用, 缩进的级别也必须相同, 同级缩进代表同样的级别.</p></li><li><p><code>YAML</code> 文件内容 是大小写敏感的, 跟 Linux 一样区分大小写.</p></li><li><p><code>YAML</code> key/value 形式可写在同一行也可以换行写. 同行使用 <code>:</code> 隔开.</p></li><li><p><code>YAML</code> 一个完整的代码块功能最少包含2个元素. 如 name: task</p></li><li><p><code>YAML</code> 一个 name 下只能包含一个 task</p></li><li><p><code>YAML</code> <code>-</code> 开头的为列表, <code>key/value</code> 形式的为字典.</p></li><li><p><code>YAML</code> 特性</p><ul><li>可读性好</li><li>和脚本语言交互性好</li><li>使用实现语言的数据类型</li><li>一致性的信息模型</li><li>易于实现</li><li>基于流处理</li><li>表达能力好, 扩展性强</li></ul></li></ul></li></ul><hr><h4 id=playbook-核心元素>playbook 核心元素</h4><ul><li><p><code>hosts</code> : 远程主机列表 ( ip / 主机名 / 组名 )</p></li><li><p><code>tasks</code> : 任务集, 任务列表, 有两种写法</p><ul><li><p><code>action: module args</code> : action: 模块名 参数</p></li><li><p><code>module: args</code> : 模块名: 参数 (一般使用这种)</p></li><li><p><code>ignore_errors: True</code> 当前 task 出错时仍然会向下执行</p></li></ul></li><li><p><code>varniables</code> : 内置变量或自定义变量在 <code>playbook</code> 文件中调用</p></li><li><p><code>templates</code> : 模板, 可替换模板文件中的变量并实现一些简单逻辑的文件</p></li><li><p><code>handles</code> : 与 <code>notity</code> 结合使用, 由特定条件触发的操作, 满足条件才执行, 否则不执行</p></li><li><p><code>tags</code> : 标签 指定任务执行, 用于执行一个 <code>playbook</code> 中的部分代码. 主要用于测试.</p></li></ul><hr><h4 id=ansible-playbook-命令>ansible-playbook 命令</h4><ul><li><p><code>ansible-playbook</code></p><ul><li><p><code>-C / --check</code> : Check 检查脚本运行情况, 不会在远程服务器里运行.</p></li><li><p><code>--list-hosts</code> : 列出运行此 任务 的主机.</p></li><li><p><code>--list-tasks</code> : 列出任务组的具体任务列表.</p></li><li><p><code>--limit</code> : 只对主机列表中的某台主机执行.</p></li><li><p><code>-v -vv -vvv</code> : 显示详细的执行过程, <code>v</code> 越多就越详细.</p></li></ul></li></ul><hr><h4 id=ansible-playbook-变量>ansible-playbook 变量</h4><ul><li>变量名要求: 只允许使用 <code>字母</code> 、<code>数字</code> 、 <code>_</code> 组成, 而且只能以 <code>字母</code>开头.</li></ul><hr><ul><li><p>内置的公共变量:</p><ul><li><p>使用 <code>ansible all -m setup</code> 可以获取到主机的系统变量名称.</p><ul><li><code>ansible all -m setup -a 'filter=*addresses*'</code> , 可使用 filter 参数进行过滤.</li></ul></li></ul></li></ul><hr><ul><li><p>通过文件自定义变量:</p><ul><li><p><code>/etc/ansible/hosts</code> 文件中定义</p><ul><li><p>对主机组中的主机单独定义变量, 优先级高于公共变量.</p></li><li><p>对主机组中的所有主机定义统一变量, 优先级低于对单独主机定义的变量.</p></li></ul></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ini data-lang=ini>
<span class=k>[appserver]</span>
<span class=c1># 对单独主机 定义变量 node_id</span>
<span class=na>10.0.3.13 node_id</span><span class=o>=</span><span class=s>13</span>

<span class=c1># 对主机组 定义统一变量 domain_name</span>
<span class=k>[appserver:vars]</span>
<span class=na>domain_name</span><span class=o>=</span><span class=s>jicki.cn</span>


</code></pre></td></tr></table></div></div><ul><li>使用变量 就可以灵活配置不同主机的 <code>hostname</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>---<span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>tasks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>set<span class=w> </span>hostname<span class=w>
</span><span class=w>      </span><span class=k>hostname</span><span class=p>:</span><span class=w> </span>name={{<span class=w> </span>node_id<span class=w> </span>}}.{{<span class=w> </span>domain_name<span class=w> </span>}}<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><hr><ul><li><p>通过命令行定义变量: 通过命令行定义的变量优先级是最高的</p><ul><li><code>ansible-playbook -e varname=valur</code></li></ul></li></ul><hr><ul><li><p>在 <code>playbook</code> 文件里 定义变量.</p><ul><li><p>通过 <code>{{ 变量名 }}</code> 使用变量.</p></li><li><p>通过 <code>vars:</code> 列表 定义多个 变量.</p></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml><span class=w>
</span><span class=w></span>---<span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># 定义变量</span><span class=w>
</span><span class=w>  </span><span class=k>vars</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>pkg_name</span><span class=p>:</span><span class=w> </span>httpd<span class=w> 
</span><span class=w>
</span><span class=w>  </span><span class=k>tasks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>install<span class=w> </span>{{<span class=w> </span>pkg_name<span class=w> </span>}}<span class=w>
</span><span class=w>      </span><span class=c># 使用变量</span><span class=w>
</span><span class=w>      </span><span class=k>yum</span><span class=p>:</span><span class=w> </span>name={{<span class=w> </span>pkg_name<span class=w> </span>}}<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><hr><ul><li><p>通过定义单独的变量文件 用于统一存放变量, 可避免变量的重复定义.</p><ul><li><p>定义单独的 变量文件, 只需要将所有变量以 <code>key: value</code> 形式写入到 <code>yml</code> 文件中既可.</p></li><li><p>在 <code>playbook</code> 文件中, 只需要使用 <code>vars_files:</code> 指定 <code>yml</code> 文件路径既可.</p></li></ul></li></ul><hr><ul><li>vars.yml 变量文件</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>---<span class=w>
</span><span class=w></span><span class=k>pkg_name</span><span class=p>:</span><span class=w> </span>httpd<span class=w>
</span><span class=w></span><span class=k>file_name</span><span class=p>:</span><span class=w> </span>jicki.cn<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><ul><li>install.yml playbook 文件</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>---<span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># 配置模板文件</span><span class=w>
</span><span class=w>  </span><span class=k>vars_files</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=c># 指定文件的路径</span><span class=w>
</span><span class=w>    </span>- vars.yml<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>tasks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>install<span class=w> </span>{{<span class=w> </span>pkg_name<span class=w> </span>}}<span class=w>
</span><span class=w>      </span><span class=k>yum</span><span class=p>:</span><span class=w> </span>name={{<span class=w> </span>pkg_name<span class=w> </span>}}<span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>create<span class=w> </span>{{<span class=w> </span>file_name<span class=w> </span>}}<span class=w> </span>file<span class=w>
</span><span class=w>      </span><span class=k>file</span><span class=p>:</span><span class=w> </span>name=/root/{{<span class=w> </span>file_name<span class=w> </span>}}.txt<span class=w> </span>state=touch<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><ul><li>执行 playbook 操作</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>
<span class=o>[</span>root@jicki ansible<span class=o>]</span><span class=c1># ansible-playbook install.yml</span>

PLAY <span class=o>[</span>all<span class=o>]</span> *******************************************************************************************************

TASK <span class=o>[</span>Gathering Facts<span class=o>]</span> *******************************************************************************************
ok: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>install httpd<span class=o>]</span> *********************************************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>create jicki.cn file<span class=o>]</span> **************************************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>

PLAY RECAP *******************************************************************************************************
10.0.3.13                  : <span class=nv>ok</span><span class=o>=</span><span class=m>3</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>2</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>0</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>

</code></pre></td></tr></table></div></div><hr><h4 id=ansible-playbook-template>ansible-playbook template</h4><ul><li>template 是一个模块,并且只能用于 playbook 下.</li></ul><hr><ul><li><p><code>templates</code> 文件, 可嵌套脚本 ( 利用模板编程语言 Jinja2 编写 )</p><ul><li><p><code>Jinja2</code> 语言, 使用字面量.</p><ul><li><p>字符串: 使用单引号或双引号.</p></li><li><p>数字: 整数, 浮点数.</p></li><li><p>列表: [A1, A2, &mldr;]</p></li><li><p>元组: (B1, B2, &mldr;)</p></li><li><p>字典: {key1:value1, key2:value2, &mldr;}</p></li><li><p>布尔值: true/false</p></li><li><p>算术运算: <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>//</code>, <code>%</code>, <code>**</code></p></li><li><p>比较操作: <code>==</code>, <code>!=</code>, <code>></code>, <code>>=</code>, <code>&lt;</code>, <code>&lt;=</code></p></li><li><p>逻辑运算: and, or, not</p></li><li><p>流表达式: for, if, when</p></li></ul></li></ul></li></ul><hr><ul><li><p><code>templates</code> 根据模板块文件动态生成对应的配置文件</p><ul><li><p><code>templates</code> 文件一般约定存放于 templates 目录下, 并且以 <code>.j2</code> 为后缀</p></li><li><p>templates 目录需要与 <code>playbook</code> 的 <code>yml</code> 文件在同级目录中.</p></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@jicki nginx<span class=o>]</span><span class=c1># tree .</span>
.
<span class=p>|</span>-- nginx.yml
<span class=sb>`</span>-- templates
    <span class=sb>`</span>-- nginx.conf.j2
</code></pre></td></tr></table></div></div><hr><blockquote><p>算术运算</p></blockquote><ul><li>nginx.conf.j2 文件</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>user nginx;
# 这里使用 环境变量 vcpus * 2 
worker_processes {{ ansible_processor_vcpus * 2 }};
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
}

http {
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;
                      &#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;
                      &#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;;

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    include /etc/nginx/conf.d/*.conf;

    server {
        listen       80 default_server;
        listen       [::]:80 default_server;
        server_name  _;
        root         /usr/share/nginx/html;

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        location / {
        }

        error_page 404 /404.html;
            location = /40x.html {
        }

        error_page 500 502 503 504 /50x.html;
            location = /50x.html {
        }
    }
}

</code></pre></td></tr></table></div></div><hr><ul><li>nginx.yml <code>playbook</code> 文件</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>---<span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>tasks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>install<span class=w> </span>nginx<span class=w>
</span><span class=w>      </span><span class=k>yum</span><span class=p>:</span><span class=w> </span>name=nginx<span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>template<span class=w> </span>conf<span class=w>
</span><span class=w>      </span><span class=c># 如果 yml 与 templates 目录同级, src 直接写.j2 文件</span><span class=w>
</span><span class=w>      </span><span class=k>template</span><span class=p>:</span><span class=w> </span>src=nginx.conf.j2<span class=w> </span>dest=/etc/nginx/nginx.conf<span class=w>
</span><span class=w>      </span><span class=k>notify</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- restart<span class=w> </span>nginx<span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>start<span class=w> </span>nginx<span class=w>
</span><span class=w>      </span><span class=k>service</span><span class=p>:</span><span class=w> </span>name=nginx<span class=w> </span>state=started<span class=w> </span>enabled=yes<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>handlers</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>restart<span class=w> </span>nginx<span class=w>
</span><span class=w>      </span><span class=k>service</span><span class=p>:</span><span class=w> </span>name=nginx<span class=w> </span>state=restarted<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><hr><blockquote><p>when 条件语句</p></blockquote><ul><li><code>when</code> 条件语句 例子</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@jicki nginx<span class=o>]</span><span class=c1># tree .</span>
.
<span class=p>|</span>-- nginx.yml
<span class=sb>`</span>-- templates
    <span class=p>|</span>-- nginx.conf.centos7.j2
    <span class=sb>`</span>-- nginx.conf.centos8.j2
</code></pre></td></tr></table></div></div><hr><ul><li><code>playbook</code> 文件</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>---<span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>tasks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>install<span class=w> </span>nginx<span class=w>
</span><span class=w>      </span><span class=k>yum</span><span class=p>:</span><span class=w> </span>name=nginx<span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>template<span class=w> </span>centos<span class=w> </span><span class=m>7</span><span class=w> </span>conf<span class=w>
</span><span class=w>      </span><span class=c># 如果 yml 与 templates 目录同级, src 直接写.j2 文件</span><span class=w>
</span><span class=w>      </span><span class=k>template</span><span class=p>:</span><span class=w> </span>src=nginx.conf.centos7.j2<span class=w> </span>dest=/etc/nginx/nginx.conf<span class=w>
</span><span class=w>      </span><span class=c># 使用 when 语句进行判断 如果变量为 &#34;7&#34; 执行这个</span><span class=w>
</span><span class=w>      </span><span class=k>when</span><span class=p>:</span><span class=w> </span>ansible_distribution_major_version<span class=w> </span>==<span class=w> </span><span class=s2>&#34;7&#34;</span><span class=w>
</span><span class=w>      </span><span class=k>notify</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- restart<span class=w> </span>nginx<span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>template<span class=w> </span>centos<span class=w> </span><span class=m>8</span><span class=w> </span>conf<span class=w>
</span><span class=w>      </span><span class=c># 如果 yml 与 templates 目录同级, src 直接写.j2 文件</span><span class=w>
</span><span class=w>      </span><span class=k>template</span><span class=p>:</span><span class=w> </span>src=nginx.conf.centos8.j2<span class=w> </span>dest=/etc/nginx/nginx.conf<span class=w>
</span><span class=w>      </span><span class=c># 使用 when 语句进行判断 如果变量为 &#34;8&#34; 执行这个</span><span class=w>
</span><span class=w>      </span><span class=k>when</span><span class=p>:</span><span class=w> </span>ansible_distribution_major_version<span class=w> </span>==<span class=w> </span><span class=s2>&#34;8&#34;</span><span class=w>
</span><span class=w>      </span><span class=k>notify</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- restart<span class=w> </span>nginx<span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>start<span class=w> </span>nginx<span class=w>
</span><span class=w>      </span><span class=k>service</span><span class=p>:</span><span class=w> </span>name=nginx<span class=w> </span>state=started<span class=w> </span>enabled=yes<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>handlers</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>restart<span class=w> </span>nginx<span class=w>
</span><span class=w>      </span><span class=k>service</span><span class=p>:</span><span class=w> </span>name=nginx<span class=w> </span>state=restarted<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><ul><li><p>执行 playbook 文件</p><ul><li><code>skipping</code> 状态表示跳过执行这个 TASK .</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>
<span class=o>[</span>root@jicki nginx<span class=o>]</span><span class=c1># ansible-playbook nginx.yml</span>

PLAY <span class=o>[</span>all<span class=o>]</span> *******************************************************************************************

TASK <span class=o>[</span>Gathering Facts<span class=o>]</span> *******************************************************************************
ok: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>install nginx<span class=o>]</span> *********************************************************************************
ok: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>template centos <span class=m>7</span> conf<span class=o>]</span> ************************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>template centos <span class=m>8</span> conf<span class=o>]</span> ************************************************************************
skipping: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>start nginx<span class=o>]</span> ***********************************************************************************
ok: <span class=o>[</span>10.0.3.13<span class=o>]</span>

RUNNING HANDLER <span class=o>[</span>restart nginx<span class=o>]</span> **********************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>

PLAY RECAP *******************************************************************************************
10.0.3.13      : <span class=nv>ok</span><span class=o>=</span><span class=m>5</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>2</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>1</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>

</code></pre></td></tr></table></div></div><hr><blockquote><p>迭代变量 <code>with_tiems</code></p></blockquote><ul><li><p>迭代 <code>with_items</code> 执行重复任务.</p><ul><li>对于迭代选项, 固定变量名为 <code>item</code> .</li><li>在 <code>task</code> 中使用 <code>with_items</code> 指定需要迭代的元素列表.<ul><li>元素列表 支持 <code>字符串</code> 和 <code>字典</code> .</li></ul></li></ul></li><li><p><code>playbook</code> 文件</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>---<span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>tasks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>create<span class=w> </span>some<span class=w> </span>files<span class=w>
</span><span class=w>      </span><span class=c># {{ item }} 为特殊变量, 代表 with_items 列表中的内容</span><span class=w>
</span><span class=w>      </span><span class=k>file</span><span class=p>:</span><span class=w> </span>name=/tmp/{{<span class=w> </span>item<span class=w> </span>}}<span class=w> </span>state=touch<span class=w>
</span><span class=w>      </span><span class=k>with_items</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- file1<span class=w>
</span><span class=w>        </span>- file2<span class=w>
</span><span class=w>        </span>- file3<span class=w>
</span><span class=w>        </span>- file4<span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>install<span class=w> </span>some<span class=w> </span>software<span class=w>
</span><span class=w>      </span><span class=k>yum</span><span class=p>:</span><span class=w> </span>name={{<span class=w> </span>item<span class=w> </span>}}<span class=w>
</span><span class=w>      </span><span class=k>with_items</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- htop<span class=w>
</span><span class=w>        </span>- sl<span class=w>
</span><span class=w>        </span>- hping3<span class=w>
</span></code></pre></td></tr></table></div></div><hr><blockquote><p>代嵌套子变量 (字典)</p></blockquote><ul><li><p>迭代嵌套子变量.</p><ul><li>对迭代中的变量进行嵌套关联的操作.</li></ul></li><li><p><code>playbook</code> 文件</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml><span class=w>
</span><span class=w></span>---<span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>tasks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>create<span class=w> </span>some<span class=w> </span>files<span class=w>
</span><span class=w>      </span><span class=c># {{ item }} 为特殊变量, 代表 with_itmes 列表中的内容</span><span class=w>
</span><span class=w>      </span><span class=k>file</span><span class=p>:</span><span class=w> </span>name=/tmp/{{<span class=w> </span>item<span class=w> </span>}}<span class=w> </span>state=touch<span class=w>
</span><span class=w>      </span><span class=k>with_items</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- file1<span class=w>
</span><span class=w>        </span>- file2<span class=w>
</span><span class=w>        </span>- file3<span class=w>
</span><span class=w>        </span>- file4<span class=w>
</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>create<span class=w> </span>some<span class=w> </span>group<span class=w>
</span><span class=w>      </span><span class=k>group</span><span class=p>:</span><span class=w> </span>name={{<span class=w> </span>item<span class=w> </span>}}<span class=w>
</span><span class=w>      </span><span class=k>with_items</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- j1<span class=w>
</span><span class=w>        </span>- j2<span class=w>
</span><span class=w>        </span>- j3<span class=w>
</span><span class=w>        </span>- j4<span class=w>
</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>create<span class=w> </span>some<span class=w> </span>user<span class=w>
</span><span class=w>      </span><span class=c># 使用 item.key值 进行引用</span><span class=w>
</span><span class=w>      </span><span class=k>user</span><span class=p>:</span><span class=w> </span>name={{<span class=w> </span>item.name<span class=w> </span>}}<span class=w> </span>group={{<span class=w> </span>item.group<span class=w> </span>}}<span class=w>
</span><span class=w>      </span><span class=c># 使用 字典 定义 嵌套的子 变量</span><span class=w>
</span><span class=w>      </span><span class=k>with_items</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- {<span class=w> </span><span class=k>name: &#39;file1&#39;, group</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;j1&#39;</span><span class=w> </span>}<span class=w>
</span><span class=w>        </span>- {<span class=w> </span><span class=k>name: &#39;file2&#39;, group</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;j2&#39;</span><span class=w> </span>}<span class=w>
</span><span class=w>        </span>- {<span class=w> </span><span class=k>name: &#39;file3&#39;, group</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;j3&#39;</span><span class=w> </span>}<span class=w>
</span><span class=w>        </span>- {<span class=w> </span><span class=k>name: &#39;file4&#39;, group</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;j4&#39;</span><span class=w> </span>}<span class=w>
</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>permission<span class=w> </span>some<span class=w> </span>files<span class=w>
</span><span class=w>      </span><span class=k>file</span><span class=p>:</span><span class=w> </span>name=/tmp/{{<span class=w> </span>item.name<span class=w> </span>}}<span class=w> </span>owner={{<span class=w> </span>item.name<span class=w> </span>}}<span class=w> </span>group={{<span class=w> </span>item.group<span class=w> </span>}}<span class=w>
</span><span class=w>      </span><span class=k>with_items</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- {<span class=w> </span><span class=k>file: &#39;file1&#39;, name: &#39;file1&#39;, group</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;j1&#39;</span><span class=w> </span>}<span class=w>
</span><span class=w>        </span>- {<span class=w> </span><span class=k>file: &#39;file2&#39;, name: &#39;file2&#39;, group</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;j2&#39;</span><span class=w> </span>}<span class=w>
</span><span class=w>        </span>- {<span class=w> </span><span class=k>file: &#39;file3&#39;, name: &#39;file3&#39;, group</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;j3&#39;</span><span class=w> </span>}<span class=w>
</span><span class=w>        </span>- {<span class=w> </span><span class=k>file: &#39;file4&#39;, name: &#39;file4&#39;, group</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;j4&#39;</span><span class=w> </span>}<span class=w>
</span><span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><ul><li>执行 <code>playbook</code> 文件</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@jicki ansible<span class=o>]</span><span class=c1># ansible-playbook file.yml</span>

PLAY <span class=o>[</span>all<span class=o>]</span> *****************************************************************************************

TASK <span class=o>[</span>Gathering Facts<span class=o>]</span> *****************************************************************************
ok: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>create some files<span class=o>]</span> ***************************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>(</span><span class=nv>item</span><span class=o>=</span>file1<span class=o>)</span>
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>(</span><span class=nv>item</span><span class=o>=</span>file2<span class=o>)</span>
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>(</span><span class=nv>item</span><span class=o>=</span>file3<span class=o>)</span>
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>(</span><span class=nv>item</span><span class=o>=</span>file4<span class=o>)</span>

TASK <span class=o>[</span>create some group<span class=o>]</span> ***************************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>(</span><span class=nv>item</span><span class=o>=</span>j1<span class=o>)</span>
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>(</span><span class=nv>item</span><span class=o>=</span>j2<span class=o>)</span>
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>(</span><span class=nv>item</span><span class=o>=</span>j3<span class=o>)</span>
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>(</span><span class=nv>item</span><span class=o>=</span>j4<span class=o>)</span>

TASK <span class=o>[</span>create some user<span class=o>]</span> ****************************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>(</span><span class=nv>item</span><span class=o>={</span>u<span class=s1>&#39;group&#39;</span>: u<span class=s1>&#39;j1&#39;</span>, u<span class=s1>&#39;name&#39;</span>: u<span class=s1>&#39;file1&#39;</span><span class=o>})</span>
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>(</span><span class=nv>item</span><span class=o>={</span>u<span class=s1>&#39;group&#39;</span>: u<span class=s1>&#39;j2&#39;</span>, u<span class=s1>&#39;name&#39;</span>: u<span class=s1>&#39;file2&#39;</span><span class=o>})</span>
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>(</span><span class=nv>item</span><span class=o>={</span>u<span class=s1>&#39;group&#39;</span>: u<span class=s1>&#39;j3&#39;</span>, u<span class=s1>&#39;name&#39;</span>: u<span class=s1>&#39;file3&#39;</span><span class=o>})</span>
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>(</span><span class=nv>item</span><span class=o>={</span>u<span class=s1>&#39;group&#39;</span>: u<span class=s1>&#39;j4&#39;</span>, u<span class=s1>&#39;name&#39;</span>: u<span class=s1>&#39;file4&#39;</span><span class=o>})</span>

TASK <span class=o>[</span>permission some files<span class=o>]</span> ***********************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>(</span><span class=nv>item</span><span class=o>={</span>u<span class=s1>&#39;group&#39;</span>: u<span class=s1>&#39;j1&#39;</span>, u<span class=s1>&#39;name&#39;</span>: u<span class=s1>&#39;file1&#39;</span>, u<span class=s1>&#39;file&#39;</span>: u<span class=s1>&#39;file1&#39;</span><span class=o>})</span>
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>(</span><span class=nv>item</span><span class=o>={</span>u<span class=s1>&#39;group&#39;</span>: u<span class=s1>&#39;j2&#39;</span>, u<span class=s1>&#39;name&#39;</span>: u<span class=s1>&#39;file2&#39;</span>, u<span class=s1>&#39;file&#39;</span>: u<span class=s1>&#39;file2&#39;</span><span class=o>})</span>
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>(</span><span class=nv>item</span><span class=o>={</span>u<span class=s1>&#39;group&#39;</span>: u<span class=s1>&#39;j3&#39;</span>, u<span class=s1>&#39;name&#39;</span>: u<span class=s1>&#39;file3&#39;</span>, u<span class=s1>&#39;file&#39;</span>: u<span class=s1>&#39;file3&#39;</span><span class=o>})</span>
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>(</span><span class=nv>item</span><span class=o>={</span>u<span class=s1>&#39;group&#39;</span>: u<span class=s1>&#39;j4&#39;</span>, u<span class=s1>&#39;name&#39;</span>: u<span class=s1>&#39;file4&#39;</span>, u<span class=s1>&#39;file&#39;</span>: u<span class=s1>&#39;file4&#39;</span><span class=o>})</span>

PLAY RECAP *****************************************************************************************
10.0.3.13    : <span class=nv>ok</span><span class=o>=</span><span class=m>5</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>4</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>0</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>

</code></pre></td></tr></table></div></div><hr><hr><blockquote><p>流程控制、循环 for 与 if</p></blockquote><ul><li><p>for 循环</p><ul><li><code>{% for 语句块 %} ... {% endfor %}</code></li></ul></li></ul><hr><ul><li>ansible-playbook 文件</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>---<span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>vars</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=c># 列表的形式</span><span class=w>
</span><span class=w>    </span><span class=k>listen_port</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=m>80</span><span class=w>
</span><span class=w>      </span>- <span class=m>81</span><span class=w>
</span><span class=w>      </span>- <span class=m>82</span><span class=w>
</span><span class=w>    </span><span class=c># 字典的形式</span><span class=w>
</span><span class=w>    </span><span class=k>service</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>web1<span class=w>
</span><span class=w>        </span><span class=k>domain</span><span class=p>:</span><span class=w> </span>jicki.cn<span class=w>
</span><span class=w>        </span><span class=k>port</span><span class=p>:</span><span class=w> </span><span class=m>90</span><span class=w>
</span><span class=w>        </span><span class=k>user</span><span class=p>:</span><span class=w> </span>nginx<span class=w>
</span><span class=w>        </span><span class=k>path</span><span class=p>:</span><span class=w> </span>/var/www/html<span class=w> 
</span><span class=w>      </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>web2<span class=w>
</span><span class=w>        </span><span class=k>domain</span><span class=p>:</span><span class=w> </span>jicki.cn<span class=w>
</span><span class=w>        </span><span class=k>port</span><span class=p>:</span><span class=w> </span><span class=m>91</span><span class=w>
</span><span class=w>        </span><span class=k>user</span><span class=p>:</span><span class=w> </span>nginx<span class=w>
</span><span class=w>        </span><span class=k>path</span><span class=p>:</span><span class=w> </span>/var/www/html<span class=w>
</span><span class=w>      </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>web3<span class=w>
</span><span class=w>        </span><span class=k>domain</span><span class=p>:</span><span class=w> </span>jicki.cn<span class=w>
</span><span class=w>        </span><span class=k>port</span><span class=p>:</span><span class=w> </span><span class=m>92</span><span class=w>
</span><span class=w>        </span><span class=k>user</span><span class=p>:</span><span class=w> </span>nginx<span class=w>
</span><span class=w>        </span><span class=k>path</span><span class=p>:</span><span class=w> </span>/var/www/html<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>tasks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>copy<span class=w> </span>template<span class=w> </span>conf<span class=w>
</span><span class=w>      </span><span class=k>template</span><span class=p>:</span><span class=w> </span>src=for.conf.j2<span class=w> </span>dest=/root/for.conf<span class=w>
</span></code></pre></td></tr></table></div></div><ul><li><p>for.conf.j2 文件</p><ul><li><code>{% for port in listen_port %}</code> 语句 <code>listen_port</code> 为 playbook 中定义的 <code>vars</code> .</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>{% for port in listen_port %}

server {
   listen {{ port }}
}

{% endfor %}

</code></pre></td></tr></table></div></div><ul><li>查看最终生成 for.conf 文件</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@jicki ~<span class=o>]</span><span class=c1># cat /root/for.conf</span>

server <span class=o>{</span>
   listen <span class=m>80</span>
<span class=o>}</span>


server <span class=o>{</span>
   listen <span class=m>81</span>
<span class=o>}</span>


server <span class=o>{</span>
   listen <span class=m>82</span>
<span class=o>}</span>

</code></pre></td></tr></table></div></div><hr><ul><li>字典形式</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>---<span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>vars</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=c># 字典的形式</span><span class=w>
</span><span class=w>    </span><span class=k>service</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>web1<span class=w>
</span><span class=w>        </span><span class=k>domain</span><span class=p>:</span><span class=w> </span>jicki.cn<span class=w>
</span><span class=w>        </span><span class=k>port</span><span class=p>:</span><span class=w> </span><span class=m>90</span><span class=w>
</span><span class=w>        </span><span class=k>user</span><span class=p>:</span><span class=w> </span>nginx<span class=w>
</span><span class=w>        </span><span class=k>path</span><span class=p>:</span><span class=w> </span>/var/www/html<span class=w>
</span><span class=w>      </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>web2<span class=w>
</span><span class=w>        </span><span class=k>domain</span><span class=p>:</span><span class=w> </span>jicki.cn<span class=w>
</span><span class=w>        </span><span class=k>port</span><span class=p>:</span><span class=w> </span><span class=m>91</span><span class=w>
</span><span class=w>        </span><span class=k>user</span><span class=p>:</span><span class=w> </span>nginx<span class=w>
</span><span class=w>        </span><span class=k>path</span><span class=p>:</span><span class=w> </span>/var/www/html<span class=w>
</span><span class=w>      </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>web3<span class=w>
</span><span class=w>        </span><span class=k>domain</span><span class=p>:</span><span class=w> </span>jicki.cn<span class=w>
</span><span class=w>        </span><span class=k>port</span><span class=p>:</span><span class=w> </span><span class=m>92</span><span class=w>
</span><span class=w>        </span><span class=k>user</span><span class=p>:</span><span class=w> </span>nginx<span class=w>
</span><span class=w>        </span><span class=k>path</span><span class=p>:</span><span class=w> </span>/var/www/html<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>tasks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>copy<span class=w> </span>template<span class=w> </span>conf<span class=w>
</span><span class=w>      </span><span class=k>template</span><span class=p>:</span><span class=w> </span>src=nginx.conf.j2<span class=w> </span>dest=/root/nginx.conf<span class=w>
</span></code></pre></td></tr></table></div></div><ul><li>nginx.conf.j2 文件</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>{% for s in service %}
user {{ s.user }};
worker_processes {{ ansible_processor_vcpus + 2 }};
pid /run/nginx.pid;
    server {
        listen       {{ s.port }} default_server;
        listen       [::]:{{ s.port }} default_server;
        server_name  {{ s.name }}.{{ s.domain }};
        root         {{ s.path }};
    }

{% endfor %}

</code></pre></td></tr></table></div></div><ul><li>查看生成后的 nginx.conf</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>
user nginx<span class=p>;</span>
worker_processes 3<span class=p>;</span>
pid /run/nginx.pid<span class=p>;</span>
    server <span class=o>{</span>
        listen       <span class=m>90</span> default_server<span class=p>;</span>
        listen       <span class=o>[</span>::<span class=o>]</span>:90 default_server<span class=p>;</span>
        server_name  web1.jicki.cn<span class=p>;</span>
        root         /var/www/html<span class=p>;</span>
    <span class=o>}</span>

user nginx<span class=p>;</span>
worker_processes 3<span class=p>;</span>
pid /run/nginx.pid<span class=p>;</span>
    server <span class=o>{</span>
        listen       <span class=m>91</span> default_server<span class=p>;</span>
        listen       <span class=o>[</span>::<span class=o>]</span>:91 default_server<span class=p>;</span>
        server_name  web2.jicki.cn<span class=p>;</span>
        root         /var/www/html<span class=p>;</span>
    <span class=o>}</span>

user nginx<span class=p>;</span>
worker_processes 3<span class=p>;</span>
pid /run/nginx.pid<span class=p>;</span>
    server <span class=o>{</span>
        listen       <span class=m>92</span> default_server<span class=p>;</span>
        listen       <span class=o>[</span>::<span class=o>]</span>:92 default_server<span class=p>;</span>
        server_name  web3.jicki.cn<span class=p>;</span>
        root         /var/www/html<span class=p>;</span>
    <span class=o>}</span>
</code></pre></td></tr></table></div></div><hr><ul><li><p>if 流程控制</p><ul><li><code>{% if 语句块 %} ... {% else %} ... {% endif %}</code></li></ul></li></ul><hr><ul><li><p>playbook 文件</p><ul><li>其中 web1, web2 不没有 user 变量, web3 包含 user 变量.</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml><span class=w>
</span><span class=w></span>---<span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>vars</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=c># 字典的形式</span><span class=w>
</span><span class=w>    </span><span class=k>service</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>web1<span class=w>
</span><span class=w>        </span><span class=k>domain</span><span class=p>:</span><span class=w> </span>jicki.cn<span class=w>
</span><span class=w>        </span><span class=k>port</span><span class=p>:</span><span class=w> </span><span class=m>90</span><span class=w>
</span><span class=w>        </span><span class=k>path</span><span class=p>:</span><span class=w> </span>/var/www/html<span class=w>
</span><span class=w>
</span><span class=w>      </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>web2<span class=w>
</span><span class=w>        </span><span class=k>domain</span><span class=p>:</span><span class=w> </span>jicki.cn<span class=w>
</span><span class=w>        </span><span class=k>port</span><span class=p>:</span><span class=w> </span><span class=m>91</span><span class=w>
</span><span class=w>        </span><span class=k>path</span><span class=p>:</span><span class=w> </span>/var/www/html<span class=w>
</span><span class=w>
</span><span class=w>      </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>web3<span class=w>
</span><span class=w>        </span><span class=k>domain</span><span class=p>:</span><span class=w> </span>jicki.cn<span class=w>
</span><span class=w>        </span><span class=k>port</span><span class=p>:</span><span class=w> </span><span class=m>92</span><span class=w>
</span><span class=w>        </span><span class=k>user</span><span class=p>:</span><span class=w> </span>nginx<span class=w>
</span><span class=w>        </span><span class=k>path</span><span class=p>:</span><span class=w> </span>/var/www/html<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>tasks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>copy<span class=w> </span>template<span class=w> </span>conf<span class=w>
</span><span class=w>      </span><span class=k>template</span><span class=p>:</span><span class=w> </span>src=nginx.conf.j2<span class=w> </span>dest=/root/nginx.conf<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><ul><li><p>nginx.conf.j2 文件</p><ul><li><code>{% if s.user is defined %}</code> 判断 是否有 s.user 这个变量</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>
{% for s in service %}

{% if s.user is defined %}
user {{ s.user }};
{% else %}
user root;
{% endif %}
worker_processes {{ ansible_processor_vcpus + 2 }};
pid /run/nginx.pid;
    server {
        listen       {{ s.port }} default_server;
        server_name  {{ s.name }}.{{ s.domain }};
        root         {{ s.path }};
    }

{% endfor %}

</code></pre></td></tr></table></div></div><ul><li><p>查看生成后的 nginx.conf</p><ul><li>第一个 不包含 s.user 变量 所以 <code>user root;</code></li><li>第二个 不包含 s.user 变量 所以 <code>user root;</code></li><li>第三个 包含 s.user 变量 所以 <code>user nginx;</code> 等于变量值</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>
user root<span class=p>;</span>
worker_processes 3<span class=p>;</span>
pid /run/nginx.pid<span class=p>;</span>
    server <span class=o>{</span>
        listen       <span class=m>90</span> default_server<span class=p>;</span>
        server_name  web1.jicki.cn<span class=p>;</span>
        root         /var/www/html<span class=p>;</span>
    <span class=o>}</span>


user root<span class=p>;</span>
worker_processes 3<span class=p>;</span>
pid /run/nginx.pid<span class=p>;</span>
    server <span class=o>{</span>
        listen       <span class=m>91</span> default_server<span class=p>;</span>
        server_name  web2.jicki.cn<span class=p>;</span>
        root         /var/www/html<span class=p>;</span>
    <span class=o>}</span>


user nginx<span class=p>;</span>
worker_processes 3<span class=p>;</span>
pid /run/nginx.pid<span class=p>;</span>
    server <span class=o>{</span>
        listen       <span class=m>92</span> default_server<span class=p>;</span>
        server_name  web3.jicki.cn<span class=p>;</span>
        root         /var/www/html<span class=p>;</span>
    <span class=o>}</span>


</code></pre></td></tr></table></div></div><hr><h4 id=example---tasks>Example - tasks</h4><ul><li>基础的例子</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>---<span class=w>
</span><span class=w></span><span class=c># 指定主机组</span><span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=c># 指定执行 用户</span><span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># 任务</span><span class=w>
</span><span class=w>  </span><span class=k>tasks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=c># 任务的名称</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>ping<span class=w> </span>server<span class=w>
</span><span class=w>      </span><span class=k>ping</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>echo<span class=w> </span>hostname<span class=w>
</span><span class=w>      </span><span class=c># shell 为模块名, 后面等同于 -a &#39;&#39; 参数</span><span class=w>
</span><span class=w>      </span><span class=k>shell</span><span class=p>:</span><span class=w> </span>hostname<span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>touch<span class=w> </span>file<span class=w>
</span><span class=w>      </span><span class=k>file</span><span class=p>:</span><span class=w> </span>name=/tmp/file.txt<span class=w> </span>state=touch<span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>echo<span class=w> </span>file<span class=w>
</span><span class=w>      </span><span class=k>shell</span><span class=p>:</span><span class=w> </span>ls<span class=w> </span>-l<span class=w> </span>/tmp/file.txt<span class=w>
</span></code></pre></td></tr></table></div></div><hr><ul><li><p><code>ansible-playbook hello.yml</code> 运行 <code>playbook</code></p><ul><li><p>输出如下:</p><ul><li><p><code>ok</code> : ok 表示没有任何更改, 绿色</p></li><li><p><code>changed</code> : changed 表示有修改, 黄色</p></li></ul></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>PLAY <span class=o>[</span>all<span class=o>]</span> **********************************************************

TASK <span class=o>[</span>Gathering Facts<span class=o>]</span> **********************************************
ok: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>ping server<span class=o>]</span> **************************************************
ok: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span><span class=nb>echo</span> hostname<span class=o>]</span> ************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>touch file<span class=o>]</span> ***************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span><span class=nb>echo</span> file<span class=o>]</span> ****************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>


PLAY RECAP **********************************************************
10.0.3.13   : <span class=nv>ok</span><span class=o>=</span><span class=m>5</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>0</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>

</code></pre></td></tr></table></div></div><hr><h4 id=example---handles>Example - handles</h4><ul><li><p><code>handles</code> 与 <code>notity</code> 结合的例子</p><ul><li>同一个<code>name</code> 下可以定义多个 <code>notify</code> 配置关联到不同的 <code>handlers</code> 中.</li></ul></li></ul><hr><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>tasks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>copy<span class=w> </span>httpd.conf<span class=w>
</span><span class=w>      </span><span class=k>copy</span><span class=p>:</span><span class=w> </span>src=/root/ansible/httpd.conf<span class=w> </span>dest=/etc/httpd/conf/httpd.conf<span class=w> </span>backup=yes<span class=w>
</span><span class=w>      </span><span class=c># 关联多个触发器的写法</span><span class=w>
</span><span class=w>      </span><span class=k>notify</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- restart<span class=w> </span>httpd<span class=w>
</span><span class=w>        </span>- check<span class=w> </span>status<span class=w> </span>httpd<span class=w>
</span><span class=w>        </span>- check<span class=w> </span>network<span class=w> </span>port<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><hr><ul><li>例子:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>---<span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>tasks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>install<span class=w> </span>httpd<span class=w>
</span><span class=w>      </span><span class=k>yum</span><span class=p>:</span><span class=w> </span>name=httpd<span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>copy<span class=w> </span>httpd.conf<span class=w>
</span><span class=w>      </span><span class=k>copy</span><span class=p>:</span><span class=w> </span>src=/root/ansible/httpd.conf<span class=w> </span>dest=/etc/httpd/conf/httpd.conf<span class=w> </span>backup=yes<span class=w>
</span><span class=w>      </span><span class=c># 此任务 如果有变动会触发如下定义名称的触发器</span><span class=w>
</span><span class=w>      </span><span class=k>notify</span><span class=p>:</span><span class=w> </span>restart<span class=w> </span>httpd<span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>start<span class=w> </span>httpd<span class=w>
</span><span class=w>      </span><span class=k>service</span><span class=p>:</span><span class=w> </span>name=httpd<span class=w> </span>state=started<span class=w> </span>enabled=yes<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># 触发器, 需要配置 notify 触发</span><span class=w>
</span><span class=w>  </span><span class=k>handlers</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>restart<span class=w> </span>httpd<span class=w>
</span><span class=w>      </span><span class=k>service</span><span class=p>:</span><span class=w> </span>name=httpd<span class=w> </span>state=restarted<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><hr><ul><li><p><code>ansible-playbook httpd.yml</code></p><ul><li>第一次执行输出如下:</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>
PLAY <span class=o>[</span>all<span class=o>]</span> ********************************************************************************************************

TASK <span class=o>[</span>Gathering Facts<span class=o>]</span> ********************************************************************************************
ok: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>install httpd<span class=o>]</span> **********************************************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>copy httpd.conf<span class=o>]</span> ********************************************************************************************
ok: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>start httpd<span class=o>]</span> ************************************************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>

PLAY RECAP ********************************************************************************************************
10.0.3.13                  : <span class=nv>ok</span><span class=o>=</span><span class=m>4</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>2</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>0</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>

</code></pre></td></tr></table></div></div><hr><ul><li><p>修改 httpd.conf 文件以后</p><ul><li>第二次执行输出如下:</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>
PLAY <span class=o>[</span>all<span class=o>]</span> ********************************************************************************************************

TASK <span class=o>[</span>Gathering Facts<span class=o>]</span> ********************************************************************************************
ok: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>install httpd<span class=o>]</span> **********************************************************************************************
ok: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>copy httpd.conf<span class=o>]</span> ********************************************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>start httpd<span class=o>]</span> ************************************************************************************************
ok: <span class=o>[</span>10.0.3.13<span class=o>]</span>

RUNNING HANDLER <span class=o>[</span>restart httpd<span class=o>]</span> ***********************************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>

PLAY RECAP ********************************************************************************************************
10.0.3.13                  : <span class=nv>ok</span><span class=o>=</span><span class=m>5</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>2</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>0</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>


</code></pre></td></tr></table></div></div><hr><h4 id=example---tags>Example - tags</h4><ul><li><p>基于 <code>tags</code> 的例子</p><ul><li><p>定义了 <code>tags</code> 后可通过定义的 <code>tags</code> 单独运行该 <code>tags</code>. 运行多个可用 <code>,</code> 号隔开.</p></li><li><p>多个不同的任务 可以定义相同名称的 <code>tags</code>.</p></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>---<span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>tasks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>install<span class=w> </span>httpd<span class=w>
</span><span class=w>      </span><span class=k>yum</span><span class=p>:</span><span class=w> </span>name=httpd<span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>copy<span class=w> </span>httpd.conf<span class=w>
</span><span class=w>      </span><span class=k>copy</span><span class=p>:</span><span class=w> </span>src=/root/ansible/httpd.conf<span class=w> </span>dest=/etc/httpd/conf/httpd.conf<span class=w> </span>backup=yes<span class=w>
</span><span class=w>      </span><span class=c># 此任务 如果有变动会触发如下定义名称的触发器</span><span class=w>
</span><span class=w>      </span><span class=k>notify</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- restart<span class=w> </span>httpd<span class=w>
</span><span class=w>      </span><span class=c># 定义标签</span><span class=w>
</span><span class=w>      </span><span class=k>tags</span><span class=p>:</span><span class=w> </span>cpconf<span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>start<span class=w> </span>httpd<span class=w>
</span><span class=w>      </span><span class=k>service</span><span class=p>:</span><span class=w> </span>name=httpd<span class=w> </span>state=started<span class=w> </span>enabled=yes<span class=w>
</span><span class=w>      </span><span class=c># 定义标签</span><span class=w>
</span><span class=w>      </span><span class=k>tags</span><span class=p>:</span><span class=w> </span>sthttpd<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># 触发器, 需要配置 notify 触发</span><span class=w>
</span><span class=w>  </span><span class=k>handlers</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>restart<span class=w> </span>httpd<span class=w>
</span><span class=w>      </span><span class=k>service</span><span class=p>:</span><span class=w> </span>name=httpd<span class=w> </span>state=restarted<span class=w>
</span></code></pre></td></tr></table></div></div><hr><ul><li>执行命令 <code>-t</code> 指定标签</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@jicki ansible<span class=o>]</span><span class=c1># ansible-playbook -t sthttpd httpd.yml</span>

PLAY <span class=o>[</span>all<span class=o>]</span> ********************************************************************************************************

TASK <span class=o>[</span>Gathering Facts<span class=o>]</span> ********************************************************************************************
ok: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>start httpd<span class=o>]</span> ************************************************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>

PLAY RECAP ********************************************************************************************************
10.0.3.13                  : <span class=nv>ok</span><span class=o>=</span><span class=m>2</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>1</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>0</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>

</code></pre></td></tr></table></div></div><hr><h3 id=ansible-vault>ansible-vault</h3><ul><li><p><code>playbook</code> 文件加密工具</p></li><li><p><code>ansible-vault encrypt hello.yml</code></p><ul><li><p><code>encrypt</code>: AES256 加密 ( 会提示输入密码 )</p></li><li><p><code>view</code>: 加密的情况下 查看 原来的内容.</p></li><li><p><code>edit</code>: 编辑加密的 playbook 文件.</p></li><li><p><code>decrypt</code>: 解密.</p></li><li><p><code>rekey</code>: 修改加密密码.</p></li></ul></li></ul><hr><h3 id=ansible-console>ansible-console</h3><ul><li><code>ansible-console</code>: 可交互执行命令, 支持 <code>Tab</code> 键.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@jicki ~<span class=o>]</span><span class=c1># ansible-console</span>
Welcome to the ansible console.
Type <span class=nb>help</span> or ? to list commands.

root@all <span class=o>(</span>1<span class=o>)[</span>f:5<span class=o>]</span>$

</code></pre></td></tr></table></div></div><ul><li><p><code>root@all (1) [f:5]$</code></p><ul><li><code>root</code>: 当前执行用户.</li><li><code>all</code>: 表示当前主机清单.</li><li><code>(1)</code>: 表示当前主机清单下包含 <code>1</code> 台主机.</li><li><code>[f:5]</code>: 表示并发执行任务数为 <code>5</code> 个.</li></ul></li></ul><hr><h3 id=ansible-roles>ansible Roles</h3><ul><li><p><code>Roles</code> 既 (角色) 是 ansible v1.2 版本引入的新特性, 用于 层次性、结构化的组织 <code>playbook</code>.</p></li><li><p><code>Roles</code> 能够根据层次结构自动加载- 变量文件、tasks、handler、template 文件等. 简单来讲就是将 这些文件归类到各自单独的文件目录中, 使 playbook 文件可以更好的通过 <code>include</code> 这些文件目录.</p></li><li><p><code>Roles</code> 一般用于基于 <code>主机构建服务</code> 的场景中, 但也可以用于构建 <code>守护进程</code> 等场景.</p></li><li><p><code>Roles</code> 官方定义默认的目录为 <code>/etc/ansible/roles</code> 下.</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@jicki ansible<span class=o>]</span><span class=c1># tree .</span>
.
<span class=p>|</span>-- ansible.cfg
<span class=p>|</span>-- hosts
<span class=sb>`</span>-- roles
    <span class=sb>`</span>-- nginx
</code></pre></td></tr></table></div></div><hr><blockquote><p>roles 目录结构</p></blockquote><figure><img src=/img/posts/ansible/ansible-roles.png></figure><ul><li><p>目录结构说明</p><ul><li><code>roles</code>: - 所有的角色必须放在roles目录下, 这个目录可以自定义位置. 默认的位置在 <code>/etc/ansible/roles</code><ul><li><code>playbook.yml</code>: - 剧本文件.</li><li><code>project</code>: - 具体的角色项目名称, 比如 nginx、tomcat、php .<ul><li><code>files</code>: - 用于存放由<code>copy</code> 或<code>script</code> 模块调用的文件.</li><li><code>templates</code>: - 用于存放 <code>Jinja2</code> 模板, <code>template</code> 模块会自动在此目录中寻找 <code>Jinja2</code> 模板文件.</li><li><code>tasks</code>: - 此目录应当包含一个<code>main.yml</code>文件, 用于定义此角色的任务列表, 此文件可以使用<code>include</code>包含其它的位于此目录的 <code>task</code> 文件.</li><li><code>handlers</code>: - 此目录应当包含一个<code>main.yml</code>文件, 用于定义此角色中触发条件时执行的动作.</li><li><code>vars</code>: - 此目录应当包含一个<code>main.yml</code>文件, 用于定义此角色用到的变量.</li><li><code>defaults</code>: - 目录应当包含一个<code>main.yml</code>文件, 用于为当前角色设定默认变量.</li><li><code>meta</code>: - 此目录应当包含一个<code>main.yml</code>文件, 用于定义此角色的特殊设定及其依赖关系.</li></ul></li></ul></li></ul></li></ul><hr><ul><li>roles - nginx</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@jicki roles<span class=o>]</span><span class=c1># tree .</span>
.
<span class=sb>`</span>-- nginx
    <span class=p>|</span>-- defaults
    <span class=p>|</span>-- files
    <span class=p>|</span>-- handlers
    <span class=p>|</span>-- meta
    <span class=p>|</span>-- tasks
    <span class=p>|</span>-- templates
    <span class=sb>`</span>-- vars
</code></pre></td></tr></table></div></div><hr><ul><li>创建对应的文件</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@jicki ansible<span class=o>]</span><span class=c1># tree  roles/</span>
roles/
<span class=sb>`</span>-- nginx
    <span class=p>|</span>-- defaults
    <span class=p>|</span>-- files
    <span class=p>|</span>-- handlers
    <span class=p>|</span>-- meta
    <span class=p>|</span>-- tasks
    <span class=p>|</span>   <span class=p>|</span>-- group.yml
    <span class=p>|</span>   <span class=p>|</span>-- main.yml
    <span class=p>|</span>   <span class=p>|</span>-- restart.yml
    <span class=p>|</span>   <span class=p>|</span>-- start.yml
    <span class=p>|</span>   <span class=p>|</span>-- template.yml
    <span class=p>|</span>   <span class=p>|</span>-- user.yml
    <span class=p>|</span>   <span class=sb>`</span>-- yum.yml
    <span class=p>|</span>-- templates
    <span class=p>|</span>   <span class=sb>`</span>-- nginx.conf.j2
    <span class=sb>`</span>-- vars
</code></pre></td></tr></table></div></div><hr><ul><li><code>/etc/ansible/nginx_roles.yml</code> 与 roles 同级</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml><span class=w>
</span><span class=w></span>---<span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># 选择 roles 属性</span><span class=w>
</span><span class=w>  </span><span class=k>roles</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=c># 调用 role 目录. roles 同级的目录</span><span class=w>
</span><span class=w>    </span>- <span class=k>role</span><span class=p>:</span><span class=w> </span>nginx<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><ul><li><p><code>/etc/ansible/roles/nginx/tasks/main.yml</code> 入口文件 配置 task 执行顺序</p><ul><li><p>跨 roles 调用 tasks, 需要写 roles 目录级的全路径. 如:</p><ul><li><code>-include: roles/httpd/tasks/copyfile.yml</code></li></ul></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>- <span class=k>include</span><span class=p>:</span><span class=w> </span>group.yml<span class=w>
</span><span class=w></span>- <span class=k>include</span><span class=p>:</span><span class=w> </span>user.yml<span class=w>
</span><span class=w></span>- <span class=k>include</span><span class=p>:</span><span class=w> </span>yum.yml<span class=w>
</span><span class=w></span>- <span class=k>include</span><span class=p>:</span><span class=w> </span>template.yml<span class=w>
</span><span class=w></span>- <span class=k>include</span><span class=p>:</span><span class=w> </span>start.yml<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><ul><li><code>/etc/ansible/roles/nginx/tasks/group.yml</code> 单独的 tasks 文件只写单独的内容 如下:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>- <span class=k>name</span><span class=p>:</span><span class=w> </span>create<span class=w> </span>group<span class=w>
</span><span class=w>  </span><span class=k>group</span><span class=p>:</span><span class=w> </span>name=nginx<span class=w> </span>gid=<span class=m>80</span><span class=w>
</span></code></pre></td></tr></table></div></div><hr><ul><li>执行 <code>/etc/ansible/nginx_roles.yml</code> 文件</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>
<span class=o>[</span>root@jicki ansible<span class=o>]</span><span class=c1># ansible-playbook nginx_roles.yml</span>

PLAY <span class=o>[</span>all<span class=o>]</span> ****************************************************************************************

TASK <span class=o>[</span>Gathering Facts<span class=o>]</span> ****************************************************************************
ok: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>nginx : create group<span class=o>]</span> ***********************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>nginx : create user<span class=o>]</span> ************************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>nginx : install package<span class=o>]</span> ********************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>nginx : copy conf<span class=o>]</span> **************************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>

TASK <span class=o>[</span>nginx : start service<span class=o>]</span> **********************************************************************
changed: <span class=o>[</span>10.0.3.13<span class=o>]</span>

PLAY RECAP ****************************************************************************************
10.0.3.13   : <span class=nv>ok</span><span class=o>=</span><span class=m>6</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>0</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>


</code></pre></td></tr></table></div></div><hr><blockquote><p>roles tags 标签</p></blockquote><ul><li>在 playbook 文件中 对 roles 配置相应的 tags .</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>---<span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># 选择 roles 属性</span><span class=w>
</span><span class=w>  </span><span class=k>roles</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=c># 配置相应的 tags 用 { } 引用</span><span class=w>
</span><span class=w>    </span>- {<span class=w> </span><span class=k>role: nginx, tags</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;web&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;nginx&#39;</span><span class=p>]</span><span class=w> </span>}<span class=w>
</span><span class=w>    </span>- {<span class=w> </span><span class=k>role: mysql, tags</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;db&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;mysql&#39;</span><span class=p>]</span><span class=w> </span>}<span class=w>
</span><span class=w>    </span>- {<span class=w> </span><span class=k>role: redis, tags</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;db&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;redis&#39;</span><span class=p>]</span><span class=w> </span>}<span class=w>
</span><span class=w>    </span>- {<span class=w> </span><span class=k>role: golang, tags</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;web&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;golang&#39;</span><span class=p>]</span><span class=w> </span>}<span class=w>
</span><span class=w>    </span>- {<span class=w> </span><span class=k>role: app, tags</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;app&#34;</span><span class=w> </span>}<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><hr><ul><li><p>通过 <code>ansible-playbook -t</code> 参数指定 tags 进行单独调用</p><ul><li>如下指定 tags 为 web 的 role 执行. 为 nginx 和 golang</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@jicki ansible<span class=o>]</span><span class=c1># ansible-playbook -t web playbook.yml</span>

</code></pre></td></tr></table></div></div><hr><blockquote><p>roles when 语句</p></blockquote><ul><li>对 role 进行条件的判断.<ul><li><code>ansible_distribution_major_version == "7"</code></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>---<span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># 选择 roles 属性</span><span class=w>
</span><span class=w>  </span><span class=k>roles</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=c># 配置相应的 tags 用 { } 引用</span><span class=w>
</span><span class=w>    </span>- {<span class=w> </span><span class=k>role: nginx, tags</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;web&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;nginx&#39;</span><span class=p>]</span><span class=w> </span>}<span class=w>
</span><span class=w>    </span>- {<span class=w> </span><span class=k>role: mysql, tags</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;db&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;mysql&#39;</span><span class=p>]</span><span class=w> </span>}<span class=w>
</span><span class=w>    </span>- {<span class=w> </span><span class=k>role: redis, tags</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;db&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;redis&#39;</span><span class=p>]</span><span class=w> </span>}<span class=w>
</span><span class=w>    </span><span class=c># 只针对 系统的 版本 为 7 的执行</span><span class=w>
</span><span class=w>    </span>- {<span class=w> </span><span class=k>role: golang, tags: [&#39;web&#39;, &#39;golang&#39;], when</span><span class=p>:</span><span class=w> </span>ansible_distribution_major_version<span class=w> </span>==<span class=w> </span><span class=s2>&#34;7&#34;</span><span class=w> </span>}<span class=w>
</span><span class=w>    </span>- {<span class=w> </span><span class=k>role: app, tags</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;app&#34;</span><span class=w> </span>}<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><hr><h4 id=example---roles>Example - roles</h4><ul><li><p>一个综合的例子</p></li><li><p>roles 目录如下</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@jicki ansible<span class=o>]</span><span class=c1># tree .</span>
.
<span class=p>|</span>-- ansible.cfg
<span class=p>|</span>-- hosts
<span class=p>|</span>-- nginx_roles.yml
<span class=sb>`</span>-- roles
    <span class=sb>`</span>-- nginx
        <span class=p>|</span>-- defaults
        <span class=p>|</span>-- files
        <span class=p>|</span>   <span class=sb>`</span>-- default.conf
        <span class=p>|</span>-- handlers
        <span class=p>|</span>   <span class=sb>`</span>-- main.yml
        <span class=p>|</span>-- meta
        <span class=p>|</span>-- tasks
        <span class=p>|</span>   <span class=p>|</span>-- copyfile.yml
        <span class=p>|</span>   <span class=p>|</span>-- group.yml
        <span class=p>|</span>   <span class=p>|</span>-- main.yml
        <span class=p>|</span>   <span class=p>|</span>-- start.yml
        <span class=p>|</span>   <span class=p>|</span>-- template.yml
        <span class=p>|</span>   <span class=p>|</span>-- user.yml
        <span class=p>|</span>   <span class=sb>`</span>-- yum.yml
        <span class=p>|</span>-- templates
        <span class=p>|</span>   <span class=sb>`</span>-- nginx.conf.j2
        <span class=sb>`</span>-- vars
            <span class=sb>`</span>-- main.yml

</code></pre></td></tr></table></div></div><ul><li><code>nginx_roles.yml</code> 文件</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>---<span class=w>
</span><span class=w></span>- <span class=k>hosts</span><span class=p>:</span><span class=w> </span>all<span class=w>
</span><span class=w>  </span><span class=k>remote_user</span><span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># 选择 roles 属性</span><span class=w>
</span><span class=w>  </span><span class=k>roles</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=c># 调用 role 目录. roles 同级的目录</span><span class=w>
</span><span class=w>    </span>- <span class=k>role</span><span class=p>:</span><span class=w> </span>nginx<span class=w>
</span></code></pre></td></tr></table></div></div><hr><ul><li><p><code>roles/tasks/main.yml</code> 文件</p><ul><li>按照导入顺序执行如下 task</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>- <span class=k>include</span><span class=p>:</span><span class=w> </span>group.yml<span class=w>
</span><span class=w></span>- <span class=k>include</span><span class=p>:</span><span class=w> </span>user.yml<span class=w>
</span><span class=w></span>- <span class=k>include</span><span class=p>:</span><span class=w> </span>yum.yml<span class=w>
</span><span class=w></span>- <span class=k>include</span><span class=p>:</span><span class=w> </span>template.yml<span class=w>
</span><span class=w></span>- <span class=k>include</span><span class=p>:</span><span class=w> </span>copyfile.yml<span class=w>
</span><span class=w></span>- <span class=k>include</span><span class=p>:</span><span class=w> </span>start.yml<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><ul><li><p><code>roles/tasks/template.yml</code> 文件</p><ul><li>template 文件引用了 notify</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>- <span class=k>name</span><span class=p>:</span><span class=w> </span>copy<span class=w> </span>conf<span class=w>
</span><span class=w>  </span><span class=k>template</span><span class=p>:</span><span class=w> </span>src=nginx.conf.j2<span class=w> </span>dest=/etc/nginx/nginx.conf<span class=w>
</span><span class=w>  </span><span class=k>notify</span><span class=p>:</span><span class=w> </span>restart<span class=w> </span>service<span class=w>
</span></code></pre></td></tr></table></div></div><ul><li><p><code>roles/tasks/copyfile.yml</code> 文件</p><ul><li>copyfile 文件引用了 变量, 以及引用了 files 目录下的文件</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>- <span class=k>name</span><span class=p>:</span><span class=w> </span>copy<span class=w> </span>conf<span class=w>
</span><span class=w>  </span><span class=k>copy</span><span class=p>:</span><span class=w> </span>src=default.conf<span class=w> </span>dest=/etc/nginx/conf.d/<span class=w> </span>owner={{<span class=w> </span>username<span class=w> </span>}}<span class=w> </span>group={{<span class=w> </span>groupname<span class=w> </span>}}<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><hr><ul><li><p><code>roles/nginx/handlers/main.yml</code> 文件</p><ul><li>handlers 下必须包含一个 <code>mian.yml</code> 文件</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>- <span class=k>name</span><span class=p>:</span><span class=w> </span>restart<span class=w> </span>service<span class=w>
</span><span class=w>  </span><span class=k>service</span><span class=p>:</span><span class=w> </span>name=nginx<span class=w> </span>state=restarted<span class=w>
</span></code></pre></td></tr></table></div></div><hr><ul><li><p><code>roles/nginx/vars/main.yml</code> 文件</p><ul><li>以 <code>key/value</code> 形式写入内容</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml><span class=k>username</span><span class=p>:</span><span class=w> </span>nginx<span class=w>
</span><span class=w></span><span class=k>groupname</span><span class=p>:</span><span class=w> </span>nginx<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><hr></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2020-08-10</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/ansible-playbook/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://jicki.cn/ansible-playbook/ data-title="Ansible 从入门到放弃" data-via=jicki234 data-hashtags=linux,ansible><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://jicki.cn/ansible-playbook/ data-hashtag=linux><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://jicki.cn/ansible-playbook/ data-title="Ansible 从入门到放弃" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://jicki.cn/ansible-playbook/ data-title="Ansible 从入门到放弃"><i data-svg-src=/lib/simple-icons/icons/line.min.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://jicki.cn/ansible-playbook/ data-title="Ansible 从入门到放弃"><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=https://jicki.cn/ansible-playbook/ data-title="Ansible 从入门到放弃" data-description="Ansible 从入门到放弃"><i data-svg-src=/lib/simple-icons/icons/myspace.min.svg></i></a><a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://jicki.cn/ansible-playbook/ data-title="Ansible 从入门到放弃" data-description="Ansible 从入门到放弃"><i class="fab fa-blogger fa-fw"></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://jicki.cn/ansible-playbook/ data-title="Ansible 从入门到放弃"><i class="fab fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/linux/>linux</a>,&nbsp;<a href=/tags/ansible/>ansible</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/gitops-kubernetes/ class=prev rel=prev title="GitOps 实现云原生的持续交付"><i class="fas fa-angle-left fa-fw"></i>GitOps 实现云原生的持续交付</a>
<a href=/helm-v2/ class=next rel=next title="Helm - v2">Helm - v2<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a href=https://yanlong.me target=_blank>何延龙</a></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.73.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://jicki.cn target=_blank>小炒肉</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a href=http://beian.miit.gov.cn target=_blank>粤ICP备20055633号</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":200},"comment":{"valine":{"appId":"1LTTCvDe4Nt8XSdFzejtUsVF-gzGzoHsz","appKey":"cvpPM7sbgOw0pTXbh6YVKrjc","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"zh-cn","pageSize":10,"placeholder":"你的评论 ...","recordIP":true,"visitor":true}},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>