<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Istio 持续更新... - 小炒肉</title><meta name=Description content="Istio 持续更新..."><meta property="og:title" content="Istio 持续更新..."><meta property="og:description" content="Istio 持续更新..."><meta property="og:type" content="article"><meta property="og:url" content="https://jicki.cn/istio-1.5/"><meta property="og:image" content="https://jicki.cn/logo.png"><meta property="article:published_time" content="2020-04-13T00:00:00+00:00"><meta property="article:modified_time" content="2021-10-19T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jicki.cn/logo.png"><meta name=twitter:title content="Istio 持续更新..."><meta name=twitter:description content="Istio 持续更新..."><meta name=application-name content="小炒肉"><meta name=apple-mobile-web-app-title content="小炒肉"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/images/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://jicki.cn/istio-1.5/><link rel=prev href=https://jicki.cn/leetcode-100/><link rel=next href=https://jicki.cn/horizontal-pod-autoscale/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Istio 持续更新...","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/jicki.cn\/istio-1.5\/"},"genre":"posts","keywords":"istio","wordcount":10560,"url":"https:\/\/jicki.cn\/istio-1.5\/","datePublished":"2020-04-13T00:00:00+00:00","dateModified":"2021-10-19T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"小炒肉"},"description":"Istio 持续更新..."}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=小炒肉>小炒肉</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=小炒肉>小炒肉</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/>文章</a><a class=menu-item href=/tags/>标签</a><a class=menu-item href=/categories/>分类</a><a class=menu-item href=/about/>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Istio 持续更新...</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://jicki.cn title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>小炒肉</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/istio/><i class="far fa-folder fa-fw"></i>istio</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-04-13>2020-04-13</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 10560 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 22 分钟&nbsp;<span id=/istio-1.5/ class=leancloud_visitors data-flag-title="Istio 持续更新...">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#istio-是什么衣撕朵>Istio 是什么？(衣撕朵)</a></li><li><a href=#服务网格-又是什么>服务网格 又是什么？</a></li><li><a href=#istio-架构>Istio 架构</a></li><li><a href=#istio-组件>Istio 组件</a><ul><li><a href=#envoy>Envoy</a></li><li><a href=#mixer>Mixer</a></li><li><a href=#pilot>Pilot</a></li><li><a href=#citadel>Citadel</a></li><li><a href=#galley>Galley</a></li></ul></li><li><a href=#istio-install>Istio Install</a><ul><li><a href=#搭建-kubernetes>搭建 Kubernetes</a></li><li><a href=#下载-istio-项目包>下载 Istio 项目包</a></li><li><a href=#安装-istio>安装 istio</a></li><li><a href=#验证-istio>验证 istio</a></li><li><a href=#kiali-组件>Kiali 组件</a></li><li><a href=#istio-profile>Istio Profile</a></li><li><a href=#istio-injection>istio injection</a></li></ul></li><li><a href=#istio-流量管理>Istio 流量管理</a><ul><li><a href=#istio-流量模型>Istio 流量模型</a></li><li><a href=#virtual-service>Virtual Service</a></li><li><a href=#istio-gateway>Istio Gateway</a></li><li><a href=#fault-injection>Fault Injection</a></li><li><a href=#traffic-shifting>Traffic Shifting</a></li><li><a href=#request-timeouts>Request Timeouts</a></li><li><a href=#circuit-breaking>Circuit Breaking</a></li><li><a href=#mirroring>Mirroring</a></li></ul></li><li><a href=#istio-upgrade>Istio Upgrade</a><ul><li><a href=#注意事项>注意事项</a></li><li><a href=#升级步骤>升级步骤</a></li></ul></li><li><a href=#istio-uninstall>Istio UnInstall</a></li></ul></nav></div></div><div class=content id=content><h1 id=istio>Istio</h1><blockquote><p>官方文档 <a href=https://istio.io/zh/docs>https://istio.io/zh/docs</a></p></blockquote><h2 id=istio-是什么衣撕朵>Istio 是什么？(衣撕朵)</h2><ul><li><p>云平台令使用它们的公司受益匪浅。但不可否认的是，上云会给 DevOps 团队带来压力。为了可移植性，开发人员必须使用微服务来构建应用，同时运维人员也正在管理着极端庞大的混合云和多云的部署环境。 Istio 允许您连接、保护、控制和观察服务。</p></li><li><p>从较高的层面来说，Istio 有助于降低这些部署的复杂性，并减轻开发团队的压力。它是一个完全开源的服务网格，作为透明的一层接入到现有的分布式应用程序里。它也是一个平台，拥有可以集成任何日志、遥测和策略系统的 API 接口。Istio 多样化的特性使您能够成功且高效地运行分布式微服务架构，并提供保护、连接和监控微服务的统一方法。</p></li></ul><h2 id=服务网格-又是什么>服务网格 又是什么？</h2><ul><li><code>服务网格</code> - 用来描述组成这些应用程序的微服务网络以及它们之间的交互。随着服务网格的规模和复杂性不断的增长，它将会变得越来越难以理解和管理。它的需求包括服务发现、负载均衡、故障恢复、度量和监控等。服务网格通常还有更复杂的运维需求，比如 A/B 测试、金丝雀发布、速率限制、访问控制和端到端认证。</li></ul><h2 id=istio-架构>Istio 架构</h2><p><img class=lazyload src=/svg/loading.min.svg data-src=https://jicki.cn/img/posts/istio/istio.svg data-srcset="https://jicki.cn/img/posts/istio/istio.svg, https://jicki.cn/img/posts/istio/istio.svg 1.5x, https://jicki.cn/img/posts/istio/istio.svg 2x" data-sizes=auto alt=https://jicki.cn/img/posts/istio/istio.svg title=istio架构></p><ul><li><p>Istio 服务网格从逻辑上分为数据平面和控制平面。</p><ul><li><p><code>数据平面</code>  由一组智能代理（Envoy）组成，被部署为 sidecar。这些代理通过一个通用的策略和遥测中心（Mixer）传递和控制微服务之间的所有网络通信。</p></li><li><p><code>控制平面</code>  管理并配置代理来进行流量路由。此外，控制平面配置 Mixer 来执行策略和收集遥测数据。</p></li></ul></li></ul><h2 id=istio-组件>Istio 组件</h2><h3 id=envoy>Envoy</h3><ul><li><p><code>Istio</code> 使用 <code>Envoy</code> 代理的扩展版本。</p></li><li><p><code>Envoy</code>   是用 <code>C++</code> 开发的高性能代理，用于协调服务网格中所有服务的入站和出站流量。</p></li><li><p><code>Envoy</code> 代理是唯一与数据平面流量交互的 <code>Istio</code> 组件。</p></li><li><p><code>Envoy</code> 代理被部署为服务的 <code>sidecar</code>，在逻辑上为服务增加了 <code>Envoy</code> 的许多内置特性:</p><ol><li>动态服务发现</li><li>负载均衡</li><li>TLS 终端</li><li>HTTP/2 与 gRPC 代理</li><li>熔断器</li><li>健康检查</li><li>基于百分比流量分割的分阶段发布</li><li>故障注入</li><li>丰富的指标</li></ol></li><li><p><code>sidecar</code> 代理模型</p><ul><li><p><code>sidecar</code>   允许 <code>Istio</code> 提取大量关于流量行为的信号作为属性。反之，<code>Istio</code> 可以在 <code>Mixer</code> 中使用这些属性来执行决策，并将它们发送到监控系统，以提供整个网格的行为信息。</p></li><li><p><code>sidecar</code>   还允许您向现有的部署添加 <code>Istio</code> 功能，而不需要重新设计架构或重写代码。</p></li></ul></li><li><p><code>Envoy</code> 代理在 <code>istio</code> 中可以实现</p><ol><li>流量控制功能：  通过丰富的 HTTP、gRPC、WebSocket 和 TCP 流量路由规则来执行细粒度的流量控制。</li><li>网络弹性特性：  重试设置、故障转移、熔断器和故障注入。</li><li>安全性和身份验证特性：  执行安全性策略以及通过配置 API 定义的访问控制和速率限制。</li></ol></li></ul><h3 id=mixer>Mixer</h3><ul><li><p><code>Mixer</code>   是一个平台无关的组件。<code>Mixer</code> 在整个服务网格中执行访问控制和策略使用，并从 <code>Envoy</code> 代理和其他服务收集遥测数据。代理提取请求级别属性，并将其发送到 <code>Mixer</code> 进行评估。您可以在我们的 <code>Mixer</code> 配置文档中找到更多关于属性提取和策略评估的信息。</p></li><li><p><code>Mixer</code>   包括一个灵活的插件模型。该模型使 <code>Istio</code> 能够与各种主机环境和后端基础设施进行交互。因此，<code>Istio</code> 从这些细节中抽象出 <code>Envoy</code> 代理和 <code>Istio</code> 管理的服务。</p></li></ul><h3 id=pilot>Pilot</h3><ul><li><p><code>Pilot</code>   主要是为 <code>Envoy sidecar</code> 提供服务发现、用于智能路由的流量管理功能（例如，A/B 测试、金丝雀发布等）以及弹性功能（超时、重试、熔断器等）。</p></li><li><p><code>Pilot</code>   将控制流量行为的高级路由规则转换为特定于环境的配置，并在运行时将它们传播到 <code>sidecar</code>。</p></li><li><p><code>Pilot</code>   将特定于平台的服务发现机制抽象出来，并将它们合成为任何符合 <code>Envoy API</code> 的 <code>sidecar</code> 都可以使用的标准格式。</p></li><li><p><code>平台适配器</code> 与 <code>Envoy</code> 交互图 (<code>平台</code>   支持 kubernetes、Consul、gcp、Nomad等)</p><ol><li>平台启动一个服务的新实例，该实例通知其平台适配器。</li><li>平台适配器使用 <code>Pilot</code> 抽象模型注册实例。</li><li><code>Pilot</code> 将流量规则和配置派发给 <code>Envoy</code> 代理，来传达此次更改。</li><li>可以使用 <code>Istio</code> 的<code>流量管理 API</code> 通过 <code>Pilot</code> 优化 <code>Envoy</code> 配置，以便对服务网格中的流量进行更细粒度地控制。</li></ol></li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=https://jicki.cn/img/posts/istio/discovery.svg data-srcset="https://jicki.cn/img/posts/istio/discovery.svg, https://jicki.cn/img/posts/istio/discovery.svg 1.5x, https://jicki.cn/img/posts/istio/discovery.svg 2x" data-sizes=auto alt=https://jicki.cn/img/posts/istio/discovery.svg title=discovery></p><h3 id=citadel>Citadel</h3><ul><li><p><code>Citadel</code>   通过内置的身份和证书管理，可以支持强大的服务到服务以及最终用户的身份验证。</p></li><li><p><code>Citadel</code>   可以用来升级服务网格中的未加密流量。</p></li><li><p><code>Citadel</code>、<code>operator</code>   结合使用可以执行基于服务身份的策略，而不是相对不稳定的 3 层或 4 层网络标识。</p></li><li><p><code>Citadel</code>   使用 <code>Istio</code> 的授权特性来控制谁可以访问您的服务。</p></li></ul><h3 id=galley>Galley</h3><ul><li><code>Galley</code>   是 <code>Istio</code> 的配置验证、提取、处理和分发组件。它负责将其余的 <code>Istio</code> 组件与从底层平台（例如 Kubernetes）获取用户配置的细节隔离开来。</li></ul><h2 id=istio-install>Istio Install</h2><blockquote><p>我这里 Kubernetes 版本为1.18 因为我目前只有这么一个集群</p></blockquote><ul><li><p>安装 <code>Istio</code> 环境准备</p><ol><li><p>搭建 <code>Kubernetes</code> 集群, ( 请按照官方提供的兼容测试版本安装 目前支持 1.14, 1.15, 1.16 )</p></li><li><p>下载 <code>Istio</code> 项目包. 项目包内包括(安装文件、示例和 istioctl 命令行工具。)</p></li><li><p>安装 <code>Istio</code>. 通过 <code>istioctl</code> 客户端工具直接安装<code>istio</code> 到 <code>Kubernetes 中</code>.</p></li></ol></li></ul><h3 id=搭建-kubernetes>搭建 Kubernetes</h3><blockquote><p>这一部分这里就省略了, 如需这一部分 文档, 请参考其他的博文。</p></blockquote><h3 id=下载-istio-项目包>下载 Istio 项目包</h3><ul><li>在 <code>macOS</code> 或 <code>Linux</code> 系统中, 也可以通过以下命令下载最新版本的 Istio</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 新建目录
mkdir -p /opt/istio &amp;&amp; cd /opt/istio


# 设置安装版本
export ISTIO_VERSION=1.5.1


# 下载文件
curl -L https://istio.io/downloadIstio | sh -

</code></pre></td></tr></table></div></div><ul><li>输出如下:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>Istio 1.5.1 Download Complete!

Istio has been successfully downloaded into the istio-1.5.1 folder on your system.

Next Steps:
See https://istio.io/docs/setup/kubernetes/install/ to add Istio to your Kubernetes cluster.

To configure the istioctl client tool for your workstation,
add the /opt/istio/istio-1.5.1/bin directory to your environment path variable with:
         export PATH=&#34;$PATH:/opt/istio/istio-1.5.1/bin&#34;

Begin the Istio pre-installation verification check by running:
         istioctl verify-install 

Need more information? Visit https://istio.io/docs/setup/kubernetes/install/ 
</code></pre></td></tr></table></div></div><ul><li>配置环境变量</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>vi /etc/profile

# 添加

# istio
export PATH=&#34;$PATH:/opt/istio/istio-1.5.1/bin&#34;


# 生效配置
source /etc/profile

</code></pre></td></tr></table></div></div><ul><li>验证安装</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>istioctl verify-install

Checking the cluster to make sure it is ready for Istio installation...

#1. Kubernetes-api
-----------------------
Can initialize the Kubernetes client.
Can query the Kubernetes API Server.

#2. Kubernetes-version
-----------------------
Istio is compatible with Kubernetes: v1.18.0.

#3. Istio-existence
-----------------------
Istio will be installed in the istio-system namespace.

#4. Kubernetes-setup
-----------------------
Can create necessary Kubernetes configurations: Namespace,ClusterRole,ClusterRoleBinding,CustomResourceDefinition,Role,ServiceAccount,Service,Deployments,ConfigMap. 

#5. SideCar-Injector
-----------------------
This Kubernetes cluster supports automatic sidecar injection. To enable automatic sidecar injection see https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/#deploying-an-app

-----------------------
Install Pre-Check passed! The cluster is ready for Istio installation.

</code></pre></td></tr></table></div></div><ul><li>配置 istioctl 命令自动补全</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>#  创建目录
mkdir -p /usr/share/istio

# 拷贝补全脚本
cp tools/istioctl.bash /usr/share/istio/


# 导入自动补全
source /usr/share/istio/istioctl.bash



# 添加到 bashrc 中
vi ~/.bashrc

# 添加如下:

# istio
source /usr/share/istio/istioctl.bash




# 测试tab补全

[root@k8s-node-1 istio-1.5.1]# istioctl 
analyze          authz            dashboard        experimental     manifest         profile          proxy-status     upgrade          verify-install   
authn            convert-ingress  deregister       kube-inject      operator         proxy-config     register         validate         version  

</code></pre></td></tr></table></div></div><ul><li><p>目录结构说明</p><ul><li><p><code>bin</code>  目录包含 istioctl 的客户端文件。istioctl 工具用于手动注入 Envoy sidecar 代理。</p></li><li><p><code>manifest.yaml</code>  文件的 sha码。</p></li><li><p><code>samples</code>  目录包含 istio 的实例应用程序。</p></li><li><p><code>tools</code>  目录包含 一些脚本</p><ul><li><code>convert_RbacConfig_to_ClusterRbacConfig.sh</code></li><li><code>dump_kubernetes.sh</code></li><li><code>_istioctl</code></li><li><code>istioctl.bash</code>  istio 命令tab自动补全的脚本</li></ul></li><li><p><code>install</code>  目录包含如下目录: (istio除了支持 kubernetes 之外还支持 consul 和 gcp)</p><ul><li><code>consul</code>  目录</li><li><code>gcp</code>  目录</li><li><code>kubernetes</code>  目录包含 <code>kuebrnetes</code> 服务相关的 YAML 文件。</li><li><code>tools</code>   目录</li></ul></li></ul></li></ul><h3 id=安装-istio>安装 istio</h3><ul><li><p><code>istio</code> 包含两种安装方式</p><ol><li><p>通过 istioctl 客户端命令安装 (推荐)</p></li><li><p>通过 helm 进行安装</p></li></ol></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 通过如下命令进行安装 (manifest 是资源清单, profile 指定类型的清单)
istioctl manifest apply --set profile=demo 

</code></pre></td></tr></table></div></div><ul><li>输出如下:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>- Applying manifest for component Base...
✔ Finished applying manifest for component Base.
- Applying manifest for component Pilot...
✔ Finished applying manifest for component Pilot.
- Applying manifest for component EgressGateways...
- Applying manifest for component IngressGateways...
- Applying manifest for component AddonComponents...
✔ Finished applying manifest for component EgressGateways.
✔ Finished applying manifest for component IngressGateways.
✔ Finished applying manifest for component AddonComponents.

✔ Installation complete
</code></pre></td></tr></table></div></div><ul><li><p>查看部署情况</p><ul><li>如果集群运行在一个不支持外部负载均衡器的环境中（例如：minikube），istio-ingressgateway 的 EXTERNAL-IP 将显示为 <code>&lt;pending></code> 状态。请使用服务的 NodePort 或 端口转发来访问网关。</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl get pods -n istio-system
NAME                                   READY   STATUS    RESTARTS   AGE
grafana-5f6f8cbf75-lqnjg               1/1     Running   0          17m
istio-egressgateway-74896c8487-mjlg8   1/1     Running   0          17m
istio-ingressgateway-54d494869-7npql   1/1     Running   0          17m
istio-tracing-9dd6c4f7c-x5kcp          1/1     Running   0          17m
istiod-756bd84654-n2k6m                1/1     Running   0          18m
kiali-869c6894c5-64vmw                 1/1     Running   0          17m
prometheus-c89875c74-rgzdx             2/2     Running   0          17m
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl get svc -n istio-system 
NAME                        TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                                                                                      AGE
grafana                     ClusterIP      10.254.35.48    &lt;none&gt;        3000/TCP                                                                                                                                     158m
istio-egressgateway         ClusterIP      10.254.10.123   &lt;none&gt;        80/TCP,443/TCP,15443/TCP                                                                                                                     158m
istio-ingressgateway        LoadBalancer   10.254.26.46    &lt;pending&gt;     15020:32142/TCP,80:30000/TCP,443:32701/TCP,15029:30413/TCP,15030:30781/TCP,15031:31714/TCP,15032:32419/TCP,31400:30673/TCP,15443:31123/TCP   158m
istio-pilot                 ClusterIP      10.254.54.205   &lt;none&gt;        15010/TCP,15011/TCP,15012/TCP,8080/TCP,15014/TCP,443/TCP                                                                                     158m
istiod                      ClusterIP      10.254.3.7      &lt;none&gt;        15012/TCP,443/TCP                                                                                                                            158m
jaeger-agent                ClusterIP      None            &lt;none&gt;        5775/UDP,6831/UDP,6832/UDP                                                                                                                   158m
jaeger-collector            ClusterIP      10.254.2.80     &lt;none&gt;        14267/TCP,14268/TCP,14250/TCP                                                                                                                158m
jaeger-collector-headless   ClusterIP      None            &lt;none&gt;        14250/TCP                                                                                                                                    158m
jaeger-query                ClusterIP      10.254.61.2     &lt;none&gt;        16686/TCP                                                                                                                                    158m
kiali                       ClusterIP      10.254.7.135    &lt;none&gt;        20001/TCP                                                                                                                                    158m
prometheus                  ClusterIP      10.254.8.200    &lt;none&gt;        9090/TCP                                                                                                                                     158m
tracing                     ClusterIP      10.254.39.104   &lt;none&gt;        80/TCP                                                                                                                                       158m
zipkin                      ClusterIP      10.254.32.230   &lt;none&gt;        9411/TCP                                                                                                                                     158m
</code></pre></td></tr></table></div></div><ul><li><p>组件说明</p><ul><li><code>tracing</code>  全链路监控。</li><li><code>istio-pilot</code>  服务发现与服务配置。</li><li><code>kiali</code>  可视化服务网格展示。<ul><li>服务拓扑图</li><li>分布式跟踪</li><li>指标度量收集和图标</li><li>配置校验</li><li>健康检查和显示</li><li>服务发现</li></ul></li><li><code>prometheus</code>  大家都懂的监控。</li><li><code>grafana</code>  <code>prometheus</code>监控的展示webui。</li><li><code>istio-ingressgateway</code>  出口网关。</li><li><code>istio-egressgateway</code>  入口网关。</li><li><code>jaeger</code> <ul><li><code>jaeger-agent</code>  jaeger client的一个代理程序，client将收集到的调用链数据发给agent，然后由agent发给collector；</li><li><code>jaeger-collector</code>  负责接收jaeger client或者jaeger agent上报上来的调用链数据，然后做一些校验，比如时间范围是否合法等，最终会经过内部的处理存储到后端存储；</li><li><code>jaeger-query</code>  专门负责调用链查询的一个服务。</li></ul></li></ul></li><li><p>修改 <code>istio-ingressgateway</code> 网络类型 为 NodePort</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl patch service istio-ingressgateway -n istio-system -p &#39;{&#34;spec&#34;:{&#34;type&#34;:&#34;NodePort&#34;}}&#39;

</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl get svc -n istio-system istio-ingressgateway 
NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                                                                                                                                      AGE
istio-ingressgateway   NodePort   10.254.26.46   &lt;none&gt;        15020:32142/TCP,80:30000/TCP,443:32701/TCP,15029:30413/TCP,15030:30781/TCP,15031:31714/TCP,15032:32419/TCP,31400:30673/TCP,15443:31123/TCP   176m
</code></pre></td></tr></table></div></div><h3 id=验证-istio>验证 istio</h3><ul><li>查看版本</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>[root@k8s-node-1 ~]# istioctl version
client version: 1.5.1
control plane version: 1.5.1
data plane version: 1.5.1 (3 proxies)
</code></pre></td></tr></table></div></div><h3 id=kiali-组件>Kiali 组件</h3><blockquote><p>Kiali 以 web ui 的方式可视化服务网格。</p></blockquote><ul><li>查看 kiali svc</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>[root@k8s-node-1 kubeadm]# kubectl get svc -n istio-system  kiali
NAME    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)     AGE
kiali   ClusterIP   10.254.7.135   &lt;none&gt;        20001/TCP   4h24m
</code></pre></td></tr></table></div></div><ul><li>配置访问(我这里的node节点为云主机,所以我配置了一个 ingress)</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>[root@k8s-node-1 ~]# cat kiali-ingress.yaml 
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: kiali-ingress
  namespace: istio-system
spec:
  rules:
  - host: kiali.jicki.cn
    http:
      paths:
      - backend:
          serviceName: kiali
          servicePort: 20001

</code></pre></td></tr></table></div></div><ul><li>创建ingress服务</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>[root@k8s-node-1 kubeadm]# kubectl apply -f kiali-ingress.yaml 
ingress.extensions/kiali-ingress created


# 查看服务
[root@k8s-node-1 ~]# kubectl get ingress -n istio-system 
NAME            CLASS    HOSTS             ADDRESS       PORTS   AGE
kiali-ingress   &lt;none&gt;   kiali.jicki.cn    10.254.8.81   80      2m31s

</code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=https://jicki.cn/img/posts/istio/kiali.png data-srcset="https://jicki.cn/img/posts/istio/kiali.png, https://jicki.cn/img/posts/istio/kiali.png 1.5x, https://jicki.cn/img/posts/istio/kiali.png 2x" data-sizes=auto alt=https://jicki.cn/img/posts/istio/kiali.png title=kiali1></p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://jicki.cn/img/posts/istio/kiali-1.png data-srcset="https://jicki.cn/img/posts/istio/kiali-1.png, https://jicki.cn/img/posts/istio/kiali-1.png 1.5x, https://jicki.cn/img/posts/istio/kiali-1.png 2x" data-sizes=auto alt=https://jicki.cn/img/posts/istio/kiali-1.png title=kiali1></p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://jicki.cn/img/posts/istio/kiali-2.png data-srcset="https://jicki.cn/img/posts/istio/kiali-2.png, https://jicki.cn/img/posts/istio/kiali-2.png 1.5x, https://jicki.cn/img/posts/istio/kiali-2.png 2x" data-sizes=auto alt=https://jicki.cn/img/posts/istio/kiali-2.png title=kiali1></p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://jicki.cn/img/posts/istio/kiali-3.png data-srcset="https://jicki.cn/img/posts/istio/kiali-3.png, https://jicki.cn/img/posts/istio/kiali-3.png 1.5x, https://jicki.cn/img/posts/istio/kiali-3.png 2x" data-sizes=auto alt=https://jicki.cn/img/posts/istio/kiali-3.png title=kiali1></p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://jicki.cn/img/posts/istio/kiali-4.png data-srcset="https://jicki.cn/img/posts/istio/kiali-4.png, https://jicki.cn/img/posts/istio/kiali-4.png 1.5x, https://jicki.cn/img/posts/istio/kiali-4.png 2x" data-sizes=auto alt=https://jicki.cn/img/posts/istio/kiali-4.png title=kiali1></p><h3 id=istio-profile>Istio Profile</h3><blockquote><p>Profile 相关的介绍以及具体的区别</p></blockquote><ul><li><code>istioctl profile list</code> 命令可查看当前版本的 profile</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>[root@k8s-node-1 istio]# istioctl profile list
Istio configuration profiles:
    minimal
    remote
    separate
    default
    demo
    empty

</code></pre></td></tr></table></div></div><ul><li><code>profile</code>  包含如下:<ol><li><code>remote</code> 远程<code>kubernetes</code>部署, 以及多<code>kubernetes</code>集群</li><li><code>separatei</code> 独立部署,不建议使用,后续可能删除</li><li><code>default</code> 默认安装, 根据IstioControlPlaneAPI的默认设置启用组件, 建议用于生产部署</li><li><code>demo</code> 演示实例,展示<code>istio</code> 所有功能且资源需求适中的配置</li><li><code>empty</code> 不部署任何内容。用于导出空的配置文件。</li><li><code>minimal</code> 最小化安装。</li></ol></li></ul><table><thead><tr><th>istio组件</th><th>default</th><th>demo</th><th>minimal</th><th>remote</th><th>empty</th></tr></thead><tbody><tr><td><code>istio-egressgateway</code></td><td></td><td>✔</td><td></td><td></td><td></td></tr><tr><td><code>istio-ingressgateway</code></td><td>✔</td><td>✔</td><td></td><td>✔</td><td></td></tr><tr><td><code>istio-pilot</code></td><td>✔</td><td>✔</td><td>✔</td><td>✔</td><td></td></tr><tr><td><code>grafana</code></td><td></td><td>✔</td><td></td><td></td><td></td></tr><tr><td><code>istio-tracing</code></td><td></td><td>✔</td><td></td><td></td><td></td></tr><tr><td><code>Kiali</code></td><td></td><td>✔</td><td></td><td></td><td></td></tr><tr><td><code>prometheus</code></td><td>✔</td><td>✔</td><td></td><td>✔</td><td></td></tr><tr><td><code>jaeger</code></td><td></td><td>✔</td><td></td><td></td><td></td></tr><tr><td><code>zipkin</code></td><td></td><td>✔</td><td></td><td></td><td></td></tr></tbody></table><ul><li><p><code>istioctl profile dump profileName</code> 可以打印或者导出<code>profile</code>配置</p><ul><li><p>这里导出的文件就是<code>kubernetes</code> 的 YAML 编排文件。api 为 istio 的 api。</p></li><li><p>这里可以导出 <code>default</code> 然后根据自己的环境自定义适合自己的 profile。</p></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>[root@k8s-node-1 istio]# istioctl profile dump default &gt; default.yaml




</code></pre></td></tr></table></div></div><h3 id=istio-injection>istio injection</h3><ul><li><p><code>injection</code> 注入后的变化</p><ul><li><p>原生 pod   &ndash;> <code>pods</code> 包含 <code>程序</code> 项目。</p></li><li><p>注入以后 pod   &ndash;> <code>pods</code> 包含 <code>程序</code> 项目、<code>istio-init</code>、<code>istio-proxy</code>。</p><ul><li><p><code>istio-init</code>  用于初始化网络配置, <code>iptables</code> 路由配置。</p></li><li><p><code>istio-proxy</code>  用于当前<code>pod</code> 与集群内部其他资源进行交互。</p></li></ul></li></ul></li><li><p>可以被 <code>injection</code> 的服务</p><ul><li><p><code>Deployment</code> - 注入后会添加 <code>istio-init</code>、<code>istio-proxy</code> 。</p></li><li><p><code>ReplicaSet</code> - 注入后会添加 <code>istio-init</code>、<code>istio-proxy</code> 。</p></li><li><p><code>DeamonSet</code> - 注入后会添加 <code>istio-init</code>、<code>istio-proxy</code> 。</p></li><li><p><code>Pod</code> - 注入后会添加 <code>istio-init</code>、<code>istio-proxy</code> 。</p></li><li><p><code>Job</code> - 注入后会添加 <code>istio-init</code>、<code>istio-proxy</code> 。</p></li><li><p><code>Service</code> - 注入后不会添加任何组件。</p></li><li><p><code>Secrets</code> - 注入后不会添加任何组件。</p></li><li><p><code>ConfigMap</code> - 注入后不会添加任何组件。</p></li></ul></li><li><p>deployment yaml 编排文件注入</p><ul><li><p><code>istioctl kube-inject -f nginx-test.yaml</code> 对 <code>Deployment</code>编排文件进行注入(会修改yaml文件内容)</p></li><li><p><code>kubectl apply -f &lt;(istioctl kube-inject -f nginx-test.yaml)</code> 注入并 创建 服务到<code>kubernetes</code>中, 这样操作不会改变原有的编排文件。</p></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 创建一个 namespaces
[root@k8s-node-1 istio]# kubectl create ns jicki
namespace/jicki created
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 创建一个 deployment

[root@k8s-node-1 istio]# cat nginx-test.yaml 
apiVersion: apps/v1
kind: Deployment 
metadata: 
  name: nginx-deployment
  namespace: jicki
  labels:
    app: nginx
spec: 
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template: 
    metadata: 
      labels: 
        app: nginx 
        version: v1.0.0
    spec: 
      containers: 
        - name: nginx 
          image: nginx:alpine 
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 80
              name: http
</code></pre></td></tr></table></div></div><ul><li>导出注入后的编排文件</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>[root@k8s-node-1 istio]# istioctl kube-inject -f nginx-test.yaml &gt; nginx-test-inject.yaml

</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 注入后 yaml 发生变化, 会增加很多istio的配置
# 包含新增的两个容器分别为 istio-proxy 与 istio-init 

        image: docker.io/istio/proxyv2:1.5.1
        imagePullPolicy: IfNotPresent
        name: istio-proxy

        image: docker.io/istio/proxyv2:1.5.1
        imagePullPolicy: IfNotPresent
        name: istio-init

</code></pre></td></tr></table></div></div><ul><li>创建服务</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>[root@k8s-node-1 istio]# kubectl apply -f &lt;(istioctl kube-inject -f nginx-test.yaml)
deployment.apps/nginx-deployment created
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>[root@k8s-node-1 istio]# kubectl describe pods/nginx-deployment-59897745f9-vlvn9 -n jicki


Events:
  Type    Reason     Age        From                 Message
  ----    ------     ----       ----                 -------
  Normal  Scheduled  &lt;unknown&gt;  default-scheduler    Successfully assigned jicki/nginx-deployment-59897745f9-vlvn9 to k8s-node-1
  Normal  Pulled     2m19s      kubelet, k8s-node-1  Container image &#34;docker.io/istio/proxyv2:1.5.1&#34; already present on machine
  Normal  Created    2m19s      kubelet, k8s-node-1  Created container istio-init
  Normal  Started    2m18s      kubelet, k8s-node-1  Started container istio-init
  Normal  Pulled     2m18s      kubelet, k8s-node-1  Container image &#34;nginx:alpine&#34; already present on machine
  Normal  Created    2m18s      kubelet, k8s-node-1  Created container nginx
  Normal  Started    2m17s      kubelet, k8s-node-1  Started container nginx
  Normal  Pulled     2m17s      kubelet, k8s-node-1  Container image &#34;docker.io/istio/proxyv2:1.5.1&#34; already present on machine
  Normal  Created    2m17s      kubelet, k8s-node-1  Created container istio-proxy
  Normal  Started    2m17s      kubelet, k8s-node-1  Started container istio-proxy
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 查看 istio 对外服务的端口以及相关进程
# 可以发现除了80端口还有其他5个额外的端口

[root@k8s-node-1 istio]# kubectl exec -it nginx-deployment-59897745f9-vlvn9 -n jicki -c istio-proxy -- netstat -ntlp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:15001           0.0.0.0:*               LISTEN      17/envoy            
tcp        0      0 0.0.0.0:15006           0.0.0.0:*               LISTEN      17/envoy            
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:15090           0.0.0.0:*               LISTEN      17/envoy            
tcp        0      0 127.0.0.1:15000         0.0.0.0:*               LISTEN      17/envoy            
tcp6       0      0 :::15020                :::*                    LISTEN      1/pilot-agent 


</code></pre></td></tr></table></div></div><table><thead><tr><th>Address</th><th>端口</th><th>类型</th><th>进程</th><th>说明</th></tr></thead><tbody><tr><td>127.0.0.1</td><td>15000</td><td>TCP</td><td>envoy</td><td>envoy 命令行管理端口,可以获取程序运行信息。</td></tr><tr><td>0.0.0.0</td><td>15001</td><td>TCP</td><td>envoy</td><td></td></tr><tr><td>0.0.0.0</td><td>15006</td><td>TCP</td><td>envoy</td><td></td></tr><tr><td>0.0.0.0</td><td>15020</td><td>HTTP</td><td>pilot-agent</td><td></td></tr><tr><td>0.0.0.0</td><td>15090</td><td>HTTP</td><td>envoy</td><td></td></tr></tbody></table><p><img class=lazyload src=/svg/loading.min.svg data-src=https://jicki.cn/img/posts/istio/istio-proxy.png data-srcset="https://jicki.cn/img/posts/istio/istio-proxy.png, https://jicki.cn/img/posts/istio/istio-proxy.png 1.5x, https://jicki.cn/img/posts/istio/istio-proxy.png 2x" data-sizes=auto alt=https://jicki.cn/img/posts/istio/istio-proxy.png title=istio-proxy></p><ul><li><p><code>pilot-agent</code></p><ul><li>生成 <code>envoy</code> 配置文件</li><li>启动 <code>envoy</code> 进程</li><li>监控和管理<code>envoy</code>进程的运行状态, 故障恢复, <code>envoy</code>配置变更以及重新加载。</li></ul></li><li><p><code>envoy</code>   轻量级的代理服务器。</p></li><li><p>service yaml 编排文件注入</p><ul><li>上面已经提到过 <code>service</code> 注入是不会添加任何其他的服务到 <code>service</code> 中的。</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 创建一个基于 nginx 的 svc
[root@k8s-node-1 istio]# cat nginx-test-svc.yaml 
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
  namespace: jicki
  labels:
    app: nginx
spec:
  ports:
    - port: 80
      name: http
      targetPort: 80
      protocol: TCP
  selector:
    app: nginx
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 创建服务
[root@k8s-node-1 istio]# kubectl apply -f &lt;(istioctl kube-inject -f nginx-test-svc.yaml)
service/nginx-svc created

</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 输出一个注入后的文件
[root@k8s-node-1 istio]# istioctl kube-inject -f nginx-test-svc.yaml -o nginx-test-svc-inject.yaml 

</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 查看文件 (可以看出来在注入后文件是没有变化的)
[root@k8s-node-1 kubeadm]# cat nginx-test-svc-inject.yaml 
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
  namespace: jicki
  labels:
    app: nginx
spec:
  ports:
    - port: 80
      name: http
      targetPort: 80
      protocol: TCP
  selector:
    app: nginx
---
</code></pre></td></tr></table></div></div><ul><li><p><code>injection</code> 注入检测 (istioctl analyze -n namespace 命令)</p><ul><li><p>运行此命令会检测 <code>namespace</code> 是否有 <code>istio</code> 的资源配置情况。</p></li><li><p>如下提示 <code>default</code> 命令中间下,并没有 注入 <code>istio</code>，以及使用 <code>kubectl label</code> 标签进行注入。</p></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>[root@k8s-node-1 ~]# istioctl analyze -n jicki

Warn [IST0102] (Namespace jicki) The namespace is not enabled for Istio injection. Run &#39;kubectl label namespace jicki istio-injection=enabled&#39; to enable it, or &#39;kubectl label namespace jicki istio-injection=disabled&#39; to explicitly mark it as not needing injection
Error: Analyzers found issues when analyzing namespace: jicki.
See https://istio.io/docs/reference/config/analysis for more information about causes and resolutions.


</code></pre></td></tr></table></div></div><ul><li><p><code>injection</code> 自动注入</p><ul><li>对 <code>namespces</code> 设置 <code>labels</code> 标签, 可以使在这个 <code>namespaces</code> 生成的可注入的程序进行自动注入(<code>injection</code>)</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 创建一个 namespaces
[root@k8s-node-1 ~]# kubectl create namespace jicki
namespace/jicki created

# 注入
[root@k8s-node-1 ~]# kubectl label namespace jicki istio-injection=enabled
namespace/jicki labeled

</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>v1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>Namespace<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>jicki<span class=w>
</span><span class=w>  </span><span class=k>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>istio-injection</span><span class=p>:</span><span class=w> </span>enabled<span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 检测注入情况
[root@k8s-node-1 ~]# istioctl analyze -n jicki
✔ No validation issues found when analyzing namespace: jicki.


# 查看 namespace 的 labels
[root@k8s-node-1 ~]# kubectl get ns --show-labels
NAME              STATUS   AGE     LABELS
default           Active   9d      &lt;none&gt;
jicki             Active   4m46s   istio-injection=enabled

</code></pre></td></tr></table></div></div><h2 id=istio-流量管理>Istio 流量管理</h2><blockquote><p>Istio 的流量管理 就是配置 HTTP/TCP 路由功能。</p></blockquote><blockquote><p>Update Istio Version 1.9.9</p></blockquote><ul><li><p><code>Istio</code> 流量</p><ol><li><p><code>data plane 数据面流量</code>   是指 网格内服务之间业务互相调用所产生的流量。</p></li><li><p><code>control plane 控制面流量</code>   是指 <code>Istio</code> 各组件之间配置和控制网格行为所产生的流量。</p></li></ol></li><li><p><code>Istio</code> 流量管理分为六个部分</p><ol><li><p><code>Destination Rule</code></p></li><li><p><code>Envoy Filter</code></p></li><li><p><code>Gateway</code></p></li><li><p><code>Service Entry</code></p></li><li><p><code>Sidecar</code></p></li><li><p><code>Virtual Service</code></p></li></ol></li></ul><h3 id=istio-流量模型>Istio 流量模型</h3><ul><li><p><code>Istio</code> 依赖与服务注入(inject)时所部署的 <code>Envoy</code> 代理。</p></li><li><p>网格内发送与接收的所有的流量, 都通过 <code>Envoy</code> 进行代理。</p></li><li><p><code>Envoy</code>代理 可以轻松的引导和控制网格的流量, 而不需要对服务进行任何修改。</p></li></ul><h3 id=virtual-service>Virtual Service</h3><ul><li><p>在<code>Istio</code>所提供的基本连接和发现基础上, 通过虚拟服务(vitrual service), 能够将请求路由到<code>Istio</code>网格中的特定服务。每个虚拟服务(vitrual service)由一组路由规则组成, 这些路由规则使<code>Istio</code>能够将虚拟服务(vitrual service)的每个给定请求匹配到网格内特定的目标地址。</p></li><li><p><code>虚拟服务(Virtual Service)</code>  定义了一组寻址主机时要使用的流量路由规则，每个路由规则为特定协议的流量定义匹配了条件。如果流量匹配，则将其发送到注册表中定义的命名目标服务（或其子集/版本）。同时流量来源也可以在路由规则中匹配，从而能够允许针对特定的客户端上下文自定义路由。</p><ul><li><p><code>服务（Service）</code>:   应用绑定到服务注册表中的唯一名称。服务包含多个网络端点，这些端点由在Pod、容器和VM等上运行的工作负载实例进行实现。</p></li><li><p><code>服务版本（Service versions）</code>或<code>子集</code>:  在持续部署的场景中，对于给定的服务，可能存在不同的应用程序实例。它们可能是对同一服务的迭代更改，这些版本部署在不同的环境（产品，阶段和开发等）中。场景包括<code>A / B测试</code> 和 <code>金丝雀发布</code> 等。可以根据各种标准（标头，网址等）和/或通过分配给每个版本的权重来确定特定版本的选择。每个服务都有一个包含其所有实例的默认版本。</p></li><li><p><code>来源（Source）</code>:  调用服务的下游客户端。</p></li><li><p><code>主机（Host）</code>:  下游客户端连接服务时所使用的地址。</p></li><li><p><code>访问模式（Access model）</code>:  应用程序仅需要处理目标服务（主机），而无需了解各个服务版本（子集）。版本的实际选择由代理/sidecar决定，从而使应用程序代码能够与所依赖服务的脱钩。</p></li></ul></li><li><p>一个例子</p><ul><li><code>注</code>:  所有服务(deployment)、(service)、包括 client 都必须被 <code>istio</code> 注入(injection)。</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 2 个 nginx deployment 3 个 service

[root@k8s-node-1 istio]# cat nginx-test.yaml 
apiVersion: apps/v1
kind: Deployment 
metadata: 
  name: nginx-1
  labels:
    web: nginx-1
spec: 
  replicas: 1
  selector:
    matchLabels:
      web: nginx-1
  template: 
    metadata: 
      labels: 
        app: nginx 
        web: nginx-1
        version: v1.0.0
    spec: 
      containers: 
        - name: nginx 
          image: nginx:alpine 
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 80
              name: http
          command: [&#34;/bin/sh&#34;, &#34;-c&#34;, &#34;echo &#39;hello nginx-1&#39; &gt; /usr/share/nginx/html/index.html; nginx  -g  &#39;daemon off;&#39;&#34;]
---
apiVersion: apps/v1
kind: Deployment 
metadata: 
  name: nginx-2
  labels:
    web: nginx-2
spec: 
  replicas: 1
  selector:
    matchLabels:
      web: nginx-2
  template: 
    metadata: 
      labels: 
        app: nginx 
        web: nginx-2
        version: v1.0.1
    spec: 
      containers: 
        - name: nginx 
          image: nginx:alpine 
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 80
              name: http
          command: [&#34;/bin/sh&#34;, &#34;-c&#34;, &#34;echo &#39;hello nginx-2&#39; &gt; /usr/share/nginx/html/index.html; nginx  -g  &#39;daemon off;&#39;&#34;]
---
apiVersion: apps/v1
kind: Deployment 
metadata: 
  name: nginx-3
  labels:
    web: nginx-3
spec: 
  replicas: 1
  selector:
    matchLabels:
      web: nginx-3
  template: 
    metadata: 
      labels: 
        app: nginx
        web: nginx-3
        version: v1.0.2
    spec: 
      containers: 
        - name: nginx 
          image: nginx:alpine 
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 80
              name: http
          command: [&#34;/bin/sh&#34;, &#34;-c&#34;, &#34;echo &#39;hello jicki&#39; &gt; /usr/share/nginx/html/index.html; nginx  -g  &#39;daemon off;&#39;&#34;]
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc-1
  labels:
    web: nginx-1
spec:
  ports:
    - port: 80
      name: http
      targetPort: 80
      protocol: TCP
  selector:
    web: nginx-1
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc-2
  labels:
    web: nginx-2
spec:
  ports:
    - port: 80
      name: http
      targetPort: 80
      protocol: TCP
  selector:
    web: nginx-2
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc-3
  labels:
    web: nginx-3
spec:
  ports:
    - port: 80
      name: http
      targetPort: 80
      protocol: TCP
  selector:
    web: nginx-3
---
apiVersion: v1 
kind: Service
metadata: 
  name: nginx-svc 
  labels:
    app: nginx
spec: 
  ports: 
    - port: 80
      name: http
      targetPort: 80
      protocol: TCP 
  selector: 
    app: nginx
</code></pre></td></tr></table></div></div><ul><li>查看配置的三个 <code>service</code> 的 <code>endpoints</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>[root@k8s-node-1 istio]# kubectl get ep
NAME          ENDPOINTS                                            AGE
kubernetes    172.18.186.159:6443                                  16d
nginx-svc     10.254.64.163:80,10.254.64.164:80,10.254.64.165:80   6m23s
nginx-svc-1   10.254.64.163:80                                     26s
nginx-svc-2   10.254.64.164:80                                     26s
nginx-svc-3   10.254.64.165:80                                     26s
</code></pre></td></tr></table></div></div><ul><li>配置一个 <code>Virtual Service</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=p>[</span>root@k8s-node<span class=m>-1</span><span class=w> </span>istio<span class=p>]</span><span class=c># cat nginx-test-vs.yaml </span><span class=w>
</span><span class=w></span><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1beta1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>VirtualService<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>nginx-svc-vs<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># 客户端访问服务的地址, ( svc名称 + namespace 用于跨 namespace 调用 )</span><span class=w>
</span><span class=w>  </span><span class=k>hosts</span><span class=p>:</span><span class=w> 
</span><span class=w>  </span>- nginx-svc.default<span class=w>
</span><span class=w>  </span><span class=c># http协议</span><span class=w>
</span><span class=w>  </span><span class=k>http</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># 如下为匹配条件</span><span class=w>
</span><span class=w>  </span>- <span class=k>match</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=c># http 头 包含如下信息</span><span class=w>
</span><span class=w>    </span>- <span class=k>headers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=c># key = vs-user</span><span class=w>
</span><span class=w>        </span><span class=k>vs-user</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=c># exact 完全匹配 value = jicki</span><span class=w>
</span><span class=w>          </span><span class=k>exact</span><span class=p>:</span><span class=w> </span>jicki<span class=w>
</span><span class=w>    </span><span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=m>-3.</span>default<span class=w>
</span><span class=w>  </span><span class=c># 如下为匹配路由规则</span><span class=w>
</span><span class=w>  </span>- <span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=c># 匹配的服务版本或子集为 nginx-1</span><span class=w>
</span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=m>-1.</span>default<span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=c># 匹配的服务版本或子集为 nginx-2</span><span class=w>
</span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=m>-2.</span>default<span class=w>
</span><span class=w>
</span></code></pre></td></tr></table></div></div><ul><li><p><code>VirtualService</code> 服务并非是 <code>kubernetes</code> 中实际的 <code>service</code> 服务。</p><ul><li><code>kubectl get virtualservices</code> 使用这个命令查看 <code>Virtual Service</code></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>[root@k8s-node-1 istio]# kubectl get virtualservices
NAME           GATEWAYS   HOSTS                                   AGE
nginx-svc-vs              [nginx-svc.default.svc.cluster.local]   3m1s

</code></pre></td></tr></table></div></div><ul><li>测试以及 kiali 中查看</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=c># 创建一个 busybox 的 deployment 作为客户端</span><span class=w>
</span><span class=w></span><span class=p>[</span>root@k8s-node<span class=m>-1</span><span class=w> </span>istio<span class=p>]</span><span class=c># cat busybox.yaml </span><span class=w>
</span><span class=w></span><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>apps/v1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>Deployment<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>busybox<span class=w>
</span><span class=w>  </span><span class=k>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>app</span><span class=p>:</span><span class=w> </span>busybox<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=k>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>app</span><span class=p>:</span><span class=w> </span>busybox<span class=w>
</span><span class=w>  </span><span class=k>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>app</span><span class=p>:</span><span class=w> </span>busybox<span class=w>
</span><span class=w>    </span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>containers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>busybox<span class=w>
</span><span class=w>          </span><span class=k>image</span><span class=p>:</span><span class=w> </span>jicki/busybox-curl<span class=w>
</span><span class=w>          </span><span class=k>imagePullPolicy</span><span class=p>:</span><span class=w> </span>IfNotPresent<span class=w>
</span><span class=w>          </span><span class=k>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;sleep 3600s&#34;</span><span class=p>]</span><span class=w>
</span></code></pre></td></tr></table></div></div><ul><li>客户端 <code>istio</code> 注入</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl apply -f &lt;(istioctl kube-inject -f busybox.yaml)

</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 访问一下 nginx-svc
[root@k8s-node-1 istio]# kubectl exec -it busybox-7f6578cb8b-qfptk -c busybox -- sh
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 带 headers 的访问

curl --header &#34;vs-user: jicki&#34; http://nginx-svc


hello jicki

</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 模拟流量

while true;
do
wget -q -O - http://nginx-svc;
done

</code></pre></td></tr></table></div></div><ul><li>查看 kiali</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 通过 istioctl 打开 kiali</span> 

istioctl dashboard kiali
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=https://jicki.cn/img/posts/istio/virtualservice.png data-srcset="https://jicki.cn/img/posts/istio/virtualservice.png, https://jicki.cn/img/posts/istio/virtualservice.png 1.5x, https://jicki.cn/img/posts/istio/virtualservice.png 2x" data-sizes=auto alt=https://jicki.cn/img/posts/istio/virtualservice.png title=virutalservice></p><h3 id=istio-gateway>Istio Gateway</h3><ul><li>创建 一个基于 Nginx Web 服务的 <code>Istio Gateway</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1beta1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>Gateway<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>nginx-gateway<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>istio</span><span class=p>:</span><span class=w> </span>ingressgateway<span class=w> </span><span class=c># use istio default controller</span><span class=w>
</span><span class=w>  </span><span class=k>servers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=k>port</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>      </span><span class=k>name</span><span class=p>:</span><span class=w> </span>http<span class=w>
</span><span class=w>      </span><span class=k>protocol</span><span class=p>:</span><span class=w> </span>HTTP<span class=w>
</span><span class=w>    </span><span class=k>hosts</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=s2>&#34;*&#34;</span><span class=w>
</span><span class=w></span>---<span class=w>
</span><span class=w></span><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1beta1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>VirtualService<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>nginx-gw-vs<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>hosts</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># 不绑定 域名 可使用 *</span><span class=w>
</span><span class=w>  </span>- <span class=s2>&#34;*&#34;</span><span class=w>
</span><span class=w>  </span><span class=k>gateways</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- nginx-gateway<span class=w>
</span><span class=w>  </span><span class=k>http</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=w>
</span><span class=w>        </span><span class=k>port</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=k>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></code></pre></td></tr></table></div></div><hr><ul><li><p>配置 <code>DestinationRule</code></p><ul><li><p>目标规则: <code>https://istio.io/latest/zh/docs/reference/config/networking/destination-rule/</code></p></li><li><p>通过 <code>svc labels</code> 选择访问</p></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1beta1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>DestinationRule<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>nginx-destinationrule<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=w>
</span><span class=w>  </span><span class=k>subsets</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>nginx<span class=m>-1</span><span class=w>
</span><span class=w>    </span><span class=k>labels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>web</span><span class=p>:</span><span class=w> </span>nginx<span class=m>-1</span><span class=w>
</span><span class=w>  </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>nginx<span class=m>-2</span><span class=w>
</span><span class=w>    </span><span class=k>labels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>web</span><span class=p>:</span><span class=w> </span>nginx<span class=m>-2</span><span class=w>
</span><span class=w>  </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>nginx<span class=m>-3</span><span class=w>
</span><span class=w>    </span><span class=k>labels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>web</span><span class=p>:</span><span class=w> </span>nginx<span class=m>-3</span><span class=w>
</span><span class=w></span>---<span class=w>
</span><span class=w></span><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1beta1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>VirtualService<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>nginx-gw-vs<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>hosts</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=s2>&#34;*&#34;</span><span class=w>
</span><span class=w>  </span><span class=k>gateways</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- nginx-gateway<span class=w>
</span><span class=w>  </span><span class=k>http</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=w>
</span><span class=w>        </span><span class=k>port</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=k>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>        </span><span class=k>subset</span><span class=p>:</span><span class=w> </span>nginx<span class=m>-3</span><span class=w>
</span></code></pre></td></tr></table></div></div><hr><ul><li><p>基于 TLS 的 Gateway</p><ul><li>创建一个 自签 的tls证书</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 使用 openssl 创建 根证书 与 私钥  (jicki.cn)</span>
openssl req -x509 -sha256 -nodes -days <span class=m>365</span> -newkey rsa:2048 -subj <span class=s1>&#39;/O=jicki Inc./CN=jicki.cn&#39;</span> -keyout jicki.cn.key -out jicki.cn.crt

Generating a RSA private key
............+++++
.....+++++
writing new private key to <span class=s1>&#39;jicki.cn.key&#39;</span>
-----

<span class=c1># 输出证书</span>

total <span class=m>8</span>
-rw-r--r-- <span class=m>1</span> root root <span class=m>1168</span> Oct <span class=m>28</span> 06:12 jicki.cn.crt
-rw------- <span class=m>1</span> root root <span class=m>1704</span> Oct <span class=m>28</span> 06:12 jicki.cn.key
</code></pre></td></tr></table></div></div><ul><li>利用 根证书与密钥 创建 <code>nginx.jicki.cn</code> 证书与私钥</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>openssl req -out nginx.jicki.cn.csr -newkey rsa:2048 -nodes -keyout nginx.jicki.cn.key -subj <span class=s2>&#34;/CN=nginx.jicki.cn/O=nginx organization&#34;</span>


Generating a RSA private key
.......................................................................................+++++
........+++++
writing new private key to <span class=s1>&#39;nginx.jicki.cn.key&#39;</span>
-----


<span class=c1># 创建 crt 证书</span>

openssl x509 -req -days <span class=m>365</span> -CA jicki.cn.crt -CAkey jicki.cn.key -set_serial <span class=m>0</span> -in nginx.jicki.cn.csr -out nginx.jicki.cn.crt



Signature ok
<span class=nv>subject</span><span class=o>=</span><span class=nv>CN</span> <span class=o>=</span> nginx.jicki.cn, <span class=nv>O</span> <span class=o>=</span> nginx organization
Getting CA Private Key


<span class=c1># 输出证书</span>

total <span class=m>20</span>
-rw-r--r-- <span class=m>1</span> root root <span class=m>1038</span> Oct <span class=m>28</span> 06:15 nginx.jicki.cn.crt
-rw-r--r-- <span class=m>1</span> root root  <span class=m>936</span> Oct <span class=m>28</span> 06:14 nginx.jicki.cn.csr
-rw------- <span class=m>1</span> root root <span class=m>1704</span> Oct <span class=m>28</span> 06:14 nginx.jicki.cn.key
-rw-r--r-- <span class=m>1</span> root root <span class=m>1168</span> Oct <span class=m>28</span> 06:12 jicki.cn.crt
-rw------- <span class=m>1</span> root root <span class=m>1704</span> Oct <span class=m>28</span> 06:12 jicki.cn.key
</code></pre></td></tr></table></div></div><hr><ul><li><p>创建 Gateway 中使用到的 <code>Secret</code></p><ul><li>需要将 Secret 创建于 <code>istio-system</code> 这个 namespaces 下.</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl create -n istio-system secret tls nginx-tls --key<span class=o>=</span>nginx.jicki.cn.key --cert<span class=o>=</span>nginx.jicki.cn.crt

</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl -n istio-system get secrets


NAME                                               TYPE                                  DATA   AGE
default-token-pvqnh                                kubernetes.io/service-account-token   <span class=m>3</span>      14d
istio-ca-secret                                    istio.io/ca-root                      <span class=m>5</span>      14d
istio-ingressgateway-service-account-token-jbnvz   kubernetes.io/service-account-token   <span class=m>3</span>      14d
istio-reader-service-account-token-2kwcl           kubernetes.io/service-account-token   <span class=m>3</span>      14d
istiod-service-account-token-n59qq                 kubernetes.io/service-account-token   <span class=m>3</span>      14d
kiali-token-fhwkl                                  kubernetes.io/service-account-token   <span class=m>3</span>      14d
nginx-tls                                          kubernetes.io/tls                     <span class=m>2</span>      8s
</code></pre></td></tr></table></div></div><hr><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1beta1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>Gateway<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>nginx-gateway<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>istio</span><span class=p>:</span><span class=w> </span>ingressgateway<span class=w> </span><span class=c># use istio default controller</span><span class=w>
</span><span class=w>  </span><span class=k>servers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># 每定义一个 hosts 需要多写一个 -port 段落</span><span class=w>
</span><span class=w>  </span>- <span class=k>port</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>number</span><span class=p>:</span><span class=w> </span><span class=m>443</span><span class=w>
</span><span class=w>      </span><span class=k>name</span><span class=p>:</span><span class=w> </span>https<span class=w>
</span><span class=w>      </span><span class=k>protocol</span><span class=p>:</span><span class=w> </span>HTTPS<span class=w>
</span><span class=w>    </span><span class=k>tls</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=c># 单向 TLS 的模式名称为固定值 SIMPLE  双向 TLS 的模式名称为固定值 MUTUAL</span><span class=w>
</span><span class=w>      </span><span class=k>mode</span><span class=p>:</span><span class=w> </span>SIMPLE<span class=w>
</span><span class=w>      </span><span class=k>credentialName</span><span class=p>:</span><span class=w> </span>nginx-tls<span class=w>  </span><span class=c># 上面创建的 证书 secret 名称</span><span class=w>
</span><span class=w>    </span><span class=k>hosts</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=s2>&#34;nginx.jicki.cn&#34;</span><span class=w>
</span><span class=w></span>---<span class=w>
</span><span class=w></span><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1beta1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>VirtualService<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>nginx-gw-vs<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>hosts</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># 不绑定 域名 可使用 *</span><span class=w>
</span><span class=w>  </span>- <span class=s2>&#34;nginx.jicki.cn&#34;</span><span class=w>
</span><span class=w>  </span><span class=k>gateways</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- nginx-gateway<span class=w>
</span><span class=w>  </span><span class=k>http</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=w>
</span><span class=w>        </span><span class=k>port</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=k>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></code></pre></td></tr></table></div></div><ul><li>测试访问</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>curl -v https://nginx.jicki.cn/ --cacert jicki.cn.crt


*   Trying 10.9.9.216:443...
* TCP_NODELAY <span class=nb>set</span>
* Connected to nginx.jicki.cn <span class=o>(</span>10.9.9.216<span class=o>)</span> port <span class=m>443</span> <span class=o>(</span><span class=c1>#0)</span>
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully <span class=nb>set</span> certificate verify locations:
*   CAfile: jicki.cn.crt
  CApath: /etc/ssl/certs
* TLSv1.3 <span class=o>(</span>OUT<span class=o>)</span>, TLS handshake, Client hello <span class=o>(</span>1<span class=o>)</span>:
* TLSv1.3 <span class=o>(</span>IN<span class=o>)</span>, TLS handshake, Server hello <span class=o>(</span>2<span class=o>)</span>:
* TLSv1.3 <span class=o>(</span>IN<span class=o>)</span>, TLS handshake, Encrypted Extensions <span class=o>(</span>8<span class=o>)</span>:
* TLSv1.3 <span class=o>(</span>IN<span class=o>)</span>, TLS handshake, Certificate <span class=o>(</span>11<span class=o>)</span>:
* TLSv1.3 <span class=o>(</span>IN<span class=o>)</span>, TLS handshake, CERT verify <span class=o>(</span>15<span class=o>)</span>:
* TLSv1.3 <span class=o>(</span>IN<span class=o>)</span>, TLS handshake, Finished <span class=o>(</span>20<span class=o>)</span>:
* TLSv1.3 <span class=o>(</span>OUT<span class=o>)</span>, TLS change cipher, Change cipher spec <span class=o>(</span>1<span class=o>)</span>:
* TLSv1.3 <span class=o>(</span>OUT<span class=o>)</span>, TLS handshake, Finished <span class=o>(</span>20<span class=o>)</span>:
* SSL connection using TLSv1.3 / TLS_CHACHA20_POLY1305_SHA256
* ALPN, server accepted to use h2
* Server certificate:
*  subject: <span class=nv>CN</span><span class=o>=</span>nginx.jicki.cn<span class=p>;</span> <span class=nv>O</span><span class=o>=</span>nginx organization
*  start date: Oct <span class=m>28</span> 06:15:47 <span class=m>2021</span> GMT
*  expire date: Oct <span class=m>28</span> 06:15:47 <span class=m>2022</span> GMT
*  common name: nginx.jicki.cn <span class=o>(</span>matched<span class=o>)</span>
*  issuer: <span class=nv>O</span><span class=o>=</span>jicki Inc.<span class=p>;</span> <span class=nv>CN</span><span class=o>=</span>jicki.cn
*  SSL certificate verify ok.
* Using HTTP2, server supports multi-use
* Connection state changed <span class=o>(</span>HTTP/2 confirmed<span class=o>)</span>
* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: <span class=nv>len</span><span class=o>=</span><span class=m>0</span>
* Using Stream ID: <span class=m>1</span> <span class=o>(</span>easy handle 0x55d575b42e10<span class=o>)</span>
&gt; GET / HTTP/2
&gt; Host: nginx.jicki.cn
&gt; user-agent: curl/7.68.0
&gt; accept: */*
&gt; 
* TLSv1.3 <span class=o>(</span>IN<span class=o>)</span>, TLS handshake, Newsession Ticket <span class=o>(</span>4<span class=o>)</span>:
* TLSv1.3 <span class=o>(</span>IN<span class=o>)</span>, TLS handshake, Newsession Ticket <span class=o>(</span>4<span class=o>)</span>:
* old SSL session ID is stale, removing
* Connection state changed <span class=o>(</span><span class=nv>MAX_CONCURRENT_STREAMS</span> <span class=o>==</span> 2147483647<span class=o>)</span>!
&lt; HTTP/2 <span class=m>200</span> 
&lt; server: istio-envoy
&lt; date: Thu, <span class=m>28</span> Oct <span class=m>2021</span> 06:29:55 GMT
&lt; content-type: text/html
&lt; content-length: <span class=m>12</span>
&lt; last-modified: Tue, <span class=m>19</span> Oct <span class=m>2021</span> 02:56:01 GMT
&lt; etag: <span class=s2>&#34;616e33c1-c&#34;</span>
&lt; accept-ranges: bytes
&lt; x-envoy-upstream-service-time: <span class=m>15</span>
&lt; 
hello jicki
* Connection <span class=c1>#0 to host nginx.jicki.cn left intact</span>
</code></pre></td></tr></table></div></div><h3 id=fault-injection>Fault Injection</h3><blockquote><p>故障注入</p></blockquote><ul><li><p>Istio 的故障注入规则可以帮助您识别微服务中有硬编码超时, 导致 服务失败等。此类异常, 而不会影响最终用户。</p></li><li><p>故障注入 - 延迟调用, 在使用条件匹配访问 vs-user 用户等于 jicki 的时候 延迟7s 后调用, 延迟比例为 100%</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=c># 在 内部网格中实现 故障注入</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=p>[</span>root@k8s-node<span class=m>-1</span><span class=w> </span>istio<span class=p>]</span><span class=c># cat nginx-vs.yaml</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1beta1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>VirtualService<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>nginx-svc-vs<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># 客户端访问服务的地址</span><span class=w>
</span><span class=w>  </span><span class=k>hosts</span><span class=p>:</span><span class=w> 
</span><span class=w>  </span>- nginx-svc<span class=w>
</span><span class=w>  </span><span class=c># http协议</span><span class=w>
</span><span class=w>  </span><span class=k>http</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># 如下为 故障注入</span><span class=w>
</span><span class=w>  </span>- <span class=k>fault</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>delay</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=c># 延迟 7秒</span><span class=w>
</span><span class=w>        </span><span class=k>fixedDelay</span><span class=p>:</span><span class=w> </span>7s<span class=w>
</span><span class=w>        </span><span class=c># 延迟比例 100%</span><span class=w>
</span><span class=w>        </span><span class=k>percentage</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=k>value</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span><span class=w>  </span><span class=c># 如下为匹配条件</span><span class=w>
</span><span class=w>    </span><span class=k>match</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=c># http 头 包含如下信息</span><span class=w>
</span><span class=w>    </span>- <span class=k>headers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=c># key = vs-user</span><span class=w>
</span><span class=w>        </span><span class=k>vs-user</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=c># exact 完全匹配 value = jicki</span><span class=w>
</span><span class=w>          </span><span class=k>exact</span><span class=p>:</span><span class=w> </span>jicki<span class=w>
</span><span class=w>    </span><span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=m>-3</span><span class=w>
</span><span class=w>  </span><span class=c># 如下为匹配路由规则</span><span class=w>
</span><span class=w>  </span>- <span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=c># 匹配的服务版本或子集为 nginx-1</span><span class=w>
</span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=m>-1</span><span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=c># 匹配的服务版本或子集为 nginx-2</span><span class=w>
</span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=m>-2</span><span class=w>
</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>time</span> curl --header <span class=s2>&#34;vs-user: jicki&#34;</span> http://nginx-svc


hello jicki
real	0m 7.02s
user	0m 0.00s
sys	0m 0.00s
</code></pre></td></tr></table></div></div><ul><li>在 外部调用 中实现 故障注入</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>
</span><span class=w></span><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1beta1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>VirtualService<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>nginx-gw-vs<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>hosts</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=s2>&#34;*&#34;</span><span class=w>
</span><span class=w>  </span><span class=k>gateways</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- nginx-gateway<span class=w>
</span><span class=w>  </span><span class=k>http</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># 如下为 故障注入</span><span class=w>
</span><span class=w>  </span>- <span class=k>fault</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>delay</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=c># 延迟 7秒</span><span class=w>
</span><span class=w>        </span><span class=k>fixedDelay</span><span class=p>:</span><span class=w> </span>7s<span class=w>
</span><span class=w>        </span><span class=c># 延迟比例 100%</span><span class=w>
</span><span class=w>        </span><span class=k>percentage</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=k>value</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span><span class=w>    </span><span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=w>
</span><span class=w>        </span><span class=k>port</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=k>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>        </span><span class=k>subset</span><span class=p>:</span><span class=w> </span>nginx<span class=m>-3</span><span class=w>
</span></code></pre></td></tr></table></div></div><h3 id=traffic-shifting>Traffic Shifting</h3><blockquote><p>流量转移</p></blockquote><ul><li><p>在项目服务中, 通常会有一些新旧版本的逐步迁移, 如流量从微服务的一个版本的逐渐迁移到另一个版本。流量转移适用于web服务以及TCP服务。</p><ul><li>通过配置 <code>destination.weight</code> 来定义流量的百分比 (只用于网格内的服务)</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1beta1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>VirtualService<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>nginx-svc-vs<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># 客户端访问服务的地址, ( svc名称 + namespace 用于跨 namespace 调用 )</span><span class=w>
</span><span class=w>  </span><span class=k>hosts</span><span class=p>:</span><span class=w> 
</span><span class=w>  </span>- nginx-svc.default<span class=w>
</span><span class=w>  </span><span class=c># http协议</span><span class=w>
</span><span class=w>  </span><span class=k>http</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># 如下为匹配条件</span><span class=w>
</span><span class=w>  </span>- <span class=k>match</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=c># http 头 包含如下信息</span><span class=w>
</span><span class=w>    </span>- <span class=k>headers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=c># key = vs-user</span><span class=w>
</span><span class=w>        </span><span class=k>vs-user</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=c># exact 完全匹配 value = jicki</span><span class=w>
</span><span class=w>          </span><span class=k>exact</span><span class=p>:</span><span class=w> </span>jicki<span class=w>
</span><span class=w>    </span><span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=m>-3.</span>default<span class=w>
</span><span class=w>  </span><span class=c># 如下为匹配路由规则</span><span class=w>
</span><span class=w>  </span>- <span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=c># 匹配的服务版本或子集为 nginx-1</span><span class=w>
</span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=m>-1.</span>default<span class=w>
</span><span class=w>      </span><span class=c># 流量比例</span><span class=w>
</span><span class=w>      </span><span class=k>weight</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=c># 匹配的服务版本或子集为 nginx-2</span><span class=w>
</span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=m>-2.</span>default<span class=w>
</span><span class=w>      </span><span class=c># 流量比例</span><span class=w>
</span><span class=w>      </span><span class=k>weight</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></code></pre></td></tr></table></div></div><h3 id=request-timeouts>Request Timeouts</h3><blockquote><p>请求超时</p></blockquote><ul><li>通过设置 请求超时 来测试服务的一些特性.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1beta1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>VirtualService<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>nginx-gw-vs<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>hosts</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=s2>&#34;*&#34;</span><span class=w>
</span><span class=w>  </span><span class=k>gateways</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- nginx-gateway<span class=w>
</span><span class=w>  </span><span class=k>http</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=w>
</span><span class=w>        </span><span class=k>port</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=k>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>        </span><span class=k>subset</span><span class=p>:</span><span class=w> </span>nginx<span class=m>-3</span><span class=w>
</span><span class=w>    </span><span class=k>timeout</span><span class=p>:</span><span class=w> </span><span class=m>0.</span>01s<span class=w>
</span></code></pre></td></tr></table></div></div><ul><li>Nginx 服务会直接返回 <code>upstream request timeout</code> , 这里不需要修改 Nginx 的配置文件设置超时, 通过 vs 配既可实现。</li></ul><h3 id=circuit-breaking>Circuit Breaking</h3><blockquote><p>熔断</p></blockquote><ul><li><p>熔断, 是创建弹性微服务应用程序的重要模式。熔断能够使您的应用程序具备应对来自故障、潜在峰值和其他未知网络因素影响的能力。</p></li><li><p>通过配置 <code>DestinationRule</code> 中的 <code>trafficPolicy</code> 配置熔断策略</p><ul><li>可以配置<code>tcp</code>与<code>http</code>协议的条件, 如下为最大连接数为<code>1</code>, 超过<code>1</code>的时候就会触发 熔断机制</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1beta1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>DestinationRule<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>nginx-destinationrule<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=w>
</span><span class=w>  </span><span class=k>trafficPolicy</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>connectionPool</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>tcp</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>maxConnections</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=k>http</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>http1MaxPendingRequests</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>        </span><span class=k>maxRequestsPerConnection</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>    </span><span class=k>outlierDetection</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>consecutiveErrors</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=k>interval</span><span class=p>:</span><span class=w> </span>1s<span class=w>
</span><span class=w>      </span><span class=k>baseEjectionTime</span><span class=p>:</span><span class=w> </span>3m<span class=w>
</span><span class=w>      </span><span class=k>maxEjectionPercent</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span></code></pre></td></tr></table></div></div><ul><li>部署一个 <code>fortio</code> 客户端 <a href=https://github.com/fortio/fortio>https://github.com/fortio/fortio</a></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>v1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>Pod<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>fortio<span class=w>
</span><span class=w>  </span><span class=k>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>app</span><span class=p>:</span><span class=w> </span>fortio<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>containers</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>fortio<span class=w>
</span><span class=w>      </span><span class=k>image</span><span class=p>:</span><span class=w> </span>fortio/fortio<span class=w>
</span><span class=w>      </span><span class=k>imagePullPolicy</span><span class=p>:</span><span class=w> </span>IfNotPresent<span class=w>
</span><span class=w>      </span><span class=k>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;server&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;&amp;&#34;</span><span class=p>]</span><span class=w>
</span></code></pre></td></tr></table></div></div><ul><li>触发一下熔断</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>kubectl -n jicki <span class=nb>exec</span> fortio -c fortio -- /usr/bin/fortio load -c <span class=m>2</span> -qps <span class=m>0</span> -n <span class=m>20</span> -loglevel Warning http://nginx-svc/



09:18:17 I logger.go:127&gt; Log level is now <span class=m>3</span> Warning <span class=o>(</span>was <span class=m>2</span> Info<span class=o>)</span>
Fortio 1.17.0 running at <span class=m>0</span> queries per second, 24-&gt;24 procs, <span class=k>for</span> <span class=m>20</span> calls: http://nginx-svc/
Starting at max qps with <span class=m>2</span> thread<span class=o>(</span>s<span class=o>)</span> <span class=o>[</span>gomax 24<span class=o>]</span> <span class=k>for</span> exactly <span class=m>20</span> calls <span class=o>(</span><span class=m>10</span> per thread + 0<span class=o>)</span>
09:18:17 W http_client.go:793&gt; Parsed non ok code <span class=m>503</span> <span class=o>(</span>HTTP/1.1 503<span class=o>)</span>
09:18:17 W http_client.go:793&gt; Parsed non ok code <span class=m>503</span> <span class=o>(</span>HTTP/1.1 503<span class=o>)</span>
09:18:17 W http_client.go:793&gt; Parsed non ok code <span class=m>503</span> <span class=o>(</span>HTTP/1.1 503<span class=o>)</span>
09:18:17 W http_client.go:793&gt; Parsed non ok code <span class=m>503</span> <span class=o>(</span>HTTP/1.1 503<span class=o>)</span>
Ended after 92.685514ms : <span class=m>20</span> calls. <span class=nv>qps</span><span class=o>=</span>215.78
Aggregated Function Time : count <span class=m>20</span> avg 0.0089015828 +/- 0.004691 min 0.001575415 max 0.02210334 sum 0.178031656
<span class=c1># range, mid point, percentile, count</span>
&gt;<span class=o>=</span> 0.00157541 &lt;<span class=o>=</span> 0.002 , 0.00178771 , 5.00, <span class=m>1</span>
&gt; 0.002 &lt;<span class=o>=</span> 0.003 , 0.0025 , 15.00, <span class=m>2</span>
&gt; 0.006 &lt;<span class=o>=</span> 0.007 , 0.0065 , 25.00, <span class=m>2</span>
&gt; 0.007 &lt;<span class=o>=</span> 0.008 , 0.0075 , 45.00, <span class=m>4</span>
&gt; 0.008 &lt;<span class=o>=</span> 0.009 , 0.0085 , 55.00, <span class=m>2</span>
&gt; 0.009 &lt;<span class=o>=</span> 0.01 , 0.0095 , 80.00, <span class=m>5</span>
&gt; 0.011 &lt;<span class=o>=</span> 0.012 , 0.0115 , 85.00, <span class=m>1</span>
&gt; 0.012 &lt;<span class=o>=</span> 0.014 , 0.013 , 90.00, <span class=m>1</span>
&gt; 0.018 &lt;<span class=o>=</span> 0.02 , 0.019 , 95.00, <span class=m>1</span>
&gt; 0.02 &lt;<span class=o>=</span> 0.0221033 , 0.0210517 , 100.00, <span class=m>1</span>
<span class=c1># target 50% 0.0085</span>
<span class=c1># target 75% 0.0098</span>
<span class=c1># target 90% 0.014</span>
<span class=c1># target 99% 0.0216827</span>
<span class=c1># target 99.9% 0.0220613</span>
Sockets used: <span class=m>6</span> <span class=o>(</span><span class=k>for</span> perfect keepalive, would be 2<span class=o>)</span>
Jitter: <span class=nb>false</span>
Code <span class=m>200</span> : <span class=m>16</span> <span class=o>(</span>80.0 %<span class=o>)</span>
Code <span class=m>503</span> : <span class=m>4</span> <span class=o>(</span>20.0 %<span class=o>)</span>
Response Header Sizes : count <span class=m>20</span> avg 190.55 +/- 95.28 min <span class=m>0</span> max <span class=m>239</span> sum <span class=m>3811</span>
Response Body/Total Sizes : count <span class=m>20</span> avg 255.2 +/- 10.03 min <span class=m>250</span> max <span class=m>276</span> sum <span class=m>5104</span>
All <span class=k>done</span> <span class=m>20</span> calls <span class=o>(</span>plus <span class=m>0</span> warmup<span class=o>)</span> 8.902 ms avg, 215.8 qps
</code></pre></td></tr></table></div></div><ul><li>当使用 2个 连接的时候 只会触发 <code>Code 503 : 4 (20.0 %)</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>kubectl -n jicki <span class=nb>exec</span> fortio -c fortio -- /usr/bin/fortio load -c <span class=m>5</span> -qps <span class=m>0</span> -n <span class=m>20</span> -loglevel Warning http://nginx-svc/



09:21:22 I logger.go:127&gt; Log level is now <span class=m>3</span> Warning <span class=o>(</span>was <span class=m>2</span> Info<span class=o>)</span>
Fortio 1.17.0 running at <span class=m>0</span> queries per second, 24-&gt;24 procs, <span class=k>for</span> <span class=m>20</span> calls: http://nginx-svc/
Starting at max qps with <span class=m>5</span> thread<span class=o>(</span>s<span class=o>)</span> <span class=o>[</span>gomax 24<span class=o>]</span> <span class=k>for</span> exactly <span class=m>20</span> calls <span class=o>(</span><span class=m>4</span> per thread + 0<span class=o>)</span>
09:21:23 W http_client.go:793&gt; Parsed non ok code <span class=m>503</span> <span class=o>(</span>HTTP/1.1 503<span class=o>)</span>
09:21:23 W http_client.go:793&gt; Parsed non ok code <span class=m>503</span> <span class=o>(</span>HTTP/1.1 503<span class=o>)</span>
09:21:23 W http_client.go:793&gt; Parsed non ok code <span class=m>503</span> <span class=o>(</span>HTTP/1.1 503<span class=o>)</span>
09:21:23 W http_client.go:793&gt; Parsed non ok code <span class=m>503</span> <span class=o>(</span>HTTP/1.1 503<span class=o>)</span>
09:21:23 W http_client.go:793&gt; Parsed non ok code <span class=m>503</span> <span class=o>(</span>HTTP/1.1 503<span class=o>)</span>
09:21:23 W http_client.go:793&gt; Parsed non ok code <span class=m>503</span> <span class=o>(</span>HTTP/1.1 503<span class=o>)</span>
09:21:23 W http_client.go:793&gt; Parsed non ok code <span class=m>503</span> <span class=o>(</span>HTTP/1.1 503<span class=o>)</span>
09:21:23 W http_client.go:793&gt; Parsed non ok code <span class=m>503</span> <span class=o>(</span>HTTP/1.1 503<span class=o>)</span>
09:21:23 W http_client.go:793&gt; Parsed non ok code <span class=m>503</span> <span class=o>(</span>HTTP/1.1 503<span class=o>)</span>
09:21:23 W http_client.go:793&gt; Parsed non ok code <span class=m>503</span> <span class=o>(</span>HTTP/1.1 503<span class=o>)</span>
09:21:23 W http_client.go:793&gt; Parsed non ok code <span class=m>503</span> <span class=o>(</span>HTTP/1.1 503<span class=o>)</span>
Ended after 64.311585ms : <span class=m>20</span> calls. <span class=nv>qps</span><span class=o>=</span>310.99
Aggregated Function Time : count <span class=m>20</span> avg 0.01221322 +/- 0.007708 min 0.003108022 max 0.026839277 sum 0.244264407
<span class=c1># range, mid point, percentile, count</span>
&gt;<span class=o>=</span> 0.00310802 &lt;<span class=o>=</span> 0.004 , 0.00355401 , 10.00, <span class=m>2</span>
&gt; 0.004 &lt;<span class=o>=</span> 0.005 , 0.0045 , 25.00, <span class=m>3</span>
&gt; 0.005 &lt;<span class=o>=</span> 0.006 , 0.0055 , 35.00, <span class=m>2</span>
&gt; 0.009 &lt;<span class=o>=</span> 0.01 , 0.0095 , 40.00, <span class=m>1</span>
&gt; 0.01 &lt;<span class=o>=</span> 0.011 , 0.0105 , 55.00, <span class=m>3</span>
&gt; 0.011 &lt;<span class=o>=</span> 0.012 , 0.0115 , 60.00, <span class=m>1</span>
&gt; 0.012 &lt;<span class=o>=</span> 0.014 , 0.013 , 70.00, <span class=m>2</span>
&gt; 0.016 &lt;<span class=o>=</span> 0.018 , 0.017 , 80.00, <span class=m>2</span>
&gt; 0.02 &lt;<span class=o>=</span> 0.025 , 0.0225 , 85.00, <span class=m>1</span>
&gt; 0.025 &lt;<span class=o>=</span> 0.0268393 , 0.0259196 , 100.00, <span class=m>3</span>
<span class=c1># target 50% 0.0106667</span>
<span class=c1># target 75% 0.017</span>
<span class=c1># target 90% 0.0256131</span>
<span class=c1># target 99% 0.0267167</span>
<span class=c1># target 99.9% 0.026827</span>
Sockets used: <span class=m>14</span> <span class=o>(</span><span class=k>for</span> perfect keepalive, would be 5<span class=o>)</span>
Jitter: <span class=nb>false</span>
Code <span class=m>200</span> : <span class=m>9</span> <span class=o>(</span>45.0 %<span class=o>)</span>
Code <span class=m>503</span> : <span class=m>11</span> <span class=o>(</span>55.0 %<span class=o>)</span>
Response Header Sizes : count <span class=m>20</span> avg 107.35 +/- 118.7 min <span class=m>0</span> max <span class=m>239</span> sum <span class=m>2147</span>
Response Body/Total Sizes : count <span class=m>20</span> avg 264.15 +/- 12.31 min <span class=m>250</span> max <span class=m>276</span> sum <span class=m>5283</span>
All <span class=k>done</span> <span class=m>20</span> calls <span class=o>(</span>plus <span class=m>0</span> warmup<span class=o>)</span> 12.213 ms avg, 311.0 qps

</code></pre></td></tr></table></div></div><ul><li>配置 5个 连接的时候 <code>Code 503 : 11 (55.0 %)</code></li></ul><h3 id=mirroring>Mirroring</h3><blockquote><p>镜像流量</p></blockquote><ul><li>创建一个 vs 将默认流量都到 <code>nginx-svc-1</code> 中去.</li><li>通过 <code>mirror</code> 标签镜像 <code>nginx-svc-1</code> 的流量 到 <code>nginx-svc-2</code> 中. (mirrorPercent 为镜像流量的百分比)</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.istio.io/v1beta1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>VirtualService<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>nginx-svc-vs<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># 客户端访问服务的地址</span><span class=w>
</span><span class=w>  </span><span class=k>hosts</span><span class=p>:</span><span class=w> 
</span><span class=w>  </span>- nginx-svc<span class=w>
</span><span class=w>  </span><span class=c># http协议</span><span class=w>
</span><span class=w>  </span><span class=k>http</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># 如下为匹配条件</span><span class=w>
</span><span class=w>  </span>- <span class=k>match</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=c># http 头 包含如下信息</span><span class=w>
</span><span class=w>    </span>- <span class=k>headers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=c># key = vs-user</span><span class=w>
</span><span class=w>        </span><span class=k>vs-user</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=c># exact 完全匹配 value = jicki</span><span class=w>
</span><span class=w>          </span><span class=k>exact</span><span class=p>:</span><span class=w> </span>jicki<span class=w>
</span><span class=w>    </span><span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=m>-3</span><span class=w>
</span><span class=w>  </span><span class=c># 如下为匹配路由规则</span><span class=w>
</span><span class=w>  </span>- <span class=k>route</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=c># 匹配的服务版本或子集为 nginx-1</span><span class=w>
</span><span class=w>        </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=m>-1</span><span class=w>
</span><span class=w>      </span><span class=k>weight</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span><span class=w>    </span><span class=k>mirror</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>host</span><span class=p>:</span><span class=w> </span>nginx-svc<span class=m>-2</span><span class=w>
</span><span class=w>    </span><span class=k>mirrorPercent</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span></code></pre></td></tr></table></div></div><ul><li><p>查看 <code>nginx-1</code> 与 <code>nginx-2</code> 的日志 - 可以看出各自的不同.</p><ul><li>重点注意这些被镜像的流量是 <code>即发即弃</code> 的, 就是说镜像请求的响应会被丢弃。</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># nginx-1

127.0.0.1 - - [26/Oct/2021:08:24:20 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;-&#34;
127.0.0.1 - - [26/Oct/2021:08:24:23 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;-&#34;
127.0.0.1 - - [26/Oct/2021:08:24:24 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;-&#34;
127.0.0.1 - - [26/Oct/2021:08:24:25 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;-&#34;
127.0.0.1 - - [26/Oct/2021:08:24:25 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;-&#34;
127.0.0.1 - - [26/Oct/2021:08:24:25 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;-&#34;
127.0.0.1 - - [26/Oct/2021:08:24:26 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;-&#34;
127.0.0.1 - - [26/Oct/2021:08:24:26 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;-&#34;
127.0.0.1 - - [26/Oct/2021:08:24:27 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;-&#34;
127.0.0.1 - - [26/Oct/2021:08:24:27 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;-&#34;
127.0.0.1 - - [26/Oct/2021:08:24:27 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;-&#34;
127.0.0.1 - - [26/Oct/2021:08:24:28 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;-&#34;

</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># nginx-2

127.0.0.1 - - [26/Oct/2021:08:24:20 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;172.18.16.252&#34;
127.0.0.1 - - [26/Oct/2021:08:24:23 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;172.18.16.252&#34;
127.0.0.1 - - [26/Oct/2021:08:24:24 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;172.18.16.252&#34;
127.0.0.1 - - [26/Oct/2021:08:24:25 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;172.18.16.252&#34;
127.0.0.1 - - [26/Oct/2021:08:24:25 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;172.18.16.252&#34;
127.0.0.1 - - [26/Oct/2021:08:24:25 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;172.18.16.252&#34;
127.0.0.1 - - [26/Oct/2021:08:24:26 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;172.18.16.252&#34;
127.0.0.1 - - [26/Oct/2021:08:24:26 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;172.18.16.252&#34;
127.0.0.1 - - [26/Oct/2021:08:24:27 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;172.18.16.252&#34;
127.0.0.1 - - [26/Oct/2021:08:24:27 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;172.18.16.252&#34;
127.0.0.1 - - [26/Oct/2021:08:24:27 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;172.18.16.252&#34;
127.0.0.1 - - [26/Oct/2021:08:24:28 +0000] &#34;GET / HTTP/1.1&#34; 200 14 &#34;-&#34; &#34;curl/7.30.0&#34; &#34;172.18.16.252&#34;

</code></pre></td></tr></table></div></div><h2 id=istio-upgrade>Istio Upgrade</h2><h3 id=注意事项>注意事项</h3><ul><li><p>升级 Istio 之前, 请确认是否支持升级 <code>istioctl manifest versions</code> 查看支持版本。</p></li><li><p>升级过程中可能发生流量中断。为了缩短流量中断时间, 请确保每个组件（Citadel 除外）至少运行有两个副本。同时, 确保 <code>PodDistruptionBudgets</code> 配置最小可用性为 1。</p></li><li><p>确保 istio <code>profile</code> 与 需要升级的版本所配置的 <code>profile</code> 一致。</p></li></ul><h3 id=升级步骤>升级步骤</h3><ul><li><p>1. 下载需要升级的 istio 版本 <code>curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.5.1 sh -</code></p></li><li><p>2. 替换 <code>istioctl</code> 二进制文件, 或者 更改 <code>istio</code> 的环境变量PATH路径到新版本的目录中。</p></li><li><p>3. 如果配置了 <code>istioctl</code> 自动补全,还需要替换为 新的 自动补全脚本。</p></li><li><p>4. 使用新的 <code>istioctl</code> 导出新版本的 profile 文件 <code>istioctl profile dump demo > demo.yaml</code></p></li><li><p>5. 修改 <code>demo.yaml</code> 文件, 将其中 <code>jwtPolicy</code> 身份验证机构修改为 <code>first-party-jwt</code>。Istio 将默认使用第三方令牌。</p><ul><li><p>5.1  验证是否支持 第三方令牌。<code>kubectl get --raw /api/v1 | jq '.resources[] | select(.name | index("serviceaccounts/token"))'</code></p><ul><li><p>5.1.1 jwtPolicy = <code>third-party-jwt</code> 使用第三方令牌 更安全 Istio 默认使用这个选项。</p></li><li><p>5.1.2  jwtPolicy = <code>first-party-jwt</code> 使用第一方令牌 属性比较不安全。</p></li></ul></li></ul></li><li><p>6. <code>istioctl upgrade -f demo.yaml</code> 命令进行升级。</p></li><li><p>7. 观察 <code>kubernets</code> 中 <code>istio-system</code> 的服务更新完成。</p></li><li><p>8. 重新注入环境中部署的服务, 用以更新注入数据。</p><ul><li><p>8.1 对于自动注入的情况可使用如下命令:</p><ul><li><p>8.1.1 <code>kubectl rollout restart deployment</code></p></li><li><p>8.1.2 <code>kubectl rollout restart statefulset</code></p></li><li><p>8.1.3 <code>kubectl rollout restart daemonset</code></p></li></ul></li><li><p>8.2 对于手动注入的情况( 需要重新 apply 一下服务) :</p><ul><li>8.2.1 <code>kubectl apply -f &lt;(istioctl kube-inject -f nginx-test.yaml)</code></li></ul></li></ul></li><li><p>9. 检查升级, 执行 <code>istioctl version</code> 检查</p><ul><li><p>9.1 <code>client version</code> 版本是否为新版本。</p></li><li><p>9.2 <code>control plane version</code> 版本是否为新版本。</p></li><li><p>9.3 <code>data plane version</code> 中是否全部 <code>proxies</code> 都为新版本。</p></li></ul></li></ul><h2 id=istio-uninstall>Istio UnInstall</h2><ul><li>卸载 Istio 的话其实就是讲 <code>kubernetes</code> 所安装到的组件 <code>delete</code> 掉就可以了</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 可以直接运行istioctl 命令加上 kubectl delete 命令组合删除

istioctl manifest generate --set profile=demo |kubectl delete -f -


</code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2021-10-19</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/istio-1.5/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://jicki.cn/istio-1.5/ data-title="Istio 持续更新..." data-via=jicki234 data-hashtags=istio><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://jicki.cn/istio-1.5/ data-hashtag=istio><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://jicki.cn/istio-1.5/ data-title="Istio 持续更新..." data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://jicki.cn/istio-1.5/ data-title="Istio 持续更新..."><i data-svg-src=/lib/simple-icons/icons/line.min.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://jicki.cn/istio-1.5/ data-title="Istio 持续更新..."><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=https://jicki.cn/istio-1.5/ data-title="Istio 持续更新..." data-description="Istio 持续更新..."><i data-svg-src=/lib/simple-icons/icons/myspace.min.svg></i></a><a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://jicki.cn/istio-1.5/ data-title="Istio 持续更新..." data-description="Istio 持续更新..."><i class="fab fa-blogger fa-fw"></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://jicki.cn/istio-1.5/ data-title="Istio 持续更新..."><i class="fab fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/istio/>istio</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/leetcode-100/ class=prev rel=prev title="LeetCode golang 题目"><i class="fas fa-angle-left fa-fw"></i>LeetCode golang 题目</a>
<a href=/horizontal-pod-autoscale/ class=next rel=next title="Kubernetes Horizontal Pod Autoscaler">Kubernetes Horizontal Pod Autoscaler<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>友情链接</div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.73.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://jicki.cn target=_blank>小炒肉</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a href=http://beian.miit.gov.cn target=_blank>粤ICP备20055633号</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":200},"comment":{"valine":{"appId":"1LTTCvDe4Nt8XSdFzejtUsVF-gzGzoHsz","appKey":"cvpPM7sbgOw0pTXbh6YVKrjc","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"zh-cn","pageSize":10,"placeholder":"你的评论 ...","recordIP":true,"visitor":true}},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>